@model SnomiAssignmentReal.Models.ViewModels.ManageCustomersVm
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Manage Customers";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string disabledPoints = Model.UserType?.Equals("registered", StringComparison.OrdinalIgnoreCase) == true ? "" : "disabled";
}

<div class="container py-4">
    <h2 class="mb-3">👥 Manage Customers</h2>

    @if (TempData["Info"] != null)
    {
        <div class="alert alert-success">@TempData["Info"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <!-- Filters (GET) -->
<form method="get" asp-action="ManageCustomers" asp-controller="Admin" class="filter-card mb-3">
    <input type="hidden" name="page" value="1" /> @* reset to page 1 when filtering *@

    <div class="row g-2 align-items-end">
        <div class="col-md-4">
            <label class="form-label">Search</label>
            <input name="search" value="@Model.Search" class="form-control" placeholder="Name, username, email, phone, ID" />
        </div>

            <div class="col-md-2">
                <label class="form-label">User type</label>
                <select id="userTypeSelect" name="userType" class="form-select">
                    <option value="all">All</option>
                    <option value="registered">Registered</option>
                    <option value="guests">Guests</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Orders</label>
                <select name="ordersFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="with">With orders</option>
                    <option value="without">No orders</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Sort</label>
                <select name="sort" class="form-select">
                    <option value="recent_desc">Recent order ↓</option>
                    <option value="recent_asc">Recent order ↑</option>
                    <option value="name_asc">Name A→Z</option>
                    <option value="name_desc">Name Z→A</option>
                    <option value="points_desc">Points ↓</option>
                    <option value="points_asc">Points ↑</option>
                    <option value="orders_desc">Orders ↓</option>
                    <option value="orders_asc">Orders ↑</option>
                    <option value="id_asc">ID ↑</option>
                    <option value="id_desc">ID ↓</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Page size</label>
                <select name="pageSize" class="form-select">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>


        <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-dark flex-grow-1" type="submit">Apply</button>
            <a class="btn btn-outline-secondary" asp-action="ManageCustomers" asp-controller="Admin">Reset</a>
        </div>
    </div>
</form>


    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Name / Username</th>
                    <th>Email / Phone</th>
                    <th>Type</th>
                    <th>Orders</th>
                    <th>Last Order</th>
                    <th class="text-end">Points (Registered)</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Customers.Any())
                {
                    <tr><td colspan="8" class="text-center text-muted py-4">No customers found.</td></tr>
                }
                else
                {
                    foreach (var c in Model.Customers)
                    {
                        var isRegistered = (c.CustomerUserName != null || c.CustomerPasswordHash != null);
                        var ordersCount = c.CustomerOrders?.Count ?? 0;
                        DateTime? lastOrder = c.CustomerOrders?.OrderByDescending(o => o.OrderCreatedAt).Select(o => (DateTime?)o.OrderCreatedAt).FirstOrDefault();

                        <tr>
                            <td><code>@c.CustomerId</code></td>
                            <td>
                                <div class="fw-semibold">@(!string.IsNullOrWhiteSpace(c.CustomerFullName) ? c.CustomerFullName : "(No CategoryName)")</div>
                                <div class="text-muted small">@c.CustomerUserName</div>
                            </td>
                            <td>
                                <div>@c.CustomerEmailAddress</div>
                                <div class="text-muted small">@c.CustomerPhoneNumber</div>
                            </td>
                            <td>
                                <span class="badge @(isRegistered ? "bg-primary" : "bg-secondary")">
                                    @(isRegistered ? "Registered" : "Guest")
                                </span>
                            </td>
                            <td>@ordersCount</td>
                            <td>@(lastOrder?.ToString("g") ?? "—")</td>
                            <td class="text-end">@(isRegistered? c.CustomerRewardPoints.ToString() : "—")</td>

                            <td class="text-end">
                                @if (isRegistered)
                                {
                                    <div class="d-inline-flex gap-1">

                                        <!-- -10 -->
                                        <form method="post"
                                              asp-controller="Admin"
                                              asp-action="AdjustPoints"
                                              asp-route-id="@c.CustomerId"
                                              asp-route-delta="-10"
                                              class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button class="btn btn-sm btn-outline-danger" title="Minus 10" type="submit">-10</button>
                                        </form>

                                        <!-- +10 -->
                                        <form method="post"
                                              asp-controller="Admin"
                                              asp-action="AdjustPoints"
                                              asp-route-id="@c.CustomerId"
                                              asp-route-delta="10"
                                              class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button class="btn btn-sm btn-outline-success" title="Plus 10" type="submit">+10</button>
                                        </form>

                                        <!-- Set -->
                                        <form method="post"
                                              asp-controller="Admin"
                                              asp-action="SetPoints"
                                              class="d-inline d-flex align-items-center gap-1">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@c.CustomerId" />
                                            <input type="number" name="points" class="form-control form-control-sm" style="width:90px" min="0" value="@c.CustomerRewardPoints" />
                                            <button class="btn btn-sm btn-dark" type="submit">Set</button>
                                        </form>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }

                                <!-- Delete -->
                                <form method="post"
                                      asp-controller="Admin"
                                      asp-action="DeleteCustomer"
                                      asp-route-id="@c.CustomerId"
                                      class="d-inline ms-2"
                                      onsubmit="return confirm('Delete customer @c.CustomerId? This cannot be undone.');">
                                    @Html.AntiForgeryToken()
                                    <button class="btn btn-sm btn-outline-secondary" type="submit">Delete</button>
                                </form>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Paging (unchanged) -->
    <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted">
            Showing page <strong>@Model.Page</strong> of <strong>@Model.TotalPages</strong> —
            <strong>@Model.TotalItems</strong> total
        </div>
        <nav>
            <ul class="pagination mb-0">
                @{
                    int prev = Math.Max(1, Model.Page - 1);
                    int next = Math.Min(Model.TotalPages, Model.Page + 1);

                    string link(int p) => Url.Action("ManageCustomers", "Admin", new
                    {
                        search = Model.Search,
                        userType = Model.UserType,
                        ordersFilter = Model.OrdersFilter,
                        sort = Model.SortBy,
                        minPoints = Model.MinPoints,
                        maxPoints = Model.MaxPoints,
                        page = p,
                        pageSize = Model.PageSize
                    })!;
                }
                <li class="page-item @(Model.Page == 1 ? "disabled" : "")">
                    <a class="page-link" href="@link(prev)">« Prev</a>
                </li>
                <li class="page-item @(Model.Page == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" href="@link(next)">Next »</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<style>
    .filter-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        padding: 16px 18px;
        box-shadow: 0 8px 24px rgba(0,0,0,.04)
    }

    .form-control, .form-select {
        border-radius: 12px
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #fafafa
    }

    .page-link {
        border-radius: 999px
    }

    .btn, .form-select, .form-control {
        transition: .15s ease
    }
</style>

@section Scripts {
    <script>
        // helper: set <select> value safely
        function setSelect(name, value) {
            const el = document.querySelector(`select[name="${name}"]`);
            if (el) el.value = value ?? "";
        }

        // set selected options from server model
        setSelect("userType", "@(Model.UserType ?? "all")");
        setSelect("ordersFilter", "@(Model.OrdersFilter ?? "all")");
        setSelect("sort", "@(Model.SortBy ?? "recent_desc")");
        setSelect("pageSize", "@Model.PageSize");

        // Disable points filter inputs unless userType = registered
        const userTypeSelect = document.getElementById('userTypeSelect');
        const pointsInputs = document.querySelectorAll('.points-input');
        function togglePoints() {
            const on = userTypeSelect && userTypeSelect.value === 'registered';
            pointsInputs.forEach(i => i.disabled = !on);
        }
        if (userTypeSelect) {
            userTypeSelect.addEventListener('change', togglePoints);
            togglePoints(); // run once on load
        }
    </script>
}

