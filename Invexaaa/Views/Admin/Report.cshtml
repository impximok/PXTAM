@model SnomiAssignmentReal.Models.ViewModels.ReportVm
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Text.Json
@using System.Linq
@using SnomiAssignmentReal.Models.ViewModels

@{
    ViewData["Title"] = "Reports";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // ----- Items chart data -----
    var labels = (Model?.BestSellingItems ?? Enumerable.Empty<BestSellerVm>())
                 .Select(b => b.ItemName)
                 .ToArray();

    var values = (Model?.BestSellingItems ?? Enumerable.Empty<BestSellerVm>())
                 .Select(b => b.QuantitySold)
                 .ToArray();

    var labelsJson = JsonSerializer.Serialize(labels);
    var valuesJson = JsonSerializer.Serialize(values);

    // ----- MenuItemCustomizations chart data -----
    var cLabels = (Model?.BestSellingCustomizations ?? Enumerable.Empty<BestCustomizationVm>())
                 .Select(c => c.CustomizationName)
                 .ToArray();

    var cCounts = (Model?.BestSellingCustomizations ?? Enumerable.Empty<BestCustomizationVm>())
                 .Select(c => c.TimesChosen)
                 .ToArray();

    var cRevenue = (Model?.BestSellingCustomizations ?? Enumerable.Empty<BestCustomizationVm>())
                 .Select(c => (double)c.TotalAddOnRevenue)
                 .ToArray();

    var cLabelsJson = JsonSerializer.Serialize(cLabels);
    var cCountsJson = JsonSerializer.Serialize(cCounts);
    var cRevenueJson = JsonSerializer.Serialize(cRevenue);
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    
    @@media print {
        /* Hide navigation / sidebars / buttons that shouldn't appear in the printed report */
        .navbar, .sidebar, .d-print-none

    {
        display: none !important;
    }

    /* Make the report use the full width of the page */
    .container {
        max-width: 100% !important;
    }

    body {
        background-color: #ffffff !important;
    }

    }
</style>

<div class="container py-5">

    <!-- Top bar: title + period + actions -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-graph-up-arrow me-2"></i> Café Report
            </h2>

            <p class="text-muted mb-0">
                @if (Model.PeriodStart.HasValue && Model.PeriodEnd.HasValue)
                {
                    <span>
                        Report period:
                        @Model.PeriodStart.Value.ToString("dd/MM/yyyy")
                        –
                        @Model.PeriodEnd.Value.ToString("dd/MM/yyyy")
                    </span>
                }
                else
                {
                    <span>Report period: No sales data available.</span>
                }
            </p>
        </div>

        <!-- Right-side actions (hidden when printing) -->
        <div class="d-flex gap-2 d-print-none">
            <button type="button"
                    class="btn btn-outline-secondary btn-sm"
                    onclick="window.print()">
                <i class="bi bi-printer me-1"></i> Print report
            </button>

            <a asp-action="DownloadReportExcel"
               asp-controller="Admin"
               asp-route-startDate="@(ViewBag.StartDate)"
               asp-route-endDate="@(ViewBag.EndDate)"
               class="btn btn-dark btn-sm"
               style="border-radius: 999px; padding: 6px 18px;">
                <i class="bi bi-file-earmark-spreadsheet me-1"></i> Download report
            </a>
        </div>
    </div>

    <hr class="d-print-none" />

    <!-- Date Filter (hide on print) -->
    <form method="get" class="row g-3 align-items-end mb-3 d-print-none">
        <div class="col-sm-4 col-md-3">
            <label class="form-label">From date</label>
            <input type="date"
                   name="startDate"
                   class="form-control"
                   value="@(ViewBag.StartDate ?? "")" />
        </div>

        <div class="col-sm-4 col-md-3">
            <label class="form-label">To date</label>
            <input type="date"
                   name="endDate"
                   class="form-control"
                   value="@(ViewBag.EndDate ?? "")" />
        </div>

        <div class="col-sm-4 col-md-3">
            <button type="submit" class="btn btn-dark w-100">
                <i class="bi bi-funnel me-1"></i> Apply Filter
            </button>
        </div>

        <div class="col-sm-12 col-md-3">
            <a asp-action="Report" asp-controller="Admin" class="btn btn-outline-secondary w-100">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Clear
            </a>
        </div>
    </form>

    <!-- KPI Cards -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Orders</h5>
                    <h2 class="fw-bold">@Model.TotalOrders</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Revenue</h5>
                    <h2 class="fw-bold text-success">@Model.TotalRevenue.ToString("C")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-muted">Items Sold</h5>
                    <h2 class="fw-bold">@Model.TotalItemsSold</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Best-selling Items -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Best Selling Items</h5>
        </div>
        <div class="card-body">
            <canvas id="bestSellersChart" height="120"></canvas>
        </div>
    </div>

    <!-- Most Popular Customizations -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-sliders"></i> Most Popular Customizations</h5>
        </div>
        <div class="card-body">
            <canvas id="bestCustomizationsChart" height="120"></canvas>
        </div>
    </div>

    <!-- Tables -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-list-ul"></i> Best Seller Breakdown</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Item</th>
                                <th class="text-end">Quantity Sold</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.BestSellingItems != null && Model.BestSellingItems.Any())
                            {
                                foreach (var item in Model.BestSellingItems)
                                {
                                    <tr>
                                        <td>@item.ItemName</td>
                                        <td class="text-end">@item.QuantitySold</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="2" class="text-center text-muted py-3">No sales data available.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-list-ul"></i> Customization Breakdown</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Customization</th>
                                <th class="text-end">Times Chosen</th>
                                <th class="text-end">Add-on Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.BestSellingCustomizations != null && Model.BestSellingCustomizations.Any())
                            {
                                foreach (var c in Model.BestSellingCustomizations)
                                {
                                    <tr>
                                        <td>@c.CustomizationName</td>
                                        <td class="text-end">@c.TimesChosen</td>
                                        <td class="text-end">@c.TotalAddOnRevenue.ToString("C")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">No customization data available.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            // Items chart
            const labels = @Html.Raw(labelsJson);
            const dataValues = @Html.Raw(valuesJson);
            const ctx1 = document.getElementById('bestSellersChart')?.getContext('2d');
            if (ctx1) {
                new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Quantity Sold',
                            data: dataValues,
                            backgroundColor: '#000000',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                    }
                });
            }

            // Customizations chart
            const cLabels = @Html.Raw(cLabelsJson);
            const cCounts = @Html.Raw(cCountsJson);
            const ctx2 = document.getElementById('bestCustomizationsChart')?.getContext('2d');
            if (ctx2) {
                new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: cLabels,
                        datasets: [{
                            label: 'Times Chosen',
                            data: cCounts,
                            backgroundColor: '#000000',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                    }
                });
            }
        })();
    </script>
}
