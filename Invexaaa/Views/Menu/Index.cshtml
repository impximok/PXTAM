@*
@model List<SnomiAssignmentReal.Models.MenuItem>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Manage Menu";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // from controller ViewBag
    var counts = ViewBag.CustomCounts as Dictionary<string, int> ?? new Dictionary<string, int>();
    string fq = ViewBag.FilterQ as string ?? "";
    string fc = ViewBag.FilterCategoryId as string ?? "";
    bool fa = (bool)(ViewBag.FilterOnlyAvailable ?? false);

    int page = (int)(ViewBag.Page ?? 1);
    int pageSize = (int)(ViewBag.PageSize ?? 12);
    int total = (int)(ViewBag.Total ?? 0);
    int totalPages = (int)(ViewBag.TotalPages ?? 1);

    var categories = (IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)
                     (ViewBag.Categories ?? Enumerable.Empty<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>());

    var safeModel = Model ?? new List<SnomiAssignmentReal.Models.MenuItem>();

    // Group the *paged* items by category for display
    var grouped = safeModel
        .GroupBy(m => new { m.CategoryId, CategoryName = m.Category?.CategoryName ?? "(Uncategorized)" })
        .OrderBy(g => g.Key.CategoryName)
        .ToList();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css" />

<div class="container py-4">

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="mb-0 fw-bold">Manage Menu</h2>
            <small class="text-muted">Create, edit, and organize items.</small>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Categories" class="btn btn-outline-dark rounded-pill">
                <i class="bi bi-collection me-1"></i> Manage Categories
            </a>
            <a asp-action="Create" class="btn btn-dark rounded-pill">
                <i class="bi bi-plus-circle me-1"></i> New Item
            </a>
        </div>
    </div>

    <!-- Filters -->
    <form method="get" class="card p-3 mb-3 border-0 shadow-sm" style="border-radius:1rem;">
        <div class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label mb-1">Search</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input name="q" value="@fq" class="form-control" placeholder="Name or description" />
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label mb-1">Category</label>
                <select name="categoryId" class="form-select">
                    @foreach (var opt in categories)
                    {
                        <option value="@opt.Value" selected="@(opt.Selected)">
                            @opt.Text
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label mb-1">Page size</label>
                <select name="pageSize" class="form-select">
                    @foreach (var size in new[] { 8, 12, 16, 20, 24, 30 })
                    {
                        <option value="@size" selected="@(pageSize == size)">@size</option>
                    }
                </select>
            </div>

            <div class="col-md-2 d-flex align-items-center gap-3">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" name="onlyAvailable" value="true" @(fa ? "checked" : "") id="chkAvail" />
                    <label class="form-check-label" for="chkAvail">Only available</label>
                </div>
                <div class="d-grid mt-4">
                    <button class="btn btn-outline-dark rounded-pill" type="submit"
                            onclick="document.getElementById('pageInput').value=1">
                        Apply
                    </button>
                </div>
            </div>
        </div>

        <!-- keep page=1 on apply -->
        <input type="hidden" id="pageInput" name="page" value="@(page)" />
    </form>

    <!-- Flash messages -->
    @if (TempData["Info"] != null)
    {
        <div class="alert alert-success">@TempData["Info"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @if (!grouped.Any())
    {
        <div class="text-center text-muted py-5">
            <i class="bi bi-inbox" style="font-size:2rem;"></i>
            <div class="mt-2">No items found. Try adjusting filters or add a new item.</div>
        </div>
    }
    else
    {
        <!-- Grouped cards -->
        @foreach (var group in grouped)
        {
            <div class="d-flex align-items-center gap-2 mt-4 mb-2">
                <h4 class="mb-0">@group.Key.CategoryName</h4>
                <span class="badge text-bg-light border">ID: @group.Key.CategoryId</span>
                <span class="cat-divider flex-grow-1"></span>
            </div>

            <div class="row g-4">
                @foreach (var item in group)
                {
                    var customCount = counts.ContainsKey(item.MenuItemId) ? counts[item.MenuItemId] : 0;

                    <div class="col-12 col-md-6 col-xl-4">
                        <div class="card h-100 border-0 shadow-sm" style="border-radius:1rem; overflow:visible;">
                            <!-- Square 1:1 thumbnail -->
                            <div class="square-thumb">
                                <img src="@item.MenuItemImageUrl" alt="@item.MenuItemName" class="thumb-img" />
                            </div>

                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="card-title mb-1">@item.MenuItemName</h5>
                                        <div class="text-muted small">ID: @item.MenuItemId</div>
                                    </div>
                                    <span class="badge @(item.IsAvailableForOrder ? "text-bg-dark" : "text-bg-secondary") align-self-start">
                                        @(item.IsAvailableForOrder ? "Available" : "Hidden")
                                    </span>
                                </div>

                                <p class="card-text text-muted mb-3" style="min-height:40px;">@item.MenuItemDescription</p>

                                <div class="d-flex justify-content-between mb-3">
                                    <div>
                                        <span class="fw-semibold">RM @item.MenuItemUnitPrice.ToString("0.00")</span>
                                        <span class="text-muted small ms-2">@item.MenuItemCalories kcal</span>
                                    </div>
                                    <span class="badge text-bg-light border">
                                        <i class="bi bi-sliders me-1"></i>@customCount customization@(customCount == 1 ? "" : "s")
                                    </span>
                                </div>

                                <div class="mt-auto d-flex gap-2">
                                    <a asp-action="Edit" asp-route-id="@item.MenuItemId" class="btn btn-outline-dark w-50 rounded-pill">
                                        <i class="bi bi-pencil-square me-1"></i> Edit
                                    </a>

                                    <form asp-action="Delete"
                                          asp-route-id="@item.MenuItemId"
                                          method="post"
                                          class="w-50"
                                          onsubmit="return confirm('Delete @item.MenuItemName?');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger w-100 rounded-pill">
                                            <i class="bi bi-trash me-1"></i> Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Bottom pagination ONLY -->
        <nav class="mt-4">
            <ul class="pagination justify-content-end flex-wrap mb-0">
                <li class="page-item @(page <= 1 ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-q="@fq"
                       asp-route-categoryId="@fc"
                       asp-route-onlyAvailable="@fa"
                       asp-route-page="@(1)"
                       asp-route-pageSize="@pageSize">« First</a>
                </li>
                <li class="page-item @(page <= 1 ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-q="@fq"
                       asp-route-categoryId="@fc"
                       asp-route-onlyAvailable="@fa"
                       asp-route-page="@(page - 1)"
                       asp-route-pageSize="@pageSize">‹ Prev</a>
                </li>

                @{
                    var start = Math.Max(1, page - 2);
                    var end = Math.Min(totalPages, page + 2);
                    for (int p = start; p <= end; p++)
                    {
                        <li class="page-item @(p == page ? "active" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-route-q="@fq"
                               asp-route-categoryId="@fc"
                               asp-route-onlyAvailable="@fa"
                               asp-route-page="@(p)"
                               asp-route-pageSize="@pageSize">@p</a>
                        </li>
                    }
                }

                <li class="page-item @(page >= totalPages ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-q="@fq"
                       asp-route-categoryId="@fc"
                       asp-route-onlyAvailable="@fa"
                       asp-route-page="@(page + 1)"
                       asp-route-pageSize="@pageSize">Next ›</a>
                </li>
                <li class="page-item @(page >= totalPages ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-q="@fq"
                       asp-route-categoryId="@fc"
                       asp-route-onlyAvailable="@fa"
                       asp-route-page="@(totalPages)"
                       asp-route-pageSize="@pageSize">Last »</a>
                </li>
            </ul>
        </nav>
    }

</div>

<!-- If your _Layout already includes the bundle, remove this line -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    /* category header divider */
    .cat-divider {
        height: 1px;
        background: linear-gradient(to right,#e5e7eb,transparent);
    }

    /* Square 1:1 thumbnail on cards */
    .square-thumb {
        width: 100%;
        aspect-ratio: 1/1;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        overflow: hidden;
        background: #f3f4f6;
    }

        .square-thumb .thumb-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    /* Minimal black/white accents */
    .form-control:focus, .form-select:focus {
        border-color: #111;
        box-shadow: 0 0 0 .15rem rgba(0,0,0,.08);
    }

    .btn-dark {
        background: #111;
        border-color: #111;
    }

        .btn-dark:hover, .btn-dark:focus {
            background: #000;
            border-color: #000;
        }

    .btn-outline-dark:hover {
        color: #fff;
    }

    /* Pager styling (monochrome) */
    .pagination .page-link {
        border: 1px solid #111;
        border-radius: .6rem;
        color: #111
    }

    .pagination .page-item.active .page-link {
        background: #111;
        color: #fff;
        border-color: #111
    }
</style>
*@