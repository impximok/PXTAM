@*
@model SnomiAssignmentReal.Models.ViewModels.CreateMenuItemViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Add New Menu Item";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var library = (IEnumerable<SnomiAssignmentReal.Models.OrderCustomizationSettings>)(ViewBag.Library ?? new List<SnomiAssignmentReal.Models.OrderCustomizationSettings>());
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css" />

<div class="container py-5">
    <div class="mx-auto" style="max-width: 720px;">
        <div class="card p-4" style="border:1px solid #e5e7eb; border-radius:1.25rem; box-shadow:0 12px 30px rgba(0,0,0,.06);">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="mb-0"><i class="bi bi-plus-circle"></i> @ViewData["Title"]</h2>
                <a asp-action="Index" class="btn btn-outline-dark rounded-pill"><i class="bi bi-arrow-left"></i> Back</a>
            </div>

            @if (TempData["Info"] != null)
            {
                <div class="alert alert-success mb-3">@TempData["Info"]</div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger mb-3">@TempData["Error"]</div>
            }

            <form asp-action="Create" enctype="multipart/form-data" method="post" novalidate>
                @Html.AntiForgeryToken()

                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <div class="row g-3">
                    <div class="col-12">
                        <label asp-for="Name" class="form-label fw-semibold"><i class="bi bi-tag"></i> Name</label>
                        <input asp-for="Name" class="form-control" autocomplete="off" />
                        <span asp-validation-for="Name" class="text-danger small"></span>
                    </div>

                    <div class="col-12">
                        <label asp-for="Description" class="form-label fw-semibold"><i class="bi bi-card-text"></i> Description</label>
                        <textarea asp-for="Description" class="form-control" rows="2"></textarea>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="CategoryId" class="form-label fw-semibold d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-list-ul"></i> Category</span>
                            <button type="button" class="btn btn-sm btn-outline-dark rounded-pill" data-bs-toggle="modal" data-bs-target="#addCatModal">
                                <i class="bi bi-plus"></i> Add Category
                            </button>
                        </label>
                        <select asp-for="CategoryId" class="form-select"
                                asp-items="@(ViewBag.Categories as List<SelectListItem>)" id="CategoryId"></select>
                        <span asp-validation-for="CategoryId" class="text-danger small"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="Calories" class="form-label fw-semibold"><i class="bi bi-fire"></i> Calories</label>
                        <input asp-for="Calories" type="number" min="0" max="4000" class="form-control" />
                        <span asp-validation-for="Calories" class="text-danger small"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="Price" class="form-label fw-semibold"><i class="bi bi-cash-stack"></i> Price</label>
                        <div class="input-group">
                            <span class="input-group-text">RM</span>
                            <input asp-for="Price" type="number" step="0.01" min="0" max="1000" class="form-control" />
                        </div>
                        <span asp-validation-for="Price" class="text-danger small"></span>
                    </div>

                    <!-- AVAILABILITY -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold d-block"><i class="bi bi-toggle2-on"></i> Availability</label>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" asp-for="IsAvailable" value="true" id="availTrue" />
                            <label class="form-check-label" for="availTrue">Available</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" asp-for="IsAvailable" value="false" id="availFalse" />
                            <label class="form-check-label" for="availFalse">Unavailable</label>
                        </div>
                        <span asp-validation-for="IsAvailable" class="text-danger small"></span>
                    </div>

                    <!-- IMAGE + DnD + WEBCAM + EDITOR -->
                    <div class="col-12">
                        <label class="form-label fw-semibold"><i class="bi bi-image"></i> Item Image</label>

                        <input asp-for="ImageFile" id="ImageFile" type="file" accept="image/*" class="d-none" />
                        <input type="hidden" name="CapturedImageDataUrl" id="CapturedCreate" />

                        <div id="previewBox" class="square-preview clickable mx-auto" title="Click or drop an image">
                            <img id="imgPreview" alt="">
                            <div class="square-overlay" aria-hidden="true"><i class="bi bi-image"></i></div>
                        </div>

                        <div class="d-flex justify-content-center gap-2 mt-2">
                            <button type="button" class="btn btn-outline-dark rounded-pill" id="btnBrowseCreate"><i class="bi bi-folder2-open"></i> Browse</button>
                            <button type="button" class="btn btn-outline-dark rounded-pill" id="btnCameraCreate"><i class="bi bi-camera"></i> Take Photo</button>
                            <span class="text-muted small align-self-center">Max 4 MB</span>
                        </div>

                        <div class="form-text text-center">Drag & drop an image here, or use the buttons. You can crop/rotate before saving.</div>
                        <span asp-validation-for="ImageFile" class="text-danger small"></span>
                    </div>
                </div>

                <hr class="my-4" />

                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="toggleCust" />
                        <label class="form-check-label" for="toggleCust">Add customizations now</label>
                    </div>
                    <div class="d-none" id="custActionsToolbar">
                        <button type="button" class="btn btn-outline-dark btn-sm rounded-pill" id="btnAddRow"><i class="bi bi-plus"></i> Row</button>
                        <button type="button" class="btn btn-outline-dark btn-sm rounded-pill" id="btnFromLib" data-bs-toggle="modal" data-bs-target="#libModal">
                            <i class="bi bi-collection"></i> Add From Library
                        </button>
                        <button type="button" class="btn btn-outline-dark btn-sm rounded-pill" id="btnClearRows"><i class="bi bi-x-circle"></i> Clear</button>
                    </div>
                </div>

                <div id="custBuilder" class="d-none">
                    <div class="table-responsive mb-3">
                        <table class="table align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:28%;">Name</th>
                                    <th style="width:14%;">Price (RM)</th>
                                    <th style="width:38%;">Description</th>
                                    <th style="width:15%;">Eligible Cat. ID</th>
                                    <th style="width:5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="custRows"></tbody>
                        </table>
                    </div>
                    <div class="small text-muted mb-4">
                        Leave a row blank to ignore it. You can edit these later.
                        <div class="text-danger" data-valmsg-for="Customizations" data-valmsg-replace="true"></div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-dark rounded-pill"><i class="bi bi-save"></i> Save Menu Item</button>
                    <a asp-action="Index" class="btn btn-outline-dark rounded-pill"><i class="bi bi-x-circle"></i> Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add From Library Modal -->
<div class="modal fade" id="libModal" tabindex="-1" aria-labelledby="libModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="border-radius:1rem;">
            <div class="modal-header">
                <h5 class="modal-title" id="libModalLabel"><i class="bi bi-collection"></i> Add From Library</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="text-muted small">Showing templates that match the selected Category (or “Any category”).</div>
                    <div>
                        <span class="small me-1">Current Category:</span>
                        <span id="libCurrentCat" class="badge text-bg-light border">—</span>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle" id="libTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width:5%;"></th>
                                <th style="width:25%;">Name</th>
                                <th style="width:40%;">Description</th>
                                <th style="width:15%;">Price</th>
                                <th style="width:15%;">Eligible Cat.</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in library)
                            {
                                var elig = p.EligibleCategoryId ?? "";
                                <tr data-eligcat="@elig">
                                    <td><input type="checkbox" class="form-check-input lib-pick" /></td>
                                    <td class="lib-name">@p.CustomizationName</td>
                                    <td class="lib-desc text-muted">@p.CustomizationDescription</td>
                                    <td class="lib-price">@(p.CustomizationAdditionalPrice.ToString("0.00"))</td>
                                    <td class="lib-elig text-muted">@(string.IsNullOrEmpty(elig) ? "— Any —" : elig)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-dark rounded-pill" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-dark rounded-pill" id="btnAddSelectedFromLib" data-bs-dismiss="modal">
                    <i class="bi bi-plus-circle"></i> Add Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCatModal" tabindex="-1" aria-labelledby="addCatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:1rem;">
            <div class="modal-header">
                <h5 class="modal-title" id="addCatModalLabel"><i class="bi bi-list-ul"></i> Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="addCatErr" class="text-danger small mb-2"></div>
                <input type="text" id="newCatName" class="form-control" maxlength="50" placeholder="Category name (e.g. Drinks)" />
                <textarea id="newCatDesc" class="form-control mt-2" rows="2" maxlength="255" placeholder="Description (optional)"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-dark rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dark rounded-pill" id="btnSaveCat"><i class="bi bi-save"></i> Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Camera + Editor (Create) -->
<div class="camera-sheet" id="cameraSheetCreate" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="camera-sheet__panel" role="document">
        <div class="camera-sheet__header">
            <h2 class="m-0 fs-6">Edit Photo</h2>
            <button type="button" class="icon-btn" id="closeCamCreate" aria-label="Close">×</button>
        </div>
        <div class="camera-sheet__body">
            <section class="cam-section" id="liveSectionCreate">
                <header class="cam-section__title">Live view</header>
                <div class="camera-frame">
                    <div class="cam-loader" id="camLoaderCreate"></div>
                    <video id="camVideoCreate" playsinline muted autoplay></video>
                    <div class="square-mask" aria-hidden="true"></div>
                </div>
                <div class="camera-actions">
                    <button type="button" class="btn btn-dark rounded-pill" id="captureCreate">Capture</button>
                </div>
            </section>

            <section class="cam-section" id="editorSectionCreate" hidden>
                <header class="cam-section__title">Crop & Adjust</header>
                <div id="apCropBoxCreate" style="position:relative;width:min(420px,90vw);aspect-ratio:1/1;border:1px solid #eee;border-radius:12px;overflow:hidden;background:#000;margin:0 auto;">
                    <img id="apEditImgCreate" alt="Editor" style="position:absolute;left:0;top:0;transform-origin:0 0;user-select:none;-webkit-user-drag:none;">
                </div>
                <div class="ap-toolbar">
                    <div class="ap-group">
                        <label for="apZoomCreate" class="ap-label">Zoom</label>
                        <input id="apZoomCreate" type="range" min="1" max="3" step="0.01" value="1" class="ap-range">
                    </div>
                    <div class="ap-group">
                        <button type="button" class="btn btn-outline-dark btn-sm rounded-pill" id="apRotLCreate">⟲ Rotate Left</button>
                        <button type="button" class="btn btn-outline-dark btn-sm rounded-pill" id="apRotRCreate">⟳ Rotate Right</button>
                        <button type="button" class="btn btn-outline-dark btn-sm rounded-pill" id="apResetCreate">Reset</button>
                    </div>
                    <div class="ap-group">
                        <button type="button" class="btn btn-outline-dark btn-sm rounded-pill" id="apBackCreate">Back</button>
                        <button type="button" class="btn btn-dark btn-sm rounded-pill" id="usePhotoCreate">Use Photo</button>
                    </div>
                </div>
                <canvas id="apCanvasCreate" width="512" height="512" hidden></canvas>
            </section>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ======== Image (Create) — DnD/Preview + Webcam + Editor ========

        // --- small helpers ---
        function dtFor(file){ const dt=new DataTransfer(); dt.items.add(file); return dt; }
        function setFileOn(inputEl,file){ inputEl.files = dtFor(file).files; }
        async function dataUrlToFile(dataUrl, filename='menu-item.jpg'){
          const res = await fetch(dataUrl);
          const blob = await res.blob();
          const ext  = (blob.type && blob.type.includes('png')) ? 'png' : 'jpg';
          return new File([blob], filename.replace(/\.(jpg|jpeg|png)$/i,'') + '.' + ext, { type: blob.type || 'image/jpeg' });
        }

        // Drag & drop box → when a file is dropped, open the editor
        function hookDnd(boxId,inputId,maxMB){
          const box=document.getElementById(boxId), input=document.getElementById(inputId);
          if(!box||!input) return;
          const hi=(on)=>box.classList.toggle('dragover', !!on);
          ['dragenter','dragover'].forEach(ev=> box.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();hi(true);} ));
          ['dragleave','dragend'].forEach(ev=> box.addEventListener(ev,e=>hi(false)));
          box.addEventListener('drop',e=>{
            e.preventDefault(); e.stopPropagation(); hi(false);
            const f=e.dataTransfer.files?.[0]; if(!f) return;
            if(!f.type.startsWith('image/')){ alert('Please drop an image.'); return; }
            if(f.size > maxMB*1024*1024){ alert('Max '+maxMB+' MB.'); return; }
            openEditorFromFile(f);     // <— go straight to editor
          });
        }

        // --- elements shared by both file + webcam flows ---
        const sheet = document.getElementById('cameraSheetCreate');
        const closeBtn = document.getElementById('closeCamCreate');
        const liveSec  = document.getElementById('liveSectionCreate');
        const editSec  = document.getElementById('editorSectionCreate');
        const video    = document.getElementById('camVideoCreate');
        const loader   = document.getElementById('camLoaderCreate');
        const capture  = document.getElementById('captureCreate');

        const cropBox  = document.getElementById('apCropBoxCreate');
        const editImg  = document.getElementById('apEditImgCreate');
        const zoom     = document.getElementById('apZoomCreate');
        const rotL     = document.getElementById('apRotLCreate');
        const rotR     = document.getElementById('apRotRCreate');
        const resetBtn = document.getElementById('apResetCreate');
        const backBtn  = document.getElementById('apBackCreate');
        const useBtn   = document.getElementById('usePhotoCreate');
        const canvas   = document.getElementById('apCanvasCreate'), g = canvas.getContext('2d');

        const fileInput  = document.getElementById('ImageFile');
        const imgPreview = document.getElementById('imgPreview');
        const boxPreview = document.getElementById('previewBox');
        const browseBtn  = document.getElementById('btnBrowseCreate');
        const camBtn     = document.getElementById('btnCameraCreate');

        // state for editor
        let stream=null, base=null, w=0,h=0, z=1, minZ=1, maxZ=3, offX=0, offY=0, dragging=false, sx=0, sy=0;

        // --- modal helpers ---
        function showSheet(){ sheet.setAttribute('aria-hidden','false'); document.documentElement.style.overflow='hidden'; }
        function hideSheet(){ sheet.setAttribute('aria-hidden','true');  document.documentElement.style.overflow=''; stopCamera(); }

        function stopCamera(){
          try{ stream?.getTracks().forEach(t=>t.stop()); }catch{}
          stream=null;
          try{ video.pause(); video.srcObject=null; video.removeAttribute('src'); video.load(); }catch{}
        }

        // --- open editor with a picked/dropped file ---
        function openEditorFromFile(file){
          const reader = new FileReader();
          reader.onload = e => {
            const dataUrl = e.target.result;
            startEditor(dataUrl);
            liveSec.hidden = true;     // skip live view
            editSec.hidden = false;
            showSheet();
          };
          reader.readAsDataURL(file);
        }

        // --- common editor machinery (used by both webcam capture + file select) ---
        function startEditor(src){
          base = src;
          editImg.src = '';
          requestAnimationFrame(()=> editImg.src = src);
          editImg.onload = () => {
            w = editImg.naturalWidth; h = editImg.naturalHeight; initLayout();
          };
        }

        function initLayout(){
          const box = cropBox.getBoundingClientRect().width;
          const zx = box / w, zy = box / h;
          minZ = Math.max(zx, zy);
          z    = Math.max(minZ, 1);
          offX = (box - w*z)/2;
          offY = (box - h*z)/2;

          zoom.min  = String(Math.min(minZ, maxZ).toFixed(2));
          zoom.max  = String(maxZ);
          zoom.value= String(Math.min(Math.max(z, minZ), maxZ).toFixed(2));
          render();

          const start=(x,y)=>{ dragging=true; sx=x-offX; sy=y-offY; };
          const move =(x,y)=>{ if(!dragging) return; offX=x-sx; offY=y-sy; render(); };
          const end  =()=>{ dragging=false; };

          cropBox.onmousedown = e=>{ e.preventDefault(); start(e.clientX,e.clientY); };
          window.onmousemove  = e=> move(e.clientX,e.clientY);
          window.onmouseup    = end;

          cropBox.ontouchstart= e=>{ const t=e.touches[0]; start(t.clientX,t.clientY); };
          cropBox.ontouchmove = e=>{ const t=e.touches[0]; move(t.clientX,t.clientY); };
          cropBox.ontouchend  = end;

          cropBox.onwheel = e=>{
            e.preventDefault();
            const d = -Math.sign(e.deltaY)*0.08, prev=z;
            z = Math.max(minZ, Math.min(maxZ, z + d));
            const r=cropBox.getBoundingClientRect(), cx=e.clientX-r.left, cy=e.clientY-r.top;
            offX = cx - ((cx - offX) * (z / prev));
            offY = cy - ((cy - offY) * (z / prev));
            zoom.value = String(z.toFixed(2));
            render();
          };

          zoom.oninput = ()=>{
            const prev=z;
            z = Math.max(minZ, Math.min(maxZ, parseFloat(zoom.value)||minZ));
            const s = cropBox.getBoundingClientRect().width/2;
            offX = s - ((s - offX) * (z / prev));
            offY = s - ((s - offY) * (z / prev));
            render();
          };
        }

        function clamp(box, dw, dh){
          if (dw <= box){ offX = (box - dw)/2; }
          else { const mn = box - dw; offX = Math.min(0, Math.max(offX, mn)); }
          if (dh <= box){ offY = (box - dh)/2; }
          else { const mn = box - dh; offY = Math.min(0, Math.max(offY, mn)); }
        }

        function render(){
          const box = cropBox.getBoundingClientRect().width;
          const dw  = w * z, dh = h * z;
          clamp(box, dw, dh);
          editImg.style.width  = dw + 'px';
          editImg.style.height = dh + 'px';
          editImg.style.transform = `translate(${offX}px, ${offY}px)`;
        }

        function rotateDataUrl(src, deg){
          return new Promise((resolve,reject)=>{
            const img=new Image();
            img.onload=()=>{
              const r=(deg%360+360)%360, swap=(r===90||r===270);
              const iw=img.naturalWidth, ih=img.naturalHeight;
              const cw=swap?ih:iw, ch=swap?iw:ih;
              const c=document.createElement('canvas'); c.width=cw; c.height=ch;
              const gg=c.getContext('2d');
              gg.translate(cw/2, ch/2);
              gg.rotate(r*Math.PI/180);
              gg.drawImage(img, -iw/2, -ih/2);
              resolve(c.toDataURL('image/jpeg', .95));
            };
            img.onerror=reject;
            img.src=src;
          });
        }

        // --- file browse → open editor ---
        browseBtn?.addEventListener('click', ()=> fileInput.click());
        fileInput?.addEventListener('change', function(){
          const f=this.files?.[0];
          if(!f){ return; }
          openEditorFromFile(f);           // <— open editor for chosen file
        });

        // --- drag & drop setup on preview box ---
        hookDnd('previewBox','ImageFile',4);

        // --- webcam flow (unchanged UX, just shares the same editor) ---
        camBtn?.addEventListener('click', async ()=>{
          const dev = ['localhost','127.0.0.1','::1'];
          if (!window.isSecureContext && !dev.includes(location.hostname)) {
            fileInput.click(); return;
          }
          liveSec.hidden=false; editSec.hidden=true; showSheet(); loader.style.display='grid';
          try{
            stream = await navigator.mediaDevices.getUserMedia({
              video:{ facingMode:{ideal:'user'}, width:{ideal:720}, height:{ideal:720}, aspectRatio:{ideal:1} },
              audio:false
            });
            video.srcObject = stream; await video.play();
          }catch{
            hideSheet();
          }finally{
            loader.style.display='none';
          }
        });

        capture?.addEventListener('click', ()=>{
          if(!video.videoWidth) return;
          const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
          c.getContext('2d').drawImage(video,0,0,c.width,c.height);
          const dataUrl = c.toDataURL('image/jpeg', .95);
          stopCamera();
          startEditor(dataUrl);
          liveSec.hidden=true; editSec.hidden=false;
        });

        closeBtn?.addEventListener('click', hideSheet);
        sheet?.addEventListener('click', e=>{ if(e.target===sheet) hideSheet(); });
        document.addEventListener('keydown', e=>{ if(e.key==='Escape' && sheet.getAttribute('aria-hidden')==='false') hideSheet(); });

        // --- editor buttons ---
        rotL.addEventListener('click', async ()=>{ base = await rotateDataUrl(base, -90); startEditor(base); });
        rotR.addEventListener('click', async ()=>{ base = await rotateDataUrl(base,  90); startEditor(base); });
        resetBtn.addEventListener('click', ()=> startEditor(base));
        backBtn.addEventListener('click', ()=>{ editSec.hidden=true; liveSec.hidden=false; });

        // --- export cropped image back to <input type="file"> so controller gets it ---
        useBtn.addEventListener('click', async ()=>{
          const box = cropBox.getBoundingClientRect().width, out=512;
          canvas.width=out; canvas.height=out;

          const s=z;
          const srcX=Math.max(0,(-offX)/s), srcY=Math.max(0,(-offY)/s);
          const srcW=Math.min(w-srcX, box/s), srcH=Math.min(h-srcY, box/s);

          g.fillStyle='#fff'; g.fillRect(0,0,out,out); g.imageSmoothingQuality='high';
          g.drawImage(editImg, srcX,srcY,srcW,srcH, 0,0,out,out);
          const dataUrl = canvas.toDataURL('image/jpeg', .95);

          // Convert to File and set it on the file input so MenuController.Create receives vm.ImageFile
          const editedFile = await dataUrlToFile(dataUrl, 'menu-item.jpg');
          setFileOn(fileInput, editedFile);

          // Update on-page preview
          imgPreview.src = dataUrl;
          boxPreview.classList.add('has-image');

          hideSheet();
        });
    </script>


    <style>
        .modal {
            z-index: 2050 !important;
        }

        .modal-backdrop {
            z-index: 2000 !important;
        }

        .form-control:focus, .form-select:focus {
            border-color: #111;
            box-shadow: 0 0 0 .15rem rgba(0,0,0,.1);
        }

        .btn-dark {
            background: #111;
            border-color: #111;
        }

            .btn-dark:hover, .btn-dark:focus {
                background: #000;
                border-color: #000;
            }

        .btn-outline-dark:hover {
            color: #fff;
        }

        .square-preview {
            width: clamp(160px,26vw,220px);
            aspect-ratio: 1/1;
            border: 1.5px dashed #cfd3d7;
            border-radius: 14px;
            background: #f7f7f8;
            position: relative;
            overflow: hidden;
            display: grid;
            place-items: center;
            transition: border-color .15s, background-color .15s;
        }

            .square-preview:hover {
                border-color: #111;
            }

            .square-preview.clickable {
                cursor: pointer;
            }

            .square-preview img {
                display: none;
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .square-preview.has-image img {
                display: block;
            }

            .square-preview.has-image .square-overlay {
                opacity: 0;
                pointer-events: none;
            }

        .square-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9aa0a6;
            transition: opacity .15s;
        }

            .square-overlay .bi {
                font-size: 1.6rem;
            }

        .square-preview.dragover {
            border-color: #111;
            background: #eef2ff;
        }

        .camera-sheet {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: grid;
            place-items: center;
            padding: 16px;
            opacity: 0;
            pointer-events: none;
            transition: opacity .18s;
            z-index: 2100;
        }

            .camera-sheet[aria-hidden="false"] {
                opacity: 1;
                pointer-events: auto;
            }

        .camera-sheet__panel {
            width: min(560px,96vw);
            max-height: min(92vh,760px);
            background: #fff;
            color: #111;
            border: 1px solid #e8e8e8;
            border-radius: 18px;
            box-shadow: 0 24px 60px rgba(0,0,0,.18);
            display: flex;
            flex-direction: column;
            overflow: auto;
        }

        .camera-sheet__header {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .camera-sheet__body {
            display: grid;
            gap: 14px;
            padding: 12px 16px;
        }

        .camera-frame {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #eee;
            background: #000;
            height: clamp(260px,56vh,440px);
            aspect-ratio: 1/1;
        }

            .camera-frame video {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        .cam-loader {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            background: linear-gradient(120deg,rgba(255,255,255,.06),rgba(255,255,255,0),rgba(255,255,255,.06));
            animation: shimmer 1.2s infinite linear;
        }
        @@keyframes shimmer {
            to

        {
            background-position: 200% 0
        }

        }

        .square-mask {
            position: absolute;
            inset: 0;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0,0,0,.35),0 0 0 2px rgba(255,255,255,.9);
            border-radius: 10px;
            margin: 6%;
        }

        .camera-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid #cfcfcf;
            color: #111;
            border-radius: 999px;
            width: 34px;
            height: 34px;
            font-size: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .ap-toolbar {
            display: grid;
            gap: 12px;
            margin-top: 12px;
        }

        .ap-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ap-label {
            color: #555;
            font-size: .9rem;
            font-weight: 600;
            letter-spacing: -.01em;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: .95rem;
            border-radius: 999px;
        }

        .ap-range {
            width: min(360px,80vw);
            height: 6px;
        }

            .ap-range::-webkit-slider-runnable-track {
                height: 4px;
                background: #e6e6e6;
                border-radius: 999px;
            }

            .ap-range::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #111;
                margin-top: -7px;
                box-shadow: 0 1px 3px rgba(0,0,0,.2);
            }

            .ap-range::-moz-range-track {
                height: 4px;
                background: #e6e6e6;
                border-radius: 999px;
            }

            .ap-range::-moz-range-thumb {
                width: 18px;
                height: 18px;
                border-radius: 50%;
                border: 0;
                background: #111;
                box-shadow: 0 1px 3px rgba(0,0,0,.2);
            }
    </style>
}
*@