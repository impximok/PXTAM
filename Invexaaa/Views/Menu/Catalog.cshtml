@model IEnumerable<SnomiAssignmentReal.Models.MenuItem>

@{
    ViewData["Title"] = "Our Menu";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string Safe(string s) => s?.Trim() ?? "";

    // state from controller
    int page = ViewBag.Page is int p ? p : 1;
    int pageSize = ViewBag.PageSize is int ps ? ps : 12;
    int total = ViewBag.Total is int t ? t : 0;
    int totalPages = ViewBag.TotalPages is int tp ? tp : 1;

    string keepQ = ViewBag.FilterQ as string ?? "";
    string keepCat = ViewBag.FilterCategoryId as string ?? "";
    bool keepAvail = ViewBag.FilterOnlyAvailable is bool bo && bo;
    string keepSort = ViewBag.Sort as string ?? "name_asc";

    var chips = (IEnumerable<dynamic>)(ViewBag.CategoryChips ?? Enumerable.Empty<dynamic>());

    string BaseUrl(object extra) => Url.Action("Catalog", "Menu", extra) ?? "#";

    string PageUrl(int target) =>
        Url.Action("Catalog", "Menu", new
        {
            q = string.IsNullOrWhiteSpace(keepQ) ? null : keepQ,
            categoryId = string.IsNullOrWhiteSpace(keepCat) ? null : keepCat,
            onlyAvailable = keepAvail ? (bool?)true : (bool?)null,
            sort = keepSort,
            page = target,
            pageSize
        }) ?? "#";

    // build groups from the CURRENT PAGE SLICE
    var groups = Model
        .GroupBy(i => string.IsNullOrWhiteSpace(i?.Category?.CategoryName) ? "Uncategorized" : i!.Category!.CategoryName)
        .OrderBy(g => g.Key)
        .ToList();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

<div class="container py-5 menu-page" id="top">
    <header class="text-center mb-5">
        <h2 class="display-5 fw-bold mb-2">Our Menu</h2>
        <p class="text-muted mb-0">Search, filter, and browse by category</p>
    </header>

    <!-- Toolbar -->
    <div class="toolbar mb-4">
        <div class="row g-2 align-items-center">
            <div class="col-12 col-md-6">
                <form method="get" class="d-flex gap-2" role="search">
                    <input type="hidden" name="categoryId" value="@keepCat" />
                    <input type="hidden" name="onlyAvailable" value="@(keepAvail ? "true" : "")" />
                    <input type="hidden" name="sort" value="@keepSort" />
                    <input type="hidden" name="page" value="1" />
                    <input id="searchBox" name="q" type="search" class="form-control input-mono"
                           value="@keepQ" placeholder="Search dishes…" aria-label="Search menu" />
                    <button class="btn btn-outline-dark" type="submit">Search</button>
                </form>
            </div>

            <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end align-items-center gap-2">
                <!-- sort links -->
                <div id="sortGroup" class="sort3" role="tablist" aria-label="Sort menu items">
                    <a class="sort3-pill @(keepSort == "name_asc" ? "active" : "")"
                       href="@BaseUrl(new { q = keepQ, categoryId = keepCat, onlyAvailable = keepAvail ? (bool?)true : null, sort = "name_asc", page = 1, pageSize })">
                        <span class="label">Name</span><span class="chev" aria-hidden="true">↑</span>
                    </a>
                    <a class="sort3-pill @(keepSort == "price_asc" ? "active" : "")"
                       href="@BaseUrl(new { q = keepQ, categoryId = keepCat, onlyAvailable = keepAvail ? (bool?)true : null, sort = "price_asc", page = 1, pageSize })">
                        <span class="label">Price</span><span class="chev" aria-hidden="true">↕</span>
                    </a>
                    <a class="sort3-pill @(keepSort == "cal_asc" ? "active" : "")"
                       href="@BaseUrl(new { q = keepQ, categoryId = keepCat, onlyAvailable = keepAvail ? (bool?)true : null, sort = "cal_asc", page = 1, pageSize })">
                        <span class="label">Calories</span><span class="chev" aria-hidden="true">↕</span>
                    </a>
                </div>

                <!-- Available-only toggle -->
                <label class="switch ms-md-2 mt-2 mt-md-0" title="Show only available items">
                    <input id="availableOnly" type="checkbox" @(keepAvail ? "checked" : "") />
                    <span class="slider" aria-hidden="true"></span>
                    <span class="switch-label">Available only</span>
                </label>

                
            </div>
        </div>
    </div>

    <!-- Category bar (non-sticky) -->
    <nav id="categoryBar" class="category-index-wrap" aria-label="Categories">
        <div class="container">
            <div class="category-index">
                <a class="cat-chip @(string.IsNullOrEmpty(keepCat) ? "active" : "")"
                   href="@BaseUrl(new { q = keepQ, onlyAvailable = keepAvail ? (bool?)true : null, sort = keepSort, page = 1, pageSize })">
                    <span>All</span>
                    <span class="cat-count">@chips.Sum(c => (int)c.Count)</span>
                </a>

                @foreach (var c in chips)
                {
                    var active = keepCat == (string)c.CategoryId;
                    <a class="cat-chip @(active ? "active" : "")"
                       href="@BaseUrl(new { q = keepQ, categoryId = c.CategoryId, onlyAvailable = keepAvail ? (bool?)true : null, sort = keepSort, page = 1, pageSize })">
                        <span>@c.CategoryName</span>

                        <span class="cat-count">@c.Count</span>
                    </a>
                }
            </div>
        </div>
    </nav>

    <!-- GROUPED: current page slice, grouped by category -->
    @foreach (var g in groups)
    {
        <section class="mb-6 section-anchor" aria-label="@g.Key">
            <header class="section-head-min mb-3">
                <h3 class="section-title-min">
                    <span class="title-text">@g.Key</span>
                    <span class="title-count">@g.Count()</span>
                </h3>
                <a href="#top" class="back-to-top">Back to top</a>
            </header>

            <div class="row g-4 row-cols-1 row-cols-md-3">
                @foreach (var item in g)
                {
                    var isOn = item.IsAvailableForOrder;
                    <div class="col menu-col"
                         data-name="@Safe(item.MenuItemName)"
                         data-desc="@Safe(item.MenuItemDescription)"
                         data-category="@Safe(item.Category?.CategoryName)"
                         data-available="@(isOn ? "1" : "0")"
                         data-price="@item.MenuItemUnitPrice"
                         data-cal="@item.MenuItemCalories">
                        <a href="@Url.Action("Details", "Menu", new { id = item.MenuItemId })" class="menu-card-link">
                            <article class="card menu-card h-100 @(isOn ? "" : "is-off")">
                                @if (!isOn)
                                {
                                    <span class="ribbon" aria-hidden="true">Unavailable</span>
                                }
                                <div class="menu-img-wrap">
                                    <img src="@(string.IsNullOrWhiteSpace(item.MenuItemImageUrl) ? Url.Content("~/images/placeholder.png") : item.MenuItemImageUrl)"
                                         alt="@item.MenuItemName" loading="lazy" />
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-start justify-content-between gap-2">
                                        <h4 class="card-title m-0 title-clamp">@item.MenuItemName</h4>
                                        <span class="status-pill @(isOn ? "ok" : "no")">@((isOn ? "Available" : "Unavailable"))</span>
                                    </div>
                                    <p class="card-text text-muted desc desc-clamp">
                                        @(!string.IsNullOrWhiteSpace(item.MenuItemDescription) ? item.MenuItemDescription : "No description.")
                                    </p>
                                    <div class="meta mt-auto d-flex align-items-center justify-content-between">
                                        <span class="price-tag">RM @item.MenuItemUnitPrice.ToString("0.00")</span>
                                        @if (item.MenuItemCalories > 0)
                                        {
                                            <span class="kcal">@item.MenuItemCalories kcal</span>
                                        }
                                        else
                                        {
                                            <span class="kcal placeholder" aria-hidden="true">&nbsp;</span>
                                        }
                                    </div>
                                </div>
                            </article>
                        </a>
                    </div>
                }
            </div>
        </section>
    }

    <!-- Bottom pager -->
    @if (totalPages > 1)
    {
        <nav class="pager-wrap d-flex justify-content-center mt-4" aria-label="Menu pages">
            <ol class="pager list-unstyled d-inline-flex align-items-center m-0 p-1">
                @{
                    var windowStart = Math.Max(1, page - 2);
                    var windowEnd = Math.Min(totalPages, page + 2);
                    bool showFirst = windowStart > 1;
                    bool showLast = windowEnd < totalPages;
                }

                @if (showFirst)
                {
                    <li class="pager-item"><a class="pager-link" href="@PageUrl(1)">1</a></li>
                    @if (windowStart > 2)
                    {
                        <li class="pager-sep" aria-hidden="true">…</li>
                    }
                }

                @for (var i = windowStart; i <= windowEnd; i++)
                {
                    <li class="pager-item">
                        @if (i == page)
                        {
                            <span class="pager-link is-active" aria-current="page">@i</span>
                        }
                        else
                        {
                            <a class="pager-link" href="@PageUrl(i)">@i</a>
                        }
                    </li>
                }

                @if (showLast)
                {
                    @if (windowEnd < totalPages - 1)
                    {
                        <li class="pager-sep" aria-hidden="true">…</li>
                    }
                    <li class="pager-item"><a class="pager-link" href="@PageUrl(totalPages)">@totalPages</a></li>
                }

                <li class="pager-item ms-1">
                    <a class="pager-link pager-next @(page >= totalPages ? "disabled" : null)"
                       href="@(page >= totalPages ? "javascript:;" : PageUrl(page + 1))"
                       aria-label="Next page">
                        Next <span class="pager-chev" aria-hidden="true">›</span>
                    </a>
                </li>
            </ol>
        </nav>

        <div class="d-flex justify-content-center align-items-center gap-3 small text-muted mb-2">
            <span>Showing @(((page - 1) * pageSize) + 1) – @(Math.Min(page * pageSize, total)) of @total items</span>
            <form method="get" class="d-inline">
                <input type="hidden" name="q" value="@keepQ" />
                <input type="hidden" name="categoryId" value="@keepCat" />
                <input type="hidden" name="onlyAvailable" value="@(keepAvail ? "true" : "")" />
                <input type="hidden" name="sort" value="@keepSort" />
                <input type="hidden" name="page" value="1" />
                <label class="ms-1">
                    Per page:
                    <select name="pageSize" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
                        @foreach (var s in new[] { 9, 12, 18, 24, 36 })
                        {
                            <option value="@s" @(s == pageSize ? "selected" : "")>@s</option>
                        }
                    </select>
                </label>
            </form>
        </div>
    }
    else
    {
        <div class="text-center small text-muted my-3">
            Showing @total item(s) • Per page: @pageSize
        </div>
    }

    <div class="text-center mt-5">
        <a href="#top" class="back-to-top">Back to top</a>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const availableOnly = document.getElementById('availableOnly');
        availableOnly?.addEventListener('change', () => {
            const url = new URL(window.location.href);
            if (availableOnly.checked) url.searchParams.set('onlyAvailable', 'true');
            else url.searchParams.delete('onlyAvailable');
            url.searchParams.set('page','1');
            window.location.href = url.toString();
        });
    </script>
}

<style>
    :root {
        --ink: #000;
        --muted: #6b6b6b;
        --line: #e6e6e6;
        --font: -apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Segoe UI",Roboto,"Helvetica Neue",Arial,system-ui,sans-serif;
    }

    .menu-page, * {
        font-family: var(--font) !important;
        color: var(--ink);
    }

    .text-muted {
        color: #7a7a7a !important;
    }

    /* Inputs / buttons: monochrome */
    .input-mono {
        border: 1.5px solid #000;
        border-radius: 999px;
        padding: .65rem 1rem;
        font-weight: 600;
        background: #fff;
        outline: none;
    }

        .input-mono:focus {
            box-shadow: 0 0 0 3px rgba(0,0,0,.12);
            border-color: #000;
        }

    .btn-outline-dark {
        border: 1.5px solid #000;
        border-radius: 999px;
        font-weight: 700;
        background: #fff;
        color: #000;
    }

        .btn-outline-dark:hover {
            background: #000;
            color: #fff;
        }

    /* Sort pills */
    .sort3 {
        display: inline-flex;
        gap: .35rem;
        padding: .25rem;
        border: 1.5px solid #000;
        border-radius: 999px;
        background: #fff;
    }

    .sort3-pill {
        border: 1.5px solid transparent;
        background: #fff;
        color: #000;
        padding: .5rem .9rem;
        border-radius: 999px;
        font-weight: 700;
        text-decoration: none;
    }

        .sort3-pill.active {
            border-color: #000;
            font-weight: 800;
        }

    /* Toggle */
    .switch {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        cursor: pointer;
    }

        .switch input {
            display: none;
        }

        .switch .slider {
            width: 44px;
            height: 26px;
            border: 1.5px solid #000;
            border-radius: 999px;
            background: #fff;
            position: relative;
        }

            .switch .slider::after {
                content: "";
                position: absolute;
                top: 2px;
                left: 2px;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #000;
                transition: left .15s;
            }

        .switch input:checked + .slider::after {
            left: 20px;
        }

    /* Category chips (NON-STICKY) */
    .category-index-wrap {
        background: rgba(255,255,255,.96);
        border-bottom: 1px solid var(--line);
        box-shadow: 0 1px 0 rgba(0,0,0,.06);
    }

    .category-index {
        display: flex;
        flex-wrap: wrap;
        gap: .6rem;
        justify-content: center;
        padding: .5rem .25rem;
    }

    .cat-chip {
        display: inline-flex;
        align-items: center;
        gap: .55rem;
        padding: .45rem .9rem;
        border: 1.5px solid #000;
        border-radius: 999px;
        font-weight: 800;
        background: #fff;
        color: #000;
        text-decoration: none;
        transition: transform .08s ease, background .08s ease, color .08s ease;
    }

        .cat-chip:hover {
            transform: translateY(-1px);
        }

        .cat-chip.active {
            background: #000;
            border-color: #000;
            color: #fff !important;
        }

            .cat-chip.active *, .cat-chip.active:visited {
                color: #fff !important;
            }

    /* Sections */
    .section-head-min {
        text-align: center;
        position: relative;
        padding: .75rem 0 1rem;
    }

    .section-title-min {
        display: inline-flex;
        align-items: center;
        gap: .6rem;
        font-weight: 800;
        font-size: 1.15rem;
        position: relative;
    }

        .section-title-min::before, .section-title-min::after {
            content: "";
            height: 1px;
            width: 72px;
            background: var(--line);
            display: inline-block;
        }

    /* Cards */
    .menu-card-link {
        text-decoration: none;
        color: inherit;
    }

    .menu-card {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #fff;
        box-shadow: 0 8px 20px rgba(0,0,0,.05);
        transition: transform .15s ease, box-shadow .15s ease;
        position: relative;
        overflow: hidden;
    }

        .menu-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 32px rgba(0,0,0,.08);
        }

    .ribbon {
        position: absolute;
        top: 10px;
        left: -6px;
        background: #000;
        color: #fff;
        font-size: .7rem;
        font-weight: 700;
        padding: .18rem .55rem;
        transform: skew(-10deg);
    }

    .menu-img-wrap {
        aspect-ratio: 4/3;
        border-bottom: 1px solid var(--line);
        background: #f7f7f7;
    }

        .menu-img-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform .25s;
        }

    .menu-card:hover .menu-img-wrap img {
        transform: scale(1.03);
    }

    .title-clamp {
        font-size: 1.02rem;
        font-weight: 800;
        line-height: 1.28;
    }

    .desc-clamp {
        margin: .45rem 0 .7rem;
        font-size: .92rem;
        line-height: 1.45;
        color: #555;
        height: 3.9em;
        overflow: hidden;
    }

    .status-pill {
        font-size: .72rem;
        border: 1.25px solid #000;
        border-radius: 999px;
        padding: .16rem .55rem;
        font-weight: 800;
    }

        .status-pill.no {
            background: #000;
            color: #fff;
        }

    .meta {
        border-top: 1px solid var(--line);
        padding-top: .55rem;
    }

    .price-tag {
        border: 1.5px solid #000;
        border-radius: 999px;
        padding: .22rem .62rem;
        font-weight: 900;
        background: #fff;
        font-size: .95rem;
    }

    .kcal {
        border: 1.25px dashed #000;
        border-radius: 999px;
        padding: .16rem .5rem;
        font-size: .82rem;
    }

        .kcal.placeholder {
            opacity: 0;
        }

    .mb-6 {
        margin-bottom: 3rem !important;
    }

    /* Pager */
    .pager-wrap {
        user-select: none;
    }

    .pager {
        background: #f9f9f9;
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 4px;
    }

    .pager-item {
        margin: 0 2px;
    }

    .pager-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 32px;
        padding: 0 10px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        color: #000;
    }

        .pager-link:hover {
            text-decoration: underline;
        }

        .pager-link.is-active {
            color: #000;
            text-decoration: none;
            border-bottom: 2px solid #000;
            pointer-events: none;
        }

    .pager-sep {
        padding: 0 6px;
        color: #9a9a9a;
    }

    .pager-next {
        padding-right: 8px;
    }

        .pager-next .pager-chev {
            font-size: 18px;
            line-height: 0;
            margin-left: 2px;
        }

        .pager-next.disabled {
            color: #9a9a9a;
            pointer-events: none;
            text-decoration: none;
        }

    /* Back to top link: force black text */
    .menu-page .back-to-top,
    .menu-page .back-to-top:visited,
    .menu-page .back-to-top:hover,
    .menu-page .back-to-top:focus {
        color: #000 !important;
        text-decoration: none;
    }

        .menu-page .back-to-top:hover {
            text-decoration: underline; /* optional */
        }

</style>
