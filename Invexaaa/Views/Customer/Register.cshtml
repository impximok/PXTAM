@model SnomiAssignmentReal.Models.ViewModels.RegisterViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Register";
    ViewBag.HideHeader = true;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var siteKey = ViewBag.HCaptchaSiteKey as string ?? "";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css">

<div class="page">
    <div class="sheet">

        <!-- ⭐ FORM WRAPS BOTH PANELS ⭐ -->
        <form asp-action="Register" method="post" enctype="multipart/form-data" novalidate>
            @Html.AntiForgeryToken()

            <div class="grid">
                <!-- LEFT: Photo panel -->
                <section class="panel glass">
                    <h5 class="title">Profile Photo</h5>

                    <div class="avatar halo" id="avatarBox">
                        <img id="profilePreview"
                             src="data:image/gif;base64,R0lGODlhAQABAAAAACw="
                             alt=""
                             aria-label="Profile photo preview"
                             draggable="false">

                        <span class="avatar-ph" id="avatarPh">Preview</span>
                    </div>
                    <div class="muted center">Shown across your account</div>

                    <!-- Segmented control -->
                    <div class="seg">
                        <button type="button" class="seg-btn active" data-pane="pane-upload">Upload</button>
                        <button type="button" class="seg-btn" data-pane="pane-camera">Camera</button>
                    </div>

                    <!-- Upload pane -->
                    <div id="pane-upload" class="pane active">
                        <div id="dropzone" class="dropzone" tabindex="0" role="button" aria-label="Drop or choose a photo">
                            <input asp-for="ProfileImage" id="ProfileImage" type="file" accept="image/*" class="hidden" />
                            <div class="dz-body">
                                <div class="dz-icon">↑</div>
                                <div class="muted">Drag & drop an image here</div>
                                <button type="button" class="btn soft" onclick="document.getElementById('ProfileImage').click()">Choose File</button>
                                <div class="muted micro" style="margin-top:6px;">JPG / PNG / GIF · up to 2MB</div>
                            </div>
                        </div>
                        <span asp-validation-for="ProfileImage" class="val"></span>
                    </div>

                    <!-- Camera pane -->
                    <div id="pane-camera" class="pane">
                        <input type="hidden" asp-for="CapturedImageData" id="CapturedImageData" />

                        <div class="avatar live halo">
                            <video id="camVideo" autoplay playsinline muted></video>
                            <div id="camSpinner" class="spinner"></div>
                        </div>
                        <canvas id="camCanvas" class="hidden"></canvas>

                        <div id="camError" class="alert hidden"></div>
                        <div id="camHint" class="hint hidden">
                            Allow camera access in the browser prompt near the address bar.
                        </div>

                        <div class="row-actions">
                            <button type="button" class="btn soft" onclick="retakeShot()">Retake</button>
                            <button type="button" class="btn solid" onclick="captureShot()">Capture</button>
                        </div>
                    </div>
                </section>

                <!-- RIGHT: Form fields -->
                <section class="panel">
                    <h3 class="title-xl">Create account</h3>
                    <p class="muted">We keep it simple and secure.</p>

                    <div asp-validation-summary="All" class="val mb16"></div>

                    <!-- Identity -->
                    <div class="group">
                        <div class="row">
                            <div class="col">
                                <label asp-for="Name" class="label">Name</label>
                                <input asp-for="Name" class="input" />
                                <span asp-validation-for="Name" class="val"></span>
                            </div>
                            <div class="col">
                                <label asp-for="UserName" class="label">Username</label>
                                <input asp-for="UserName" class="input" />
                                <span asp-validation-for="UserName" class="val"></span>
                            </div>
                        </div>

                        <label asp-for="Email" class="label">Email</label>
                        <input asp-for="Email" class="input" />
                        <span asp-validation-for="Email" class="val"></span>
                    </div>

                    <div class="divider"></div>

                    <!-- Security -->
                    <div class="group">
                        <div class="row">
                            <div class="col">
                                <label asp-for="Password" class="label">Password</label>
                                <div class="password">
                                    <input asp-for="Password" id="Password" type="password" class="input padR" />
                                    <button type="button" class="eye" data-target="Password" aria-label="Show password">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="Password" class="val"></span>

                            </div>
                            <div class="col">
                                <label asp-for="ConfirmPassword" class="label">Confirm Password</label>
                                <div class="password">
                                    <input asp-for="ConfirmPassword" id="ConfirmPassword" type="password" class="input padR" />
                                    <button type="button" class="eye" data-target="ConfirmPassword" aria-label="Show password">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="ConfirmPassword" class="val"></span>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Contact -->
                    <div class="group">
                        <label asp-for="PhoneNumber" class="label">Phone Number</label>
                        <input asp-for="PhoneNumber" class="input" />
                        <span asp-validation-for="PhoneNumber" class="val"></span>
                    </div>

                    <div class="captcha">
                        <div class="h-captcha" data-sitekey="@siteKey"></div>
                        <small class="muted micro">Protected by hCaptcha.</small>
                    </div>

                    <button type="submit" class="btn solid w100 mt16">Create account</button>

                    <div class="center mt12">
                        <small>Already have an account? <a asp-action="Login" class="link">Log in</a></small>
                    </div>
                </section>
            </div> <!-- /grid -->

        </form> <!-- /form -->
    </div>
</div>

<!-- Photo Editor modal -->
<div class="cam-sheet" id="editSheet" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="cam-panel" role="document">
        <div class="cam-head">
            <h2 id="editTitle">Edit Photo</h2>
            <button type="button" class="icon-btn" id="closeEdit" aria-label="Close">×</button>
        </div>

        <div class="cam-body">
            <div id="editorWrap">
                <div id="cropBox"><img id="editImg" alt="Editor image"></div>

                <div class="range-wrap" style="margin-top:10px;">
                    <span class="muted micro">Zoom</span>
                    <input id="zoomRange" type="range" min="1" max="3" step="0.01" value="1">
                </div>

                <div class="toolbar">
                    <button type="button" class="btn soft" id="rotateLeft">⟲ Rotate Left</button>
                    <button type="button" class="btn soft" id="rotateRight">⟳ Rotate Right</button>
                    <button type="button" class="btn soft" id="resetBtn">Reset</button>
                </div>

                <div class="toolbar">
                    <button type="button" class="btn soft" id="editCancelBtn">Back</button>
                    <button type="button" class="btn solid" id="editUseBtn">Use Photo</button>
                </div>
            </div>

            <canvas id="capCanvas" width="512" height="512" hidden></canvas>
        </div>
    </div>
</div>


<style>
    /* ---------- Forced light theme (white background) ---------- */
    :root {
        --bg: #fff;
        --fg: #0a0a0a;
        --muted: #6b6b6f;
        --line: #e8e8ea;
        --ring: #1b1b1f;
        --elev: 0 1px 1px rgba(0,0,0,.04), 0 12px 28px rgba(0,0,0,.06);
    }

    * {
        box-sizing: border-box
    }

    html, body {
        background: #fff !important;
        color: var(--fg);
        font-family: ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    }

    a {
        color: inherit
    }

    .page {
        padding: 48px 16px
    }

    .sheet {
        max-width: 1120px;
        margin: 0 auto
    }

    .grid {
        display: grid;
        gap: 28px;
        grid-template-columns: 1fr
    }

    @@media (min-width:980px) {
        .grid {
            grid-template-columns: 440px 1fr
        }
    }

    .panel {
        border: 1px solid var(--line);
        border-radius: 22px;
        padding: 26px;
        background: #fff;
        box-shadow: var(--elev);
    }

    .glass {
        background: #fff
    }

    .title {
        font-weight: 600;
        margin: 0 0 16px;
        letter-spacing: .2px
    }

    .title-xl {
        font-weight: 700;
        font-size: 24px;
        margin: 0 0 6px
    }

    .muted {
        color: var(--muted);
        font-size: 14px
    }

    .micro {
        font-size: 12px
    }

    .center {
        text-align: center
    }

    .mb16 {
        margin-bottom: 16px
    }

    .mt12 {
        margin-top: 12px
    }

    .mt16 {
        margin-top: 16px
    }

    .mt-8 {
        margin-top: 8px
    }

    /* ---------- Avatar: always a circle ---------- */
    .avatar {
        --size: 200px;
        position: relative;
        width: var(--size);
        height: var(--size);
        margin: 12px auto 10px;
        border-radius: 50%;
        overflow: hidden;
        background: #f6f6f6;
        border: 0;
    }

        .avatar::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 50%;
            box-shadow: 0 0 0 1px var(--line), 0 8px 20px rgba(0,0,0,.06);
            pointer-events: none;
        }

        .avatar img,
        .avatar video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .avatar-ph {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        color: var(--muted);
        font-weight: 600;
        pointer-events: none;
        user-select: none;
    }

    .avatar.has-img .avatar-ph {
        display: none;
    }

    .avatar.halo {
        box-shadow: none !important;
    }

    /* ---------- Spinner (camera) ---------- */
    .spinner {
        position: absolute;
        inset: 0;
        margin: auto;
        width: 28px;
        height: 28px;
        border: 2px solid #bbb;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg)
        }
    }

    /* ---------- Segmented control ---------- */
    .seg {
        display: flex;
        gap: 8px;
        margin: 18px auto 10px;
        border: 1px solid var(--line);
        padding: 4px;
        border-radius: 14px;
        width: fit-content;
    }

    .seg-btn {
        appearance: none;
        border: 0;
        background: transparent;
        color: var(--muted);
        padding: 9px 16px;
        border-radius: 12px;
        font-size: 14px;
        cursor: pointer;
        transition: background .18s ease,color .18s ease,transform .06s ease;
    }

        .seg-btn:active {
            transform: translateY(1px)
        }

        .seg-btn.active {
            background: var(--fg);
            color: #fff
        }

    /* ---------- Panes ---------- */
    .pane {
        display: none
    }

        .pane.active {
            display: block
        }

    /* ---------- Dropzone ---------- */
    .dropzone {
        border: 1px dashed var(--muted);
        border-radius: 16px;
        background: transparent;
        padding: 24px;
        transition: border-color .2s, background-color .2s;
    }

        .dropzone.drag {
            border-color: var(--fg);
            background: rgba(0,0,0,.02)
        }

    .hidden {
        display: none !important
    }

    .dz-body {
        text-align: center
    }

    .dz-icon {
        font-size: 30px;
        margin-bottom: 6px
    }

    /* ---------- Form layout ---------- */
    .group {
        display: flex;
        flex-direction: column;
        gap: 12px
    }

    .divider {
        height: 1px;
        background: var(--line);
        margin: 18px 0;
        border-radius: 1px
    }

    .row {
        display: grid;
        gap: 16px;
        grid-template-columns: 1fr
    }

    @@media (min-width:720px) {
        .row {
            grid-template-columns: 1fr 1fr
        }
    }

    .col {
        display: flex;
        flex-direction: column
    }

    .label {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 8px
    }

    /* ---------- Inputs ---------- */
    .input {
        height: 48px;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 12px 14px;
        background: transparent;
        color: var(--fg);
        transition: border-color .15s ease, box-shadow .15s ease;
    }

        .input:focus {
            outline: none;
            border-color: color-mix(in srgb, var(--ring) 26%, transparent);
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--ring) 10%, transparent);
        }

    .password {
        position: relative
    }

    .padR {
        padding-right: 46px
    }

    .eye {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        border: 0;
        background: transparent;
        color: var(--muted);
        width: 34px;
        height: 34px;
        border-radius: 10px;
        cursor: pointer;
    }

        .eye:hover {
            color: var(--fg)
        }

    /* ---------- Validation ---------- */
    .val {
        display: block;
        color: #d11;
        font-size: 12px;
        margin-top: 6px
    }

    /* ---------- Buttons ---------- */
    .btn {
        appearance: none;
        border: 1px solid color-mix(in srgb, var(--fg) 70%, transparent);
        background: linear-gradient(to bottom, #fff, #f7f7f7);
        color: var(--fg);
        height: 42px;
        padding: 0 18px;
        border-radius: 9999px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: background .18s, color .18s, transform .06s, border-color .18s, box-shadow .18s;
    }

        .btn:hover {
            background: #f1f1f1
        }

        .btn:active {
            transform: translateY(1px)
        }

        .btn.solid {
            border-color: var(--fg);
            background: var(--fg);
            color: #fff
        }

            .btn.solid:hover {
                filter: brightness(0.95)
            }

        .btn.soft {
            border-color: var(--line);
            background: #fff
        }

    .w100 {
        width: 100%
    }

    .row-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 12px;
        flex-wrap: wrap
    }

    /* ---------- Notices ---------- */
    .alert {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 13px
    }

    .hint {
        border: 1px dashed var(--line);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 12px;
        color: var(--muted)
    }

    /* ---------- Links ---------- */
    .link {
        color: inherit;
        text-decoration: underline;
        text-underline-offset: 3px;
        text-decoration-thickness: 1px
    }

        .link:hover {
            text-decoration-thickness: 2px
        }

    /* ---------- Focus ring ---------- */
    :focus-visible {
        outline: none !important;
        box-shadow: 0 0 0 6px color-mix(in srgb, var(--ring) 14%, transparent);
        border-radius: 14px
    }

    /* =================== Editor modal =================== */
    html.no-scroll, body.no-scroll {
        overflow: hidden !important
    }

    .cam-sheet {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        padding: 16px;
        background: rgba(0,0,0,.35);
        opacity: 0;
        transition: opacity .18s ease;
        z-index: 99999;
    }

        .cam-sheet[aria-hidden="true"] {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important
        }

    .cam-panel {
        width: min(560px,96vw);
        max-height: min(92vh,820px);
        overflow: hidden;
        background: #fff;
        color: var(--fg);
        border: 1px solid var(--line);
        border-radius: 22px;
        box-shadow: var(--elev);
        padding: 16px;
        position: relative;
    }

    .cam-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px
    }

    .icon-btn {
        background: #fff;
        color: var(--muted);
        border: 1px solid var(--line);
        width: 34px;
        height: 34px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        .icon-btn:hover {
            color: var(--fg)
        }

    .cam-body {
        display: grid;
        gap: 12px;
        grid-template-rows: auto auto auto
    }

    /* Crop box */
    #cropBox {
        position: relative;
        width: min(420px,90vw);
        aspect-ratio: 1/1;
        margin: 0 auto;
        border: 1px solid var(--line);
        border-radius: 14px;
        overflow: hidden;
        background: #000;
        touch-action: none;
    }

        #cropBox img {
            user-select: none;
            -webkit-user-drag: none;
            position: absolute;
            left: 0;
            top: 0;
            transform-origin: 0 0;
            will-change: transform;
        }

    .toolbar {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap
    }

    .range-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center
    }

    #zoomRange {
        width: 260px;
        height: 6px
    }

    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent
    }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 4px;
            background: var(--line);
            border-radius: 999px
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #111;
            margin-top: -7px;
        }

        input[type="range"]::-moz-range-track {
            height: 4px;
            background: var(--line);
            border-radius: 999px
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #111;
            border: 0
        }

    .cam-panel .btn {
        height: 38px;
        padding: 0 14px
    }

    #editorWrap .toolbar + .toolbar {
        margin-top: 16px
    }
</style>



@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>

    <script>
        (function () {
            'use strict';

            /* ---------------- Segmented control ---------------- */
            const segBtns = document.querySelectorAll('.seg-btn');
            segBtns.forEach(b => b.addEventListener('click', () => {
                segBtns.forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
                document.getElementById(b.dataset.pane).classList.add('active');
                if (b.dataset.pane === 'pane-camera') startCamSafe(); else stopCam();
            }));

            /* ---------------- Upload / Dropzone ---------------- */
            const dz = document.getElementById('dropzone');
            const fileInput = document.getElementById('ProfileImage');
            const previewImg = document.getElementById('profilePreview');
            const capturedInput = document.getElementById('CapturedImageData');
            const avatarBox = document.getElementById('avatarBox');

            function updateAvatarPlaceholder() {
                const hasImage = previewImg.complete && previewImg.naturalWidth > 0;
                avatarBox.classList.toggle('has-img', hasImage);
            }
            previewImg.addEventListener('load', updateAvatarPlaceholder);
            previewImg.addEventListener('error', () => avatarBox.classList.remove('has-img'));
            updateAvatarPlaceholder();

            function handleFile(file) {
                if (!file) return;
                if (!/^image\/(png|jpe?g|gif|webp)$/i.test(file.type || '')) { alert('Please use JPG, PNG, GIF or WEBP (≤2MB).'); return; }
                const fr = new FileReader();
                fr.onload = ev => startEditor(ev.target.result);
                fr.readAsDataURL(file);
            }

            fileInput.addEventListener('change', e => handleFile(e.target.files?.[0]));
            ['dragenter', 'dragover'].forEach(evt => dz.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); dz.classList.add('drag'); }));
            ['dragleave', 'dragend', 'drop'].forEach(evt => dz.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('drag'); }));
            dz.addEventListener('drop', e => handleFile(e.dataTransfer?.files?.[0]));
            dz.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); } });

            document.addEventListener('paste', e => {
                const item = Array.from(e.clipboardData?.items || []).find(i => i.type?.startsWith('image/'));
                const f = item?.getAsFile(); if (f) handleFile(f);
            });

            /* ---------------- Password toggles ---------------- */
            document.querySelectorAll('.eye').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-target');
                    const input = document.getElementById(id);
                    const icon = btn.querySelector('i');
                    const show = input.type === 'password';
                    input.type = show ? 'text' : 'password';
                    icon.classList.toggle('bi-eye', !show);
                    icon.classList.toggle('bi-eye-slash', show);
                    btn.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
                });
            });

            /* ---------------- Camera ---------------- */
            let camStream = null;
            const vid = document.getElementById('camVideo');
            const cvs = document.getElementById('camCanvas');
            const spin = document.getElementById('camSpinner');
            const errBox = document.getElementById('camError');
            const hint = document.getElementById('camHint');

            function showErr(msg) { errBox.textContent = msg; errBox.classList.remove('hidden'); }
            function clearErr() { errBox.textContent = ""; errBox.classList.add('hidden'); }
            function showHint() { hint.classList.remove('hidden'); }
            function hideHint() { hint.classList.add('hidden'); }

            async function startCamSafe() {
                clearErr(); hideHint();
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') { showErr("Use HTTPS or localhost for camera access."); return; }
                spin.style.display = 'block';
                try { await getStream(); } catch (e) { showErr("Camera error: " + (e.message || e)); showHint(); }
                finally { spin.style.display = 'none'; }
            }
            function stopCam() {
                hideHint(); clearErr();
                if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; }
                if (vid.srcObject) vid.srcObject = null;
            }
            async function getStream() {
                stopCam();
                const attempts = [
                    { video: { facingMode: { ideal: 'user' }, width: { ideal: 720 }, height: { ideal: 720 } }, audio: false },
                    { video: true, audio: false }
                ];
                let lastErr = null;
                for (const c of attempts) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia(c);
                        camStream = stream;
                        vid.srcObject = stream; vid.setAttribute('playsinline', ''); vid.setAttribute('autoplay', ''); vid.setAttribute('muted', ''); vid.muted = true;
                        try { await vid.play(); } catch { await new Promise(r => setTimeout(r, 60)); await vid.play(); }
                        let tries = 0; const t = setInterval(() => {
                            tries++; if (vid.videoWidth) { clearInterval(t); hideHint(); }
                            else if (tries === 10) showHint(); else if (tries > 40) { clearInterval(t); showErr("No frames. Check permissions."); }
                        }, 50);
                        return;
                    } catch (e) { lastErr = e; }
                }
                throw lastErr || new Error("No camera available or permission denied.");
            }

            window.captureShot = function () {
                if (!vid.videoWidth) { showErr("Camera not ready."); return; }
                cvs.width = vid.videoWidth;
                cvs.height = vid.videoHeight;
                const ctx = cvs.getContext('2d');
                ctx.drawImage(vid, 0, 0, cvs.width, cvs.height);
                const dataUrl = cvs.toDataURL("image/jpeg", 0.95);
                startEditor(dataUrl);
                stopCam();
            };

            window.retakeShot = async function () {
                cvs.width = cvs.height = 0;
                const hidden = document.getElementById('CapturedImageData');
                if (hidden) hidden.value = "";
                await startCamSafe();
            };

            /* ---------------- Simple modal helpers ---------------- */
            const editSheet = document.getElementById('editSheet');
            const closeEdit = document.getElementById('closeEdit');
            function lockScroll(on) { document.documentElement.classList.toggle('no-scroll', !!on); document.body.classList.toggle('no-scroll', !!on); }
            function showSheet() { editSheet.style.display = 'grid'; editSheet.style.opacity = 1; editSheet.setAttribute('aria-hidden', 'false'); lockScroll(true); }
            function hideSheet() { editSheet.setAttribute('aria-hidden', 'true'); editSheet.style.display = 'none'; editSheet.style.opacity = 0; lockScroll(false); }

            closeEdit?.addEventListener('click', hideSheet);
            editSheet?.addEventListener('click', (e) => { if (e.target === editSheet) hideSheet(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && editSheet.getAttribute('aria-hidden') === 'false') hideSheet(); });

            /* ---------------- Editor (crop/zoom/rotate) ---------------- */
            const cropBox = document.getElementById('cropBox');
            const editImg = document.getElementById('editImg');
            const zoomRange = document.getElementById('zoomRange');
            const rotateLeft = document.getElementById('rotateLeft');
            const rotateRight = document.getElementById('rotateRight');
            const resetBtn = document.getElementById('resetBtn');
            const editCancel = document.getElementById('editCancelBtn');
            const editUse = document.getElementById('editUseBtn');
            const capCanvas = document.getElementById('capCanvas');
            const gtx = capCanvas.getContext('2d');

            let imgW = 0, imgH = 0, zoom = 1, minZoom = 1, maxZoom = 3, offsetX = 0, offsetY = 0, dragging = false, startX = 0, startY = 0;
            let baseDataUrl = null;

            function resetEditorState() {
                editImg.style.width = ''; editImg.style.height = ''; editImg.style.transform = 'translate(0px,0px)';
                imgW = imgH = 0; zoom = 1; minZoom = 1; offsetX = offsetY = 0; dragging = false;
            }

            function startEditor(dataUrl) {
                baseDataUrl = dataUrl;
                resetEditorState();
                editImg.src = ''; requestAnimationFrame(() => { editImg.src = dataUrl; });
                showSheet();

                editImg.onload = () => {
                    imgW = editImg.naturalWidth || 0; imgH = editImg.naturalHeight || 0;
                    if (!imgW || !imgH) return;
                    initLayout();
                };
            }

            function initLayout() {
                const boxSize = cropBox.getBoundingClientRect().width || 0;
                if (!boxSize) { requestAnimationFrame(initLayout); return; }

                const zX = boxSize / imgW, zY = boxSize / imgH;
                minZoom = Math.max(zX, zY);
                zoom = Math.max(minZoom, 1);

                offsetX = (boxSize - imgW * zoom) / 2;
                offsetY = (boxSize - imgH * zoom) / 2;

                zoomRange.min = String(Math.min(minZoom, maxZoom).toFixed(2));
                zoomRange.max = String(maxZoom);
                zoomRange.value = String(Math.min(Math.max(zoom, minZoom), maxZoom).toFixed(2));

                render();

                const startDrag = (x, y) => { dragging = true; startX = x - offsetX; startY = y - offsetY; };
                const moveDrag = (x, y) => { if (!dragging) return; offsetX = x - startX; offsetY = y - startY; render(); };
                const endDrag = () => { dragging = false; };

                cropBox.onmousedown = e => { e.preventDefault(); startDrag(e.clientX, e.clientY); };
                window.onmousemove = e => moveDrag(e.clientX, e.clientY);
                window.onmouseup = endDrag;

                cropBox.ontouchstart = e => { const t = e.touches[0]; startDrag(t.clientX, t.clientY); };
                cropBox.ontouchmove = e => { const t = e.touches[0]; moveDrag(t.clientX, t.clientY); };
                cropBox.ontouchend = endDrag;

                cropBox.onwheel = (e) => {
                    e.preventDefault();
                    const delta = -Math.sign(e.deltaY) * 0.08;
                    const prev = zoom;
                    zoom = Math.max(minZoom, Math.min(maxZoom, zoom + delta));
                    const rect = cropBox.getBoundingClientRect();
                    const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
                    offsetX = cx - ((cx - offsetX) * (zoom / prev));
                    offsetY = cy - ((cy - offsetY) * (zoom / prev));
                    zoomRange.value = String(zoom.toFixed(2));
                    render();
                };

                zoomRange.oninput = () => {
                    const prev = zoom;
                    zoom = Math.max(minZoom, Math.min(maxZoom, parseFloat(zoomRange.value) || minZoom));
                    const cx = boxSize / 2, cy = boxSize / 2;
                    offsetX = cx - ((cx - offsetX) * (zoom / prev));
                    offsetY = cy - ((cy - offsetY) * (zoom / prev));
                    render();
                };
            }

            function clampOffsets(boxSize, drawW, drawH) {
                if (drawW <= boxSize) { offsetX = (boxSize - drawW) / 2; }
                else { const minX = boxSize - drawW; offsetX = Math.min(0, Math.max(offsetX, minX)); }
                if (drawH <= boxSize) { offsetY = (boxSize - drawH) / 2; }
                else { const minY = boxSize - drawH; offsetY = Math.min(0, Math.max(offsetY, minY)); }
            }

            function render() {
                const boxSize = cropBox.getBoundingClientRect().width || 0;
                if (!boxSize || !imgW || !imgH) return;
                zoom = Math.max(minZoom, Math.min(maxZoom, zoom));

                const drawW = imgW * zoom, drawH = imgH * zoom;
                clampOffsets(boxSize, drawW, drawH);

                editImg.style.width = drawW + 'px';
                editImg.style.height = drawH + 'px';
                editImg.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
            }

            async function rotateDataUrl(src, deg) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        const r = (deg % 360 + 360) % 360, swap = (r === 90 || r === 270);
                        const w = img.naturalWidth, h = img.naturalHeight, cw = swap ? h : w, ch = swap ? w : h;
                        const c = document.createElement('canvas'); c.width = cw; c.height = ch; const g = c.getContext('2d');
                        g.translate(cw / 2, ch / 2); g.rotate(r * Math.PI / 180); g.drawImage(img, -w / 2, -h / 2);
                        resolve(c.toDataURL('image/jpeg', 0.95));
                    };
                    img.onerror = reject; img.src = src;
                });
            }

            document.getElementById('rotateLeft')?.addEventListener('click', async () => { baseDataUrl = await rotateDataUrl(baseDataUrl, -90); startEditor(baseDataUrl); });
            document.getElementById('rotateRight')?.addEventListener('click', async () => { baseDataUrl = await rotateDataUrl(baseDataUrl, 90); startEditor(baseDataUrl); });
            document.getElementById('resetBtn')?.addEventListener('click', () => startEditor(baseDataUrl));

            function exportCrop() {
                const boxSize = cropBox.getBoundingClientRect().width;
                const out = 512; capCanvas.width = out; capCanvas.height = out;

                const s = zoom;
                const srcX = Math.max(0, (-offsetX) / s), srcY = Math.max(0, (-offsetY) / s);
                const srcW = Math.min(imgW - srcX, boxSize / s), srcH = Math.min(imgH - srcY, boxSize / s);

                gtx.fillStyle = '#fff'; gtx.fillRect(0, 0, out, out); gtx.imageSmoothingQuality = 'high';
                gtx.drawImage(editImg, srcX, srcY, srcW, srcH, 0, 0, out, out);
                return capCanvas.toDataURL('image/jpeg', 0.95);
            }

            document.getElementById('editCancelBtn')?.addEventListener('click', hideSheet);

            document.getElementById('editUseBtn')?.addEventListener('click', () => {
                const dataUrl = exportCrop();
                capturedInput.value = dataUrl;
                if (fileInput) fileInput.value = '';
                previewImg.src = dataUrl;
                avatarBox.classList.add('has-img');
                hideSheet();
            });
        })();

        // Try to use your real default only if it exists
        (function () {
            const preview = document.getElementById('profilePreview');
            const DEFAULT = '/images/default-profile.png';

            const probe = new Image();
            probe.onload = () => { preview.src = DEFAULT; };
            probe.onerror = () => { /* keep inline placeholder */ };
            probe.src = DEFAULT;
        })();
    </script>
}
