@model SnomiAssignmentReal.Models.ViewModels.LoginVm
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Sign In";
    ViewBag.HideHeader = true;
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Flags for smarter error rendering
    var isPost = string.Equals(Context.Request.Method, "POST", StringComparison.OrdinalIgnoreCase);
    var hasModelErrors = ViewData.ModelState.ContainsKey(string.Empty)
                         && (ViewData.ModelState[string.Empty]?.Errors?.Count ?? 0) > 0; // "" = model-level errors
}

<div class="auth-wrap">
    <div class="auth-card" role="region" aria-labelledby="authTitle">
        <div class="auth-head">
            <h1 id="authTitle">Log In</h1>
            <p>Authorized personnel only. Please log in below.</p>
        </div>

        @* Top error summary: show only for model-level or TempData errors *@
        @if (isPost && (hasModelErrors || TempData["Error"] != null))
        {
            <div class="auth-alert" role="alert" aria-live="polite">
                @if (hasModelErrors)
                {
                    <div asp-validation-summary="ModelOnly"></div>
                }
                @if (TempData["Error"] != null)
                {
                    <div>@TempData["Error"]</div>
                }
            </div>
        }

        <form asp-action="Login" method="post" class="auth-form" novalidate>
            @Html.AntiForgeryToken()

            <div class="field">
                <label asp-for="Email">Email address</label>
                <input asp-for="Email" type="email" class="input" placeholder="you@example.com" aria-required="true" />
                <span asp-validation-for="Email" class="field-error" role="alert"></span>
            </div>

            <div class="field">
                <label asp-for="Password">Password</label>
                <div class="input-with-toggle">
                    <input asp-for="Password" id="Password" type="password" class="input" placeholder="••••••••" aria-required="true" />
                    <button type="button" id="togglePassword" class="toggle" aria-label="Show/Hide password" tabindex="-1">👁</button>
                </div>
                <span asp-validation-for="Password" class="field-error" role="alert"></span>
            </div>

            @* hCaptcha *@
            <div class="captcha-wrap" aria-live="polite">
                <div class="h-captcha" data-sitekey="@ViewBag.HCaptchaSiteKey"></div>
            </div>

            <button type="submit" name="guest" value="1" class="btn btn-ghost">👤 Continue as Guest</button>
            <button type="submit" class="btn btn-primary">Log In</button>

            <div class="misc">
                <label class="remember">
                    <input asp-for="RememberMe" />
                    <span>Remember Me</span>
                </label>

                <a asp-controller="Customer" asp-action="ResetPassword" class="link">Forgot password?</a>
            </div>
        </form>

        <!-- Register CTA (underlined text only) -->
        <div class="sep" aria-hidden="true"></div>
        <div class="register-cta" aria-live="polite">
            <p class="register-text">
                Don’t have an account?
                <a asp-controller="Customer" asp-action="Register" class="link-register">Register here</a>
                @* If your route is Account/Register, change asp-controller/action above *@
            </p>
        </div>
        <!-- /Register CTA -->

        <div class="back">
            <a href="~/" class="link">← Back to Home</a>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://hcaptcha.com/1/api.js" async defer></script>
    <script>
        // Password show/hide
        const pwd = document.getElementById('Password');
        const btn = document.getElementById('togglePassword');
        btn?.addEventListener('click', () => {
            const isPwd = pwd.type === 'password';
            pwd.type = isPwd ? 'text' : 'password';
            btn.textContent = isPwd ? '🙈' : '👁';
        });

        // Optional: prevent double submit
        const form = document.querySelector('form.auth-form');
        form?.addEventListener('submit', () => {
            form.querySelectorAll('button[type="submit"]').forEach(b => b.disabled = true);
            setTimeout(() => form.querySelectorAll('button[type="submit"]').forEach(b => b.disabled = false), 3000);
        });
    </script>
}

<style>
    :root {
        /* SINGLE Apple light gray background across the whole page */
        --bg: #f5f5f7;
        --card: #ffffff;
        --ink: #0a0a0a;
        --muted: #6b6b6b;
        --line: #e6e6e6;
        --radius: 18px;
        --shadow: 0 8px 30px rgba(0, 0, 0, .06);
        --danger: #7a1f1f;
        --danger-bg: #fdecec;
        --danger-br: #f0c2c2;
    }

    /* Ensure no other container from _Layout/Bootstrap paints a different color */
    html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: var(--bg) !important; /* keep it light Apple gray */
        background-image: none !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    /* Neutralize common wrappers/helpers that often add a second tone */
    main, #main, .main,
    .page, #page, .page-wrap,
    .container, .container-fluid,
    .content, .content-wrapper, .site-content,
    .layout, .layout-body, .wrapper, .app,
    #Content, #RenderBody, #renderBody,
    .bg-white, .bg-light, .bg-body, .bg-body-tertiary {
        background: var(--bg) !important;
        background-image: none !important;
    }

    .auth-wrap {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg) !important; /* same gray as body to avoid two-tone */
        padding: 32px 16px;
    }

    .auth-card {
        width: min(500px, 100%);
        background: var(--card); /* white card on gray background */
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 32px 28px;
    }

    .auth-head {
        text-align: center;
        margin-bottom: 20px;
    }

        .auth-head h1 {
            font-size: 32px;
            margin: 0 0 6px;
            color: var(--ink);
            font-weight: 700;
        }

        .auth-head p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

    /* Top error summary (only rendered when not empty) */
    .auth-alert {
        border: 1px solid var(--danger-br);
        background: var(--danger-bg);
        color: var(--danger);
        border-radius: 12px;
        padding: 12px 14px;
        font-size: 14px;
        margin-bottom: 16px;
    }

        .auth-alert:empty {
            display: none;
        }
    /* never show an empty pink bar */

    .auth-form {
        display: grid;
        gap: 16px;
    }

    .field label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 14px;
        color: var(--ink);
    }

    .input {
        width: 100%;
        height: 50px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        color: var(--ink);
        padding: 0 14px;
        outline: none;
        font-size: 15px;
    }

        .input:focus {
            border-color: #000;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, .07);
        }

    .input-with-toggle {
        position: relative;
    }

        .input-with-toggle .toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #666;
        }

            .input-with-toggle .toggle:hover {
                color: #000;
            }

    /* Field-level validation message */
    .field-error {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        color: var(--danger);
    }

    /* When input is invalid (unobtrusive validation adds this class) */
    input.input.input-validation-error {
        border-color: #e39b9b;
        box-shadow: 0 0 0 3px rgba(227,155,155,.25);
        background: #fff7f7;
    }

    /* Keep captcha area from introducing a lighter patch */
    .captcha-wrap {
        display: flex;
        justify-content: center;
        padding: 8px 0;
        background: transparent !important; /* kill tone change */
        border-radius: 12px;
        border: 0 !important;
        box-shadow: none !important;
    }

    .btn {
        width: 100%;
        height: 48px;
        border-radius: 999px;
        font-weight: 600;
        border: 2px solid #000;
        cursor: pointer;
        transition: all .2s;
    }

    .btn-primary {
        background: #000;
        color: #fff;
    }

        .btn-primary:hover {
            background: #fff;
            color: #000;
        }

    .btn-ghost {
        background: #fff;
        color: #000;
        margin-top: 2px;
    }

        .btn-ghost:hover {
            background: #000;
            color: #fff;
        }

    .misc {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        font-size: 14px;
    }

    .remember {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--muted);
    }

    .link {
        color: #444;
        text-underline-offset: 3px;
    }

        .link:hover {
            color: #000;
            text-decoration: underline;
        }

    /* Divider + Register (underlined text link) */
    .sep {
        height: 1px;
        background: var(--line);
        margin: 18px 0 14px;
    }

    .register-cta {
        text-align: center;
        margin: 14px 0;
    }

    .register-text {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
    }

    .link-register {
        color: #000;
        text-decoration: underline;
        text-underline-offset: 3px;
        font-weight: 600;
        transition: color .2s ease;
    }

        .link-register:hover {
            color: #555;
        }

    .back {
        margin-top: 16px;
        text-align: center;
    }
</style>
