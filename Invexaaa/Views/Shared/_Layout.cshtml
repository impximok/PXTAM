@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.AspNetCore.Http
@using System.IO
@using System.Linq

@{
    Layout = null;

    // ONE FLAG CONTROLS EVERYTHING
    bool hideHeader = ViewBag.HideHeader == true;

    var isAuth = User?.Identity?.IsAuthenticated == true;
    var isGuest = !isAuth;
    if (isAuth) { Context.Session.Remove("IsGuest"); }

    bool isAdmin = isAuth && (User.IsInRole("Admin") || User.IsInRole("UR100"));
    bool isStaff = isAuth && (User.IsInRole("Staff") || User.IsInRole("UR101"));
    bool isCustomer = isAuth && User.IsInRole("Customer");

    var sessionUserName = Context.Session.GetString("CustomerUserName");

    var profileName = isAuth
        ? (!string.IsNullOrWhiteSpace(sessionUserName)
            ? sessionUserName
            : (User.Identity!.Name ?? "User"))
        : "Guest";

    var claimPhoto = User.FindFirst("photo")?.Value;
    var sessionPhoto = Context.Session.GetString("CustomerPhotoUrl");
    var vbPhoto = ViewBag.ProfilePhotoUrl as string;

    var profilePhoto =
        !string.IsNullOrWhiteSpace(vbPhoto) ? vbPhoto :
        !string.IsNullOrWhiteSpace(sessionPhoto) ? sessionPhoto :
        !string.IsNullOrWhiteSpace(claimPhoto) ? claimPhoto :
        "/images/default-profile.jpg";

    string InitialsOf(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "U";
        var p = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return p.Length == 1
            ? p[0][..1].ToUpper()
            : $"{p[0][0]}{p[^1][0]}".ToUpper();
    }

    var initials = InitialsOf(profileName);
    var slogan = (ViewBag.Slogan as string) ?? "Inventory, Precisely.";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - Invexa</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
          rel="stylesheet" />

    <style>
        body.snomi-ppg-body {
            background: #fff;
            font-family: Inter, system-ui, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .snomi-header {
            position: sticky;
            top: 0;
            z-index: 1030;
            background: #fff;
            border-bottom: 1px solid #e9e9e9;
        }

        .snomi-header-inner {
            padding: 10px 1.5cm;
            min-height: 64px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
        }

        .brand-link {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
        }

        .brand-logo {
            height: 42px;
        }

        .brand-slogan {
            font-size: .8rem;
            color: #666;
        }

        .profile-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            border: 1px solid #e9e9e9;
            border-radius: 999px;
            text-decoration: none;
            color: inherit;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar-fallback {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #111;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        /* LAYOUT */
        .invexa-layout {
            display: flex;
            flex: 1;
        }

        .invexa-content {
            flex: 1;
            padding: 30px;
            background: #f5f6f8;
        }

        /* FOOTER (CENTERED & MINIMAL) */
        .invexa-footer {
            background: #fff;
            border-top: 1px solid #e9e9e9;
            padding: 16px 12px;
            font-size: 0.85rem;
        }

        .invexa-footer-center {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #6b7280;
            text-align: center;
            flex-wrap: wrap;
        }

        .invexa-footer-brand {
            font-weight: 600;
            color: #111;
        }

        .invexa-footer-sep {
            opacity: .6;
        }

        .invexa-footer-desc {
            white-space: nowrap;
        }

        .invexa-footer-year {
            opacity: .7;
        }

    </style>
</head>

<body class="snomi-ppg-body">

    @if (!hideHeader)
    {
        <!-- HEADER -->
        <header class="snomi-header">
            <div class="snomi-header-inner">
                <a href="#" class="brand-link">
                    <img src="/images/InvexaLogoCropped.png" class="brand-logo" />
                    <span class="brand-slogan">@slogan</span>
                </a>

                <div></div>

                <a href="#" class="profile-pill">
                    <span>@profileName</span>
                    @if (!string.IsNullOrWhiteSpace(profilePhoto))
                    {
                        <img src="@profilePhoto" class="avatar" />
                    }
                    else
                    {
                        <span class="avatar-fallback">@initials</span>
                    }
                </a>
            </div>
        </header>
    }

    @if (!hideHeader)
    {
        <!-- NORMAL LAYOUT -->
        <div class="invexa-layout">
            @await Html.PartialAsync("_SideMenu")

            <main class="invexa-content">
                @RenderBody()
            </main>
        </div>
    }
    else
    {
        <!-- FULLSCREEN PAGE (NO HEADER / SIDEMENU / FOOTER) -->
        <main>
            @RenderBody()
        </main>
    }

    @if (!hideHeader)
    {
        <footer class="invexa-footer">
            <div class="invexa-footer-center">
                <span class="invexa-footer-brand">Invexa</span>
                <span class="invexa-footer-sep">—</span>
                <span class="invexa-footer-desc">
                    Smart inventory, expiry tracking, and demand forecasting
                </span>
                <span class="invexa-footer-year">
                    © @DateTime.Now.Year
                </span>
            </div>
        </footer>
    }



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("Scripts", required: false)

</body>
</html>
