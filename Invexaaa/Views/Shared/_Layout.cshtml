@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.AspNetCore.Http
@using System.IO
@using System.Linq

@{
    Layout = null;

    // ===============================
    // PAGE FLAGS
    // ===============================
    bool hideHeader = ViewBag.HideHeader == true;

    // ===============================
    // AUTHENTICATION
    // ===============================
    var isAuth = User?.Identity?.IsAuthenticated == true;
    var isGuest = !isAuth;

    if (isAuth)
    {
        Context.Session.Remove("IsGuest");
    }

    // ===============================
    // ROLES (ADMIN / MANAGER / STAFF)
    // ===============================
    bool isAdmin = isAuth && (User.IsInRole("Admin") || User.IsInRole("UR100"));
    bool isManager = isAuth && (User.IsInRole("Manager") || User.IsInRole("UR102"));
    bool isStaff = isAuth && (User.IsInRole("Staff") || User.IsInRole("UR101"));

    bool isEmployee = isAdmin || isManager || isStaff;

    // ===============================
    // PROFILE NAME
    // ===============================
    var sessionUserName = Context.Session.GetString("UserFullName");

    var profileName = isAuth
        ? (!string.IsNullOrWhiteSpace(sessionUserName)
            ? sessionUserName
            : (User.Identity?.Name ?? "User"))
        : "Guest";

    // ===============================
    // PROFILE PHOTO
    // ===============================
    var claimPhoto = User.FindFirst("photo")?.Value;
    var sessionPhoto = Context.Session.GetString("UserProfilePhoto");
    var vbPhoto = ViewBag.ProfilePhotoUrl as string;

    var profilePhoto =
        !string.IsNullOrWhiteSpace(vbPhoto) ? vbPhoto :
        !string.IsNullOrWhiteSpace(sessionPhoto) ? sessionPhoto :
        !string.IsNullOrWhiteSpace(claimPhoto) ? claimPhoto :
        "/images/default-profile.jpg";

    // ===============================
    // INITIALS FALLBACK
    // ===============================
    string InitialsOf(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "U";
        var p = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return p.Length == 1
            ? p[0][..1].ToUpper()
            : $"{p[0][0]}{p[^1][0]}".ToUpper();
    }

    var initials = InitialsOf(profileName);
    var slogan = (ViewBag.Slogan as string) ?? "Inventory, Precisely.";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - Invexa</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
          rel="stylesheet" />

    <style>
        body.invexa-body {
            background: #fff;
            font-family: Inter, system-ui, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .invexa-header {
            position: sticky;
            top: 0;
            z-index: 1030;
            background: #fff;
            border-bottom: 1px solid #e9e9e9;
        }

        .invexa-header-inner {
            padding: 10px 1.5cm;
            min-height: 64px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
        }

        .brand-link {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
        }

        .brand-logo {
            height: 42px;
        }

        .brand-slogan {
            font-size: .8rem;
            color: #666;
        }

        .profile-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            border: 1px solid #e9e9e9;
            border-radius: 999px;
            text-decoration: none;
            color: inherit;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar-fallback {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #111;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        /* LAYOUT */
        .invexa-layout {
            display: flex;
            flex: 1;
        }

        .invexa-content {
            flex: 1;
            padding: 30px;
            background: #f5f6f8;
        }

        /* FOOTER */
        .invexa-footer {
            background: #fff;
            border-top: 1px solid #e9e9e9;
            padding: 16px 12px;
            font-size: 0.85rem;
        }

        .invexa-footer-center {
            display: flex;
            flex-direction: column; /* 🔥 THIS is the key */
            align-items: center;
            justify-content: center;
            gap: 2px;
            color: #6b7280;
            text-align: center;
        }


        .invexa-footer-brand {
            font-weight: 600;
            color: #111;
        }

        .invexa-footer-sep {
            opacity: .6;
        }

        .invexa-footer-desc {
            white-space: nowrap;
        }

        .invexa-footer-year {
            opacity: .7;
        }

        .invexa-footer-link {
            color: #6b7280;
            text-decoration: none;
            font-weight: 500;
        }

            .invexa-footer-link:hover {
                color: #111;
                text-decoration: underline;
                text-underline-offset: 2px;
            }

        .invexa-footer-line {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
            color: #6b7280;
        }

        .invexa-footer-links {
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .invexa-footer-link {
            color: #6b7280;
            text-decoration: none;
            font-weight: 500;
        }

            .invexa-footer-link:hover {
                color: #111;
                text-decoration: underline;
                text-underline-offset: 2px;
            }

        .invexa-footer-year {
            margin-left: 4px;
            opacity: 0.7;
        }


    </style>
</head>

<body class="invexa-body">

    @if (!hideHeader)
    {
        <!-- HEADER -->
        <header class="invexa-header">
            <div class="invexa-header-inner">

                <a asp-controller="Dashboard"
                   asp-action="Index"
                   class="brand-link">
                    <img src="/images/InvexaLogoCropped.png" class="brand-logo" />
                    <span class="brand-slogan">@slogan</span>
                </a>

                <div></div>

                @if (isEmployee)
                {
                    <a asp-controller="User"
                       asp-action="UpdateProfile"
                       class="profile-pill">

                        <span>@profileName</span>

                        @if (!string.IsNullOrWhiteSpace(profilePhoto))
                        {
                            <img src="@profilePhoto" class="avatar" />
                        }
                        else
                        {
                            <span class="avatar-fallback">@initials</span>
                        }
                    </a>
                }

            </div>
        </header>
    }

    @if (!hideHeader)
    {
        <div class="invexa-layout">
            @if (isEmployee)
            {
                @await Html.PartialAsync("_SideMenu")
            }

            <main class="invexa-content">
                @RenderBody()
            </main>
        </div>
    }
    else
    {
        <main>
            @RenderBody()
        </main>
    }

    @if (!hideHeader)
    {
        <footer class="invexa-footer">
            <div class="invexa-footer-center">

                <!-- Line 1 -->
                <div class="invexa-footer-line">
                    <span class="invexa-footer-brand">Invexa</span>
                    <span class="invexa-footer-sep">—</span>
                    <span class="invexa-footer-desc">
                        Smart inventory, expiry tracking, and demand forecasting
                    </span>
                    <span class="invexa-footer-year">
                        © @DateTime.Now.Year
                    </span>
                </div>

                <!-- Line 2 -->
                <div class="invexa-footer-links">
                    <a asp-controller="Home"
                       asp-action="About"
                       class="invexa-footer-link">About</a>
                    <span class="invexa-footer-sep">·</span>

                    <a asp-controller="Home"
                       asp-action="Contact"
                       class="invexa-footer-link">Contact</a>
                    <span class="invexa-footer-sep">·</span>

                    <a asp-controller="Support"
                       asp-action="Index"
                       class="invexa-footer-link">Help</a>
                    <span class="invexa-footer-sep">·</span>

                    <a asp-controller="Feedback"
                       asp-action="Create"
                       class="invexa-footer-link">Feedback</a>
                </div>

            </div>
        </footer>

    }

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("Scripts", required: false)

</body>
</html>
