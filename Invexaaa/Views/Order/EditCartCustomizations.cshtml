@model SnomiAssignmentReal.Models.OrderDetail
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Edit Customisations";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var allCustoms = ViewBag.AllCustomizations as IEnumerable<SnomiAssignmentReal.Models.OrderCustomizationSettings>
                     ?? Enumerable.Empty<SnomiAssignmentReal.Models.OrderCustomizationSettings>();

    var selectedIds = Model.AppliedCustomizations?.Select(c => c.MenuItemCustomizationId).ToHashSet()
                      ?? new HashSet<string>();
}

<div class="container py-5">
    <h2 class="mb-4">
        Edit Customisations
        <small class="text-muted d-block" style="font-size:0.9rem;">
            @Model.MenuItem?.MenuItemName (Qty: @Model.OrderedQuantity)
        </small>
    </h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <form asp-action="EditCustomizations" asp-controller="Order" method="post" class="card border-0 shadow-sm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="orderDetailId" value="@Model.OrderDetailId" />

        <div class="card-body">
            @if (!allCustoms.Any())
            {
                <p class="text-muted">There are no customisation options for this item.</p>
            }
            else
            {
                <p class="text-muted mb-3">
                    Tick the options you want to apply to this item, then save your changes.
                </p>

                <div class="row">
                    @foreach (var c in allCustoms)
                    {
                        var isChecked = selectedIds.Contains(c.MenuItemCustomizationId);

                        <div class="col-md-6 col-lg-4 mb-2">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="c_@c.MenuItemCustomizationId"
                                       name="selectedCustomizations"
                                       value="@c.MenuItemCustomizationId"
                                       @(isChecked ? "checked" : "") />

                                <label class="form-check-label" for="c_@c.MenuItemCustomizationId">
                                    <span class="fw-semibold">@c.CustomizationName</span>
                                    @if (!string.IsNullOrWhiteSpace(c.CustomizationDescription))
                                    {
                                        <span class="text-muted">— @c.CustomizationDescription</span>
                                    }
                                    @if (c.CustomizationAdditionalPrice > 0)
                                    {
                                        <span class="badge bg-light text-dark ms-1">
                                            + @c.CustomizationAdditionalPrice.ToString("C")
                                        </span>
                                    }
                                </label>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="card-footer bg-white d-flex justify-content-between">
            <a asp-action="Cart" asp-controller="Order" class="btn btn-outline-secondary">
                ← Back to Cart
            </a>
            <button type="submit" class="btn btn-dark">
                Save Customisations
            </button>
        </div>
    </form>
</div>
