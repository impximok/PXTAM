@using SnomiAssignmentReal.Models
@model SnomiAssignmentReal.Models.ViewModels.ManageOrderHistoryVm
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Order History";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string Money(decimal v) => $"MYR {v:0.00}";
}

<div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="ppg-title">Order History</h1>
        <div class="d-flex gap-2">
            <a asp-action="ManageOrders" class="btn btn-outline-dark">← Back to Manage</a>
            <a asp-action="ManageTracks" class="btn btn-dark">Track Board</a>
        </div>
    </div>

    <!-- Filters -->
    <form method="get" asp-action="ManageOrderHistory" asp-controller="Order" class="filter-card mb-3">
        <input type="hidden" name="page" value="1" />

        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input name="q" value="@Model.Q" class="form-control" placeholder="Order ID, name, customer ID, method, table…" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="all">All</option>
                    <option value="served">Served</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Paid</label>
                <select name="paid" class="form-select">
                    <option value="all">All</option>
                    <option value="yes">Paid</option>
                    <option value="no">Unpaid</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Method</label>
                <select name="method" class="form-select">
                    <option value="all">All</option>
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="E-Wallet">E-Wallet</option>
                    <option value="QR">QR</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Customer</label>
                <select name="customerType" class="form-select">
                    <option value="all">All</option>
                    <option value="registered">Registered</option>
                    <option value="guest">Guest</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">From</label>
                <input type="date" name="from" value="@(Model.From?.ToString("yyyy-MM-dd") ?? "")" class="form-control" />
            </div>

            <div class="col-md-3">
                <label class="form-label">To</label>
                <input type="date" name="to" value="@(Model.To?.ToString("yyyy-MM-dd") ?? "")" class="form-control" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Total (min – max)</label>
                <div class="d-flex gap-2">
                    <input type="number" step="0.01" name="minTotal" value="@(Model.MinTotal?.ToString("0.00") ?? "")" class="form-control" placeholder="Min" />
                    <input type="number" step="0.01" name="maxTotal" value="@(Model.MaxTotal?.ToString("0.00") ?? "")" class="form-control" placeholder="Max" />
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label">Sort</label>
                <select name="sort" class="form-select">
                    <option value="recent_desc">Recent ↓</option>
                    <option value="recent_asc">Recent ↑</option>
                    <option value="amount_desc">Amount ↓</option>
                    <option value="amount_asc">Amount ↑</option>
                    <option value="items_desc">Items ↓</option>
                    <option value="items_asc">Items ↑</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Page size</label>
                <select name="pageSize" class="form-select">
                    <option value="12">12</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>

            <div class="col-md-3 d-flex gap-2">
                <button class="btn btn-dark flex-grow-1" type="submit">Apply</button>
                <a class="btn btn-outline-secondary" asp-action="ManageOrderHistory" asp-controller="Order">Reset</a>
            </div>
        </div>
    </form>

    @if (Model.Orders == null || !Model.Orders.Any())
    {
        <div class="alert alert-secondary">No matching orders.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table align-middle table-striped ppg-table">
                <thead class="table-dark">
                    <tr>
                        <th>Order</th>
                        <th>Customer</th>
                        <th>Status</th>
                        <th>Placed</th>
                        <th>Paid</th>
                        <th>Total</th>
                        <th>Items</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var o in Model.Orders)
                    {
                        var items = o.CustomerOrderDetails?.Sum(d => d.OrderedQuantity) ?? 0;
                        var total = o.NetPayableAmount > 0 ? o.NetPayableAmount : (o.OrderTotalAmount - o.TotalDiscountAmount);
                        if (total < 0) total = 0;
                        <tr>
                            <td class="fw-bold">@o.CustomerOrderId</td>
                            <td>@(o.Customer?.CustomerFullName ?? o.CustomerId)</td>
                            <td><span class="badge text-bg-light border">@o.OrderStatus</span></td>
                            <td>@o.OrderCreatedAt.ToString("dd MMM yyyy, HH:mm")</td>
                            <td>@(o.PaymentCompletedAt.HasValue? o.PaymentCompletedAt.Value.ToString("dd MMM yyyy, HH:mm") : "-")</td>
                            <td>@Money(total)</td>
                            <td>@items</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Paging -->
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">
                Showing page <strong>@Model.Page</strong> of <strong>@Model.TotalPages</strong> —
                <strong>@Model.Total</strong> total
            </div>
            <nav>
                <ul class="pagination mb-0">
                    @{
                        int prev = Math.Max(1, Model.Page - 1);
                        int next = Math.Min(Model.TotalPages, Model.Page + 1);

                        string link(int p) => Url.Action("ManageOrderHistory", "Order", new
                        {
                            q = Model.Q,
                            status = Model.Status,
                            paid = Model.Paid,
                            method = Model.Method,
                            customerType = Model.CustomerType,
                            from = Model.From?.ToString("yyyy-MM-dd"),
                            to = Model.To?.ToString("yyyy-MM-dd"),
                            minTotal = Model.MinTotal,
                            maxTotal = Model.MaxTotal,
                            sort = Model.Sort,
                            page = p,
                            pageSize = Model.PageSize
                        })!;
                    }
                    <li class="page-item @(Model.Page == 1 ? "disabled" : "")">
                        <a class="page-link" href="@link(prev)">« Prev</a>
                    </li>
                    <li class="page-item @(Model.Page == Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" href="@link(next)">Next »</a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

<style>
    .ppg-title {
        font-weight: 800;
        letter-spacing: .5px
    }

    .filter-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        padding: 16px 18px;
        box-shadow: 0 8px 24px rgba(0,0,0,.04)
    }

    .form-control, .form-select {
        border-radius: 12px
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #fafafa
    }

    .page-link {
        border-radius: 999px
    }

    .btn, .form-select, .form-control {
        transition: .15s ease
    }
</style>

@section Scripts {
    <script>
        // set selected values (avoid Razor 'selected' in <option> to bypass RZ1031)
        function setSelect(name, val){ const el=document.querySelector(`select[name="${name}"]`); if(el) el.value = val ?? ""; }
        setSelect("status", "@(Model.Status ?? "all")");
        setSelect("paid", "@(Model.Paid ?? "all")");
        setSelect("method", "@(Model.Method ?? "all")");
        setSelect("customerType", "@(Model.CustomerType ?? "all")");
        setSelect("sort", "@(Model.Sort ?? "recent_desc")");
        setSelect("pageSize", "@Model.PageSize");
    </script>
}
