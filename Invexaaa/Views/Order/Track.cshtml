@model SnomiAssignmentReal.Models.CustomerOrder
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Linq
@using SnomiAssignmentReal.Models
@{
    ViewData["Title"] = "Track My Order";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Stepper flow (visual only)
    var flow = new[] { "AwaitingPayment", "Ordered", "Preparing", "Ready", "Served", "Completed", "Cancelled" };
    var currentStatus = (Model.OrderStatus ?? "").Trim();
    var stepIndex = Array.IndexOf(flow, currentStatus);

    bool IsStaff() => User.IsInRole("Admin") || User.IsInRole("Staff");

    // Totals: OrderTotalAmount = gross subtotal (server filled), NetPayableAmount/TotalDiscountAmount added by rewards
    decimal subtotal = Model.OrderTotalAmount;
    decimal discount = Model.TotalDiscountAmount;
    decimal net = Model.NetPayableAmount > 0 ? Model.NetPayableAmount : Math.Max(0, subtotal - discount);
}




<div class="container py-5">

    <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="mb-0"><i class="bi bi-truck"></i> Track My Order</h2>

        <div class="d-flex gap-2">
            @if (IsStaff())
            {
                <a asp-action="ManageOrders" class="btn btn-outline-dark">Manage</a>
                <a asp-action="ManageTracks" class="btn btn-dark">Track Board</a>
            }
            else
            {
                <a asp-controller="Menu" asp-action="Catalog" class="btn btn-outline-dark">← Back to Menu</a>
            }
        </div>
    </div>

    @* TempData alerts *@
    @if (TempData["Info"] != null)
    {
        <div class="alert alert-success">@TempData["Info"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="card shadow-sm rounded-4 border-0">
        <div class="card-body">
            <h4>Order ID: <span class="text-primary">@Model.CustomerOrderId</span></h4>
            <p class="mb-1"><strong>Status:</strong> <span class="badge bg-dark">@Model.OrderStatus</span></p>
            <p class="mb-1"><strong>Payment:</strong> @Model.PaymentMethodName</p>
            <p class="mb-1"><strong>Table:</strong> @(Model.TableNumber == 0 ? "Takeaway" : $"Table {Model.TableNumber}")</p>
            <p class="mb-3"><strong>Placed:</strong> @Model.OrderCreatedAt.ToString("g")</p>

            @* Optional: QR hint if awaiting payment *@
            @if (string.Equals(Model.OrderStatus, "AwaitingPayment", StringComparison.OrdinalIgnoreCase)
                        && string.Equals(Model.PaymentMethodName, "QR", StringComparison.OrdinalIgnoreCase))
            {
                <div class="alert alert-warning d-flex align-items-center gap-2">
                    <i class="bi bi-qr-code"></i>
                    <div>
                        Awaiting QR payment.
                        <a asp-action="QrPay" asp-route-id="@Model.CustomerOrderId" class="alert-link">Tap here to open the QR screen</a>.
                    </div>
                </div>
            }

            @* Stepper *@
            <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
                @for (int i = 0; i < flow.Length; i++)
                {
                    var done = stepIndex >= 0 && i <= stepIndex && !string.Equals(currentStatus, "Cancelled", System.StringComparison.OrdinalIgnoreCase);
                    var current = i == stepIndex;
                    <span class="step-chip @(done ? "step-done" : "") @(current ? "step-current" : "")">@flow[i]</span>
                    if (i < flow.Length - 1)
                    {
                        <span class="step-sep"></span>
                    }
                }
            </div>

            <hr />

            <h5>Items</h5>
            <ul class="list-group list-group-flush mb-3">
                @foreach (var d in (Model.CustomerOrderDetails ?? Enumerable.Empty<OrderDetail>()))
                {
                    var unit = (d.MenuItem?.MenuItemUnitPrice ?? 0m) + (d.AppliedCustomizations?.Sum(c => c.CustomizationAdditionalPrice) ?? 0m);
                    var subtotalLine = unit * d.OrderedQuantity;

                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <strong>@d.MenuItem?.MenuItemName</strong> × @d.OrderedQuantity
                            <br />
                            <small class="text-muted">
                                @(d.AppliedCustomizations != null && d.AppliedCustomizations.Any()
                                                            ? string.Join(", ", d.AppliedCustomizations.Select(c => c.CustomizationName))
                                                            : "No customizations")
                        </small>
                    </span>
                    <span>@subtotalLine.ToString("C")</span>
                </li>
                                }
            </ul>

            <div class="row g-3">
                <div class="col-lg-6">
                    <div class="border rounded p-3">
                        <h6 class="mb-2"><i class="bi bi-receipt"></i> Totals</h6>
                        <div class="d-flex justify-content-between">
                            <span>Subtotal</span><strong>@subtotal.ToString("C")</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Discount (points)</span><strong class="text-success">- @discount.ToString("C")</strong>
                        </div>
                        <hr class="my-2" />
                        <div class="d-flex justify-content-between">
                            <span>Net Paid</span><strong class="fs-5">@net.ToString("C")</strong>
                        </div>
                        @if (Model.PaymentCompletedAt.HasValue)
                        {
                            <div class="text-muted mt-1"><small>Paid on @Model.PaymentCompletedAt.Value.ToString("g")</small></div>
                        }
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="border rounded p-3">
                        <h6 class="mb-2"><i class="bi bi-stars"></i> Rewards</h6>
                        <div class="d-flex justify-content-between">
                            <span>Points Redeemed</span><strong>@Model.RewardPointsRedeemed</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Points Earned</span><strong>@Model.RewardPointsEarned</strong>
                        </div>
                        @if (Model.RewardPointsAwardedAt.HasValue)
                        {
                            <div class="text-muted mt-1"><small>Awarded @Model.RewardPointsAwardedAt.Value.ToLocalTime().ToString("g")</small></div>
                        }
                        else if (string.Equals(Model.PaymentMethodName, "QR", StringComparison.OrdinalIgnoreCase)
                        && string.Equals(Model.OrderStatus, "AwaitingPayment", StringComparison.OrdinalIgnoreCase))
                        {
                            <div class="text-muted mt-1"><small>Points will be applied after payment confirmation.</small></div>
                        }
                    </div>
                </div>
            </div>

            @* =========================
               Customer-only cancel area
               ========================= *@
            @if (!IsStaff())
            {
                var canCancel =
                string.Equals(Model.OrderStatus, "AwaitingPayment", StringComparison.OrdinalIgnoreCase) ||
                string.Equals(Model.OrderStatus, "Ordered", StringComparison.OrdinalIgnoreCase);

                if (canCancel)
                {
                    <hr />
                    <form asp-action="CancelMyOrder" method="post" class="d-inline" onsubmit="return confirm('Cancel this order?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.CustomerOrderId" />
                        <button class="btn btn-outline-danger" type="submit">Cancel Order</button>
                    </form>
                    <small class="text-muted ms-2">You can cancel until the order moves to <b>Preparing</b>.</small>
                }
                else
                {
                    <hr />
                    <div class="alert alert-secondary mb-0">
                        We’ve already started <strong>@Model.OrderStatus</strong> your order. Online cancellation is closed. Please ask a staff member.
                    </div>
                }
            }

            @* =========================
               Admin/Staff controls
               ========================= *@
            @if (IsStaff())
            {
                <hr />
                <div class="d-flex flex-wrap gap-2">
                    <form asp-action="AdvanceStatus" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.CustomerOrderId" />
                        <button class="btn btn-dark" type="submit">Advance</button>
                    </form>

                    @if (!Model.PaymentCompletedAt.HasValue)
                    {
                        <form asp-action="MarkPaid" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.CustomerOrderId" />
                            <button class="btn btn-outline-dark" type="submit">Mark Paid</button>
                        </form>
                    }

                    <form asp-action="Cancel" method="post" class="d-inline" onsubmit="return confirm('Cancel this order?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.CustomerOrderId" />
                        <button class="btn btn-outline-danger" type="submit">Cancel</button>
                    </form>
                </div>
            }
        </div>
    </div>
</div>

<style>
    /* minimal black/white chips */
    .step-chip {
        border: 1.5px solid #000;
        border-radius: 999px;
        padding: .15rem .6rem;
        font-weight: 700;
        background: #fff;
        font-size: .9rem
    }

    .step-done {
        background: #000;
        color: #fff
    }

    .step-current {
        box-shadow: 0 0 0 3px rgba(0,0,0,.08)
    }

    .step-sep {
        width: 18px;
        height: 2px;
        background: #000;
        opacity: .35
    }
</style>

@section Scripts {
    <script>
        setTimeout(() => {
          document.querySelectorAll('.alert.alert-success').forEach(a => a.remove());
        }, 5000);
    </script>
}

