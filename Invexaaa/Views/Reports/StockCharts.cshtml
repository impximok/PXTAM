@using System.Linq
@model Invexaaa.Models.ViewModels.ReportPrintViewModel

@{
    ViewData["Title"] = "Stock Charts";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --black: #111;
        --gray-900: #1f2937;
        --gray-700: #374151;
        --gray-500: #6b7280;
        --gray-300: #d1d5db;
        --gray-200: #e5e7eb;
        --gray-100: #f9fafb;
        --white: #ffffff;
    }

    body {
        background-color: var(--gray-100);
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 28px;
    }

    .filter-form,
    .report-section {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 28px;
    }

        .filter-form label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-500);
            margin-bottom: 6px;
            display: block;
        }

        .filter-form input,
        .filter-form select {
            width: 100%;
            padding: 11px 14px;
            border-radius: 12px;
            border: 1px solid var(--gray-300);
            background: var(--white);
            font-size: 14px;
        }

    .btn-minimal {
        padding: 10px 16px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.15s ease;
    }

    .btn-black {
        background: var(--black);
        color: var(--white);
        border: 1px solid var(--black);
    }

    .btn-outline-black {
        background: transparent;
        color: var(--black);
        border: 1px solid var(--black);
    }

        .btn-outline-black:hover {
            background: var(--black);
            color: var(--white);
        }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
        margin-bottom: 28px;
    }

    .kpi-card {
        border: 1px solid var(--gray-200);
        border-radius: 16px;
        padding: 18px;
        background: var(--white);
    }

    .inactive-row {
        background: #f3f4f6;
        color: #6b7280;
    }

    @@media print {
        .no-print

    {
        display: none !important;
    }

    }
</style>


<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <div>
        <h2 class="mb-0">Stock Charts</h2>
        <small class="text-muted">
            Visual stock analysis (Active items only)
        </small>
    </div>

    <div class="d-flex gap-2">
        <button onclick="window.print()" class="btn btn-outline-dark">
            Print
        </button>

        <form asp-action="ExportPdf" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="reportType" value="StockCharts" />
            <input type="hidden" name="startDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="endDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
            <button class="btn btn-dark">
                Export PDF
            </button>
        </form>
    </div>
</div>

<!-- ================= FILTER FORM ================= -->
<form asp-action="Overview" method="post" class="filter-form no-print">
    @Html.AntiForgeryToken()

    <div class="row">
        <div class="col-md-4">
            <label>Start Date</label>
            <input type="date"
                   name="startDate"
                   value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
        </div>

        <div class="col-md-4">
            <label>End Date</label>
            <input type="date"
                   name="endDate"
                   value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
        </div>
    </div>

    <label class="mt-3">Report Type</label>
    <select name="reportType" required>
        <option value="">-- Select Report --</option>
        <option value="DemandForecast" @(Model.ReportType == "DemandForecast" ? "selected" : "")>
            Demand Forecast
        </option>
        <option value="Stock" @(Model.ReportType == "Stock" ? "selected" : "")>
            Stock Summary
        </option>
        <option value="StockCharts" @(Model.ReportType == "StockCharts" ? "selected" : "")>
            Stock Charts
        </option>
        <option value="Expiry" @(Model.ReportType == "Expiry" ? "selected" : "")>
            Expiry & Wastage
        </option>
    </select>


    <button class="btn btn-dark mt-3">
        Generate Report
    </button>
</form>

<!-- ================= SCOPE ================= -->
<div class="alert alert-info">
    <strong>Chart Scope:</strong><br />
    Charts display <b>ACTIVE items only</b>.
    Inactive items are excluded to prevent visual distortion.
</div>

<!-- ================= CHARTS ================= -->
@if (Model.StockChartData == null || !Model.StockChartData.Any())
{
    <div class="alert alert-warning">
        No active stock data available for the selected period.
    </div>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <canvas id="barChart"></canvas>
        </div>

        <div class="col-md-4">
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <p class="text-muted mt-3">
        <em>
            Inactive items are included in stock tables and KPIs,
            but excluded from charts to maintain analytical accuracy.
        </em>
    </p>

    <script>
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                    Model.StockChartData.Select(x => x.ItemName)
            ));

    const quantities = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                Model.StockChartData.Select(x => x.Quantity)
        ));

    const statuses = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                Model.StockChartData.Select(x => x.Status)
        ));

    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Stock Quantity (Active Items)',
                data: quantities
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });

        const statusCounts = {
            Healthy: statuses.filter(s => s === "Healthy").length,
            Low: statuses.filter(s => s === "Low").length,
            Reorder: statuses.filter(s => s === "Reorder").length
        };

        new Chart(document.getElementById('pieChart'), {
            type: 'pie',
            data: {
                labels: ['Healthy', 'Low', 'Reorder'],
                datasets: [{
                    data: [
                        statusCounts.Healthy,
                        statusCounts.Low,
                        statusCounts.Reorder
                    ]
                }]
            }
        });
    </script>
}
