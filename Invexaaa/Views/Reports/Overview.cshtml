@model Invexaaa.Models.ViewModels.ReportPrintViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Linq

@{
    ViewData["Title"] = "Reports & Analytics";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* ===== Layout ===== */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
    }

    /* ===== Form ===== */
    .filter-form {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 20px;
    }

        .filter-form label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
            display: block;
        }

        .filter-form select,
        .filter-form input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            background-color: #fff;
        }

    /* ===== KPI ===== */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }

    .kpi-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 16px;
    }

    .kpi-title {
        font-size: 13px;
        color: #6b7280;
    }

    .kpi-value {
        font-size: 24px;
        font-weight: 600;
        margin-top: 6px;
    }

    /* ===== Table ===== */
    .report-section {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 20px;
        margin-top: 24px;
    }

    .inactive-row {
        background: #f2f2f2;
        color: #666;
    }

    .badge-inactive {
        font-size: 11px;
        padding: 2px 6px;
        border: 1px solid #999;
        border-radius: 4px;
        margin-left: 6px;
    }

    @@media print {
        .no-print {
            display: none !important;
        }
    }
</style>

<div class="container-fluid">

    <!-- ================= HEADER ================= -->
    <div class="page-header">
        <div>
            <h2 class="fw-semibold">Reports & Analytics</h2>
            <p class="text-muted mb-0">Visual insights & printable reports</p>
        </div>

        <div class="action-buttons no-print">
            <button onclick="window.print()" class="btn btn-outline-dark">
                Print
            </button>

            @if (!string.IsNullOrEmpty(Model.ReportType))
            {
                <form asp-action="ExportPdf" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="reportType" value="@Model.ReportType" />
                    <input type="hidden" name="startDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="endDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
                    <button class="btn btn-dark">Export PDF</button>
                </form>
            }
        </div>
    </div>

    <!-- ================= SCOPE ================= -->
    @if (!string.IsNullOrEmpty(Model.ReportType))
    {
        <div class="alert alert-info">
            <strong>Report Scope:</strong><br />
            @Model.ScopeNote
            @if (!string.IsNullOrEmpty(Model.ChartNote))
            {
                <div><em>@Model.ChartNote</em></div>
            }
        </div>
    }

    <!-- ================= FILTER FORM ================= -->
    <form asp-action="Overview" method="post" class="filter-form no-print">
        @Html.AntiForgeryToken()

        <div class="row">
            <div class="col-md-4">
                <label>Start Date</label>
                <input type="date" name="startDate"
                       value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
            </div>

            <div class="col-md-4">
                <label>End Date</label>
                <input type="date" name="endDate"
                       value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
            </div>
        </div>

        <label class="mt-3">Report Type</label>
        <select name="reportType" required>
            <option value="">-- Select Report --</option>
            <option value="DemandForecast" selected="@(Model.ReportType == "DemandForecast")">Demand Forecast</option>
            <option value="Stock" selected="@(Model.ReportType == "Stock")">Stock Summary</option>
            <option value="StockCharts" selected="@(Model.ReportType == "StockCharts")">Stock Charts</option>
            <option value="Expiry" selected="@(Model.ReportType == "Expiry")">Expiry & Wastage</option>
        </select>

        <button class="btn btn-dark mt-3">Generate Report</button>
    </form>

    <!-- ================= KPIs (STOCK ONLY) ================= -->
    @if (Model.ReportType == "Stock" && Model.StockSummary != null)
    {
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">Total Quantity (All)</div>
                <div class="kpi-value">@Model.TotalQuantityAll</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Active Quantity</div>
                <div class="kpi-value">@Model.TotalQuantityActive</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Inactive Items</div>
                <div class="kpi-value">@Model.InactiveItemCount</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Inventory Value (Active)</div>
                <div class="kpi-value">RM @Model.InventoryValueActive.ToString("N2")</div>
            </div>
        </div>
    }

    <!-- ================= DETAILED DATA ================= -->
    <div class="report-section">
        <h4>Detailed Data</h4>

        <!-- DEMAND FORECAST -->
        @if (Model.ReportType == "DemandForecast")
        {
            if (Model.DemandForecastReport == null || !Model.DemandForecastReport.Any())
            {
                <div class="alert alert-warning">No demand forecast data.</div>
            }
            else
            {
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Status</th>
                            <th>Period</th>
                            <th>Forecast Qty</th>
                            <th>Recommended Reorder</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in Model.DemandForecastReport)
                        {
                            <tr class="@(d.ItemStatus == "Inactive" ? "inactive-row" : "")">
                                <td>@d.ItemName</td>
                                <td>@d.ItemStatus</td>
                                <td>@d.Period</td>
                                <td>@d.ForecastQty</td>
                                <td>@d.RecommendedReorder</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }

        <!-- STOCK -->
        @if (Model.ReportType == "Stock" && Model.StockSummary != null)
        {
            <div class="text-muted mb-2">
                <small><span class="badge-inactive">INACTIVE</span> included for audit accuracy.</small>
            </div>

            <table class="table table-bordered">
                <thead>
                    <tr><th>Item</th><th>Status</th><th>Quantity</th></tr>
                </thead>
                <tbody>
                    @foreach (var i in Model.StockSummary)
                    {
                        <tr class="@(i.ItemStatus == "Inactive" ? "inactive-row" : "")">
                            <td>@i.ItemName</td>
                            <td>@i.ItemStatus</td>
                            <td>@i.Quantity</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- EXPIRY -->
        @if (Model.ReportType == "Expiry")
        {
            if (Model.ExpiryReport == null || !Model.ExpiryReport.Any())
            {
                <div class="alert alert-warning">No items nearing expiry.</div>
            }
            else
            {
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Batch</th>
                            <th>Item</th>
                            <th>Status</th>
                            <th>Quantity</th>
                            <th>Expiry Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var e in Model.ExpiryReport)
                        {
                            <tr class="@(e.ItemStatus == "Inactive" ? "inactive-row" : "")">
                                <td>@e.BatchNumber</td>
                                <td>@e.ItemName</td>
                                <td>@e.ItemStatus</td>
                                <td>@e.Quantity</td>
                                <td>@e.ExpiryDate.ToString("yyyy-MM-dd")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }
    </div>
</div>
