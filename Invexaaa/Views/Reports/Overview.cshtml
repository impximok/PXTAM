@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model Invexaaa.Models.ViewModels.ReportPrintViewModel

@{
    ViewData["Title"] = "Reports & Analytics";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .kpi-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 18px;
    }

    .kpi-title {
        font-size: 13px;
        color: #6b7280;
    }

    .kpi-value {
        font-size: 26px;
        font-weight: 600;
        margin-top: 4px;
    }

    .report-section {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
    }

    @@media print {
        .no-print

    {
        display: none !important;
    }

    body {
        background: #fff !important;
    }

    }
</style>

<div class="container-fluid">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-semibold">Reports & Analytics</h2>
            <p class="text-muted mb-0">Visual insights & printable reports</p>
        </div>

        <div class="no-print d-flex gap-2">
            <button onclick="window.print()" class="btn btn-outline-dark">
                <i class="bi bi-printer"></i> Print
            </button>

            @if (!string.IsNullOrEmpty(Model.ReportType))
            {
                <form asp-action="ExportPdf" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="reportType" value="@Model.ReportType" />
                    <input type="hidden" name="startDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="endDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
                    <button class="btn btn-dark">
                        <i class="bi bi-file-earmark-pdf"></i> Export PDF
                    </button>
                </form>
            }
        </div>
    </div>

    <!-- FILTER BAR -->
    <form asp-action="Overview" method="post" class="row g-3 align-items-end no-print">
        @Html.AntiForgeryToken()

        <div class="col-md-3">
            <label class="form-label">Report Type</label>
            <select name="reportType" class="form-select" required>
                <option value="">-- Select --</option>
                <option value="Sales" selected="@(Model.ReportType == "Sales")">Sales</option>
                <option value="DemandForecast" selected="@(Model.ReportType == "DemandForecast")">Demand Forecast</option>
                <option value="Stock" selected="@(Model.ReportType == "Stock")">Stock Summary</option>
                <option value="StockCharts" selected="@(Model.ReportType == "StockCharts")">
                    Stock Charts
                </option>
                <option value="Expiry" selected="@(Model.ReportType == "Expiry")">Expiry & Wastage</option>
            </select>

        </div>

        <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" name="startDate" class="form-control"
                   value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
        </div>

        <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" name="endDate" class="form-control"
                   value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
        </div>

        <div class="col-md-3">
            <button class="btn btn-dark w-100">Generate Report</button>
        </div>
    </form>

    @if (Model.ReportType == "Sales")
    {
        <div class="col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">Total Sales</div>
                <div class="kpi-value">
                    @Model.SalesHeaders!.Sum(x => x.TotalAmount)
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">Total Orders</div>
                <div class="kpi-value">
                    @Model.SalesHeaders!.Count
                </div>
            </div>
        </div>
    }


            @if (Model.ReportType == "Stock")
            {
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-title">Total Inventory Qty</div>
                        <div class="kpi-value">
                            @Model.Inventories!.Sum(x => x.InventoryTotalQuantity)
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- ================= CHART ================= -->
        <div class="report-section">
            <h5 class="mb-3">Visual Analysis</h5>
            <canvas id="reportChart" height="90"></canvas>
        </div>

        <!-- ================= TABLE ================= -->
        <div class="report-section">
            <h5 class="mb-3">Detailed Data</h5>

            @if (Model.ReportType == "Sales")
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Sales ID</th>
                            <th>Date</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in Model.SalesHeaders!)
                        {
                            <tr>
                                <td>@s.SalesID</td>
                                <td>@s.SalesDate.ToShortDateString()</td>
                                <td>@s.TotalAmount</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            @if (Model.ReportType == "DemandForecast")
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Period</th>
                            <th>Forecast Qty</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in Model.DemandForecasts!)
                        {
                            <tr>
                                <td>@d.ItemID</td>
                                <td>@d.DemandForecastPeriod</td>
                                <td>@d.DemandPredictedQuantity</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
</div>

@if (Model.ReportType == "Sales")
{
    <div class="report-section">
        <h5 class="mb-3">Sales Trend</h5>
        <canvas id="salesChart"></canvas>
    </div>

    <script>
        new Chart(document.getElementById('salesChart'), {
            type: 'line',
            data: {
                labels: [@string.Join(",", Model.SalesHeaders!.Select(x => $"'{x.SalesDate:dd MMM}'"))],
                datasets: [{
                    label: 'Sales Amount',
                    data: [@string.Join(",", Model.SalesHeaders!.Select(x => x.TotalAmount))],
                    borderWidth: 2,
                    fill: false
                }]
            }
        });
    </script>
}

@if (Model.ReportType == "StockCharts")
{
    <div class="report-section">
        <h5 class="mb-3">Stock Distribution</h5>
        <canvas id="stockChart"></canvas>
    </div>

    <script>
        new Chart(document.getElementById('stockChart'), {
            type: 'bar',
            data: {
                labels: [
                    @string.Join(",", Model.StockChartData!.Select(x => $"'{x.ItemName}'"))
                ],
                datasets: [{
                    label: 'Stock Quantity',
                    data: [
                        @string.Join(",", Model.StockChartData!.Select(x => x.Quantity))
                    ],
                    borderWidth: 1
                }]
            }
        });
    </script>
}


