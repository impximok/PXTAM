@model IEnumerable<Invexaaa.Models.ViewModels.StockViewModel>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Manage Stock";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* ===============================
       MANAGE STOCK PAGE
    =============================== */

    .stock-page h3 {
        font-weight: 600;
    }

    #bulkAddBtn {
        width: 42px;
        height: 42px;
        font-size: 20px;
        border-radius: 10px;
    }

    .table th,
    .table td {
        vertical-align: middle;
    }

    .table thead {
        background: #f8f9fa;
    }

    .stock-checkbox {
        width: 18px;
        height: 18px;
    }

    .stock-row:hover {
        background: #fafafa;
    }

    .inactive-row {
        opacity: 0.5;
        background: #f1f5f9;
    }

    .inactive-badge {
        background: #e5e7eb;
        color: #374151;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
    }
</style>

<div class="container-fluid stock-page">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-semibold">Manage Stock</h3>

        <!-- PLUS BUTTON (BULK ADD) -->
        <button id="bulkAddBtn"
                class="btn btn-success"
                disabled
                title="Add stock to selected items">
            ＋
        </button>
    </div>

    <!-- TABLE -->
    <div class="card">
        <div class="table-responsive">
            <table class="table align-middle mb-0" id="stockTable">

                <thead>
                    <tr>
                        <th style="width:40px">
                            <input type="checkbox"
                                   id="selectAll"
                                   class="stock-checkbox" />
                        </th>
                        <th>Item</th>
                        <th>Category</th>
                        <th>Available</th>
                        <th>Status</th>
                        <th>Updated</th>
                        <th style="width:120px">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var s in Model)
                    {
                        bool isInactive = s.ItemStatus == "Inactive";

                        <tr class="stock-row @(isInactive ? "inactive-row" : "")"
                            data-status="@s.StockStatus">


                            <!-- CHECKBOX -->
                            <td>
                                <input type="checkbox"
                                       class="row-check stock-checkbox"
                                       value="@s.InventoryID"
                                       @(isInactive ? "disabled" : "") />

                            </td>

                            <!-- ITEM -->
                            <td>
                                <strong>@s.ItemName</strong>

                                @if (isInactive)
                                {
                                    <div class="mt-1">
                                        <span class="inactive-badge">INACTIVE</span>
                                    </div>
                                }
                        </td>


                            <!-- CATEGORY -->
                            <td>@s.CategoryName</td>

                            <!-- QUANTITY -->
                            <td>@s.AvailableQuantity</td>

                            <!-- STATUS -->
                            <td>
                                <span class="badge
                                    @(s.StockStatus == "In Stock" ? "bg-success" :
                                                                        s.StockStatus == "Low Stock" ? "bg-warning" :
                                                                        "bg-danger")">
                                @s.StockStatus
                            </span>
                        </td>

                            <!-- UPDATED -->
                            <td>@s.LastUpdated.ToString("dd/MM/yyyy")</td>

                            <!-- ACTION -->
                            <td>
                            @if (isInactive)
                                {
                                    <span class="inactive-badge">Locked</span>
                                }
                                else
                                {
                                    <a asp-action="AdjustStockByBatch"
                                       asp-route-inventoryId="@s.InventoryID"
                                       class="btn btn-sm btn-outline-primary">
                                        Adjust
                                    </a>
                                }
                            </td>


                        </tr>
                                        }
                </tbody>

            </table>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        /* ===============================
           BULK SELECT + ADD LOGIC
        =============================== */

        const selectAll = document.getElementById("selectAll");
        const checks = document.querySelectorAll(".row-check");
        const bulkBtn = document.getElementById("bulkAddBtn");

                function updateBulkButton() {
            const validChecks =
                Array.from(document.querySelectorAll(".row-check:checked"))
                     .filter(c => !c.disabled);

            bulkBtn.disabled = validChecks.length === 0;
        }


        /* Select all */
                selectAll.addEventListener("change", function () {
            checks.forEach(c => {
                if (!c.disabled) {
                    c.checked = this.checked;
                }
            });
            updateBulkButton();
        });


        /* Individual checkbox */
        checks.forEach(c =>
            c.addEventListener("change", updateBulkButton)
        );

        /* Bulk add click */
        bulkBtn.addEventListener("click", function () {
                    const ids = Array.from(
            document.querySelectorAll(".row-check:checked")
        )
        .filter(c => !c.disabled)   // 🔒 FINAL GUARD
        .map(c => c.value)
        .join(",");


            window.location.href =
                `/Stock/AddStockBatch?inventoryIds=${ids}`;
        });
    </script>
}
