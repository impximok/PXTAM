@model Invexaaa.Models.ViewModels.AdjustStockByBatchViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Adjust Stock by Batch";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Controller sets this for inactive items
    bool isInactive = ViewBag.IsInactive == true;
}

<style>
    .adjust-page {
        max-width: 900px;
    }

    .header-sub {
        color: #6b7280;
        margin-bottom: 16px;
    }

    .qty-pill {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 999px;
        background: #f3f4f6;
        font-weight: 600;
    }

    table td, table th {
        vertical-align: middle;
    }

    .expired {
        background-color: #fff1f2 !important;
    }

        .expired .expiry-text {
            color: #dc2626;
            font-weight: 600;
        }

    .delta-input {
        width: 120px;
    }

    .delta-summary {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        margin-top: 16px;
        font-weight: 600;
    }

    .delta-positive {
        color: #16a34a;
    }

    .delta-negative {
        color: #dc2626;
    }

    .hint {
        font-size: 13px;
        color: #6b7280;
    }

    /* 🔒 LOCKED STATE */
    .locked {
        opacity: 0.55;
        pointer-events: none;
        filter: grayscale(100%);
    }
</style>

<div class="container-fluid adjust-page">

    <h3>Adjust Stock – @Model.ItemName</h3>

    <div class="header-sub">
        Current Inventory:
        <span class="qty-pill">
            @Model.CurrentInventoryQuantity @Model.ItemUnitOfMeasure
        </span>
    </div>

    @if (isInactive)
    {
        <div class="alert alert-danger">
            This item is <strong>inactive</strong>.
            Stock adjustment is disabled.
        </div>
    }
    else
    {
        <div class="alert alert-warning small">
            Use this for <strong>manual corrections only</strong>
            (damage, miscount, system fixes).
        </div>
    }

    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <!-- 🔒 Lock entire form if inactive -->
    <form asp-action="AdjustStockByBatch"
          method="post"
          id="adjustForm"
          class="@(isInactive ? "locked" : "")">

        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="InventoryID" />
        <input type="hidden" asp-for="ItemID" />

        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Batch</th>
                    <th>Expiry</th>
                    <th>Available</th>
                    <th>Adjust (+ / −)</th>
                </tr>
            </thead>

            <tbody>
                @for (int i = 0; i < Model.Batches.Count; i++)
                {
                    var isExpired = Model.Batches[i].BatchExpiryDate < DateTime.Today;

                    <tr class="@(isExpired ? "expired" : "")">
                        <td>
                            @Model.Batches[i].BatchNumber
                            <input type="hidden" asp-for="Batches[i].BatchID" />
                        </td>

                        <td class="expiry-text">
                            @Model.Batches[i].BatchExpiryDate.ToString("dd MMM yyyy")
                        </td>

                        <td>
                            @Model.Batches[i].AvailableQuantity
                        </td>

                        <td>
                            <input asp-for="Batches[i].AdjustQuantity"
                                   type="number"
                                   class="form-control delta-input adjust-input"
                                   placeholder="0"
                                   disabled="@isInactive" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="delta-summary">
            Total Adjustment:
            <span id="deltaValue">0</span>
            @Model.ItemUnitOfMeasure
        </div>

        <p class="hint mt-2">
            Positive = add stock • Negative = deduct stock
        </p>

        <div class="mb-3 mt-3">
            <label class="form-label">
                Adjustment Reason <span class="text-danger">*</span>
            </label>

            <textarea asp-for="AdjustmentReason"
                      class="form-control"
                      rows="3"
                      placeholder="Damage, recount, correction..."
                      disabled="@isInactive"></textarea>

            <span asp-validation-for="AdjustmentReason"
                  class="text-danger small"></span>
        </div>


        <div class="d-flex gap-2">
            <button class="btn btn-danger"
                    type="submit"
                    disabled="@isInactive">
                Confirm Adjustment
            </button>

            <a asp-action="StockIndex"
               class="btn btn-outline-secondary">
                Cancel
            </a>
        </div>

    </form>
</div>

@section Scripts {
    <script>
        const inputs = document.querySelectorAll(".adjust-input");
        const deltaEl = document.getElementById("deltaValue");

        function updateDelta() {
            let total = 0;

            inputs.forEach(i => {
                const val = parseInt(i.value || 0);
                total += val;
            });

            deltaEl.textContent = total;
            deltaEl.className =
                total > 0 ? "delta-positive" :
                total < 0 ? "delta-negative" : "";
        }

        inputs.forEach(i => i.addEventListener("input", updateDelta));
        updateDelta();
    </script>

    <partial name="_ValidationScriptsPartial" />
}
