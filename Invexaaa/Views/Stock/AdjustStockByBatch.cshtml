@model Invexaaa.Models.ViewModels.AdjustStockByBatchViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Adjust Stock by Batch";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .adjust-page {
        max-width: 900px;
    }

    .header-sub {
        color: #6b7280;
        margin-bottom: 16px;
    }

    .qty-pill {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 999px;
        background: #f3f4f6;
        font-weight: 600;
    }

    table td, table th {
        vertical-align: middle;
    }

    .expired {
        background-color: #fff1f2 !important;
    }

        .expired .expiry-text {
            color: #dc2626;
            font-weight: 600;
        }

    .delta-input {
        width: 120px;
    }

    .delta-summary {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        margin-top: 16px;
        font-weight: 600;
    }

    .delta-positive {
        color: #16a34a;
    }

    .delta-negative {
        color: #dc2626;
    }

    .hint {
        font-size: 13px;
        color: #6b7280;
    }
</style>

<div class="container-fluid adjust-page">

    <h3>Adjust Stock – @Model.ItemName</h3>
    <div class="header-sub">
        Current Inventory:
        <span class="qty-pill">
            @Model.CurrentInventoryQuantity @Model.ItemUnitOfMeasure
        </span>
    </div>

    <div class="alert alert-warning small">
        Use this for <strong>manual corrections only</strong>
        (damage, miscount, system fixes).
    </div>

    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <form asp-action="AdjustStockByBatch" method="post" id="adjustForm">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="InventoryID" />
        <input type="hidden" asp-for="ItemID" />

        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Batch</th>
                    <th>Expiry</th>
                    <th>Available</th>
                    <th>Adjust (+ / −)</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Batches.Count; i++)
                {
                    var isExpired = Model.Batches[i].BatchExpiryDate < DateTime.Today;

                    <tr class="@(isExpired ? "expired" : "")">
                        <td>
                            @Model.Batches[i].BatchNumber
                            <input type="hidden" asp-for="Batches[i].BatchID" />
                        </td>
                        <td class="expiry-text">
                            @Model.Batches[i].BatchExpiryDate.ToString("dd MMM yyyy")
                        </td>
                        <td>
                            <span class="available"
                                  data-available="@Model.Batches[i].AvailableQuantity">
                                @Model.Batches[i].AvailableQuantity
                            </span>
                        </td>
                        <td>
                            <input asp-for="Batches[i].AdjustQuantity"
                                   type="number"
                                   class="form-control delta-input adjust-input"
                                   placeholder="0"
                                   data-available="@Model.Batches[i].AvailableQuantity" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="delta-summary">
            Total Adjustment:
            <span id="deltaValue">0</span>
            @Model.ItemUnitOfMeasure
        </div>

        <p class="hint mt-2">
            Positive = add stock • Negative = deduct stock
        </p>

        <div class="mb-3 mt-3">
            <label class="form-label">Adjustment Reason</label>
            <textarea asp-for="AdjustmentReason"
                      class="form-control"
                      rows="3"
                      placeholder="Damage, recount, correction..."></textarea>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-danger" type="submit">
                Confirm Adjustment
            </button>
            <a asp-action="StockIndex" class="btn btn-outline-secondary">
                Cancel
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        const inputs = document.querySelectorAll(".adjust-input");
        const deltaEl = document.getElementById("deltaValue");

        function updateDelta() {
            let total = 0;

            inputs.forEach(i => {
                const val = parseInt(i.value || 0);
                const available = parseInt(i.dataset.available);

                // ❌ Prevent batch going negative (UI guard)
                if (val < 0 && Math.abs(val) > available) {
                    i.classList.add("is-invalid");
                } else {
                    i.classList.remove("is-invalid");
                    total += val;
                }
            });

            deltaEl.textContent = total;
            deltaEl.className =
                total > 0 ? "delta-positive" :
                total < 0 ? "delta-negative" : "";
        }

        inputs.forEach(i => i.addEventListener("input", updateDelta));
        updateDelta();
    </script>

    <partial name="_ValidationScriptsPartial" />
}
