@model Invexaaa.Models.ViewModels.ItemFormViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Add New Item";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --page-bg: #ffffff;
        --card-bg: #ffffff;
        --border: #e3e3e3;
        --text: #111;
        --muted: #7a7a7a;
        --radius: 18px;
    }


    body {
        background: #fff !important;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        color: var(--text);
    }

    main {
        background: #fff !important;
    }



    .two-card {
        width: 100%;
        max-width: 1400px;
        display: grid;
        gap: 26px;
        align-items: stretch;
        /* ✅ auto layout: becomes 1 column automatically on small screens */
        grid-template-columns: minmax(280px, 340px) minmax(0, 1fr);
    }

    @@media (max-width: 950px) {
        .two-card {
            grid-template-columns: 1fr; /* stack */
        }
    }

    .form-grid {
        display: grid;
        gap: 12px 16px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }


    .basic-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px 16px;
    }

        .basic-grid .span-2 {
            grid-column: 1 / -1;
        }

    /* mobile */
    @@media (max-width: 950px) {
        .basic-grid {
            grid-template-columns: 1fr;
        }

            .basic-grid .span-2 {
                grid-column: auto;
            }
    }


    .card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: none;
        padding: 32px 26px 22px; /* ⬅统一 top padding */
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        overflow: visible;
    }


    .subtitle {
        margin-top: 8px;
        font-size: 0.9rem;
        color: var(--muted);
        text-align: center;
    }

    /* LEFT: square preview */
    .photo-circle {
        width: 210px;
        height: 210px;
        margin: 18px auto 16px;
        border-radius: 14px; /* ✅ square but slightly rounded */
        border: 1px solid var(--border);
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
        transition: border-color .2s ease, background-color .2s ease, transform .15s ease;
        cursor: pointer;
    }

        .photo-circle:hover {
            border-color: #bdbdbd;
            background: #f1f1f1;
            transform: translateY(-1px);
        }

        .photo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            position: relative;
            z-index: 1;
        }

        /* text centered nicely */
        .photo-circle .placeholder {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            color: #9a9a9a;
            font-size: 16px;
            font-weight: 600;
            user-select: none;
            pointer-events: none;
            z-index: 2;
        }


        .photo-circle .preview-text {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            /* force text to look like text */
            background: transparent !important;
            color: #9a9a9a !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif !important;
            /* make sure it's above everything */
            z-index: 999 !important;
            pointer-events: none;
        }





        .photo-circle * {
            margin: 0;
            padding: 0;
        }

        .photo-circle img {
            position: relative;
            z-index: 1;
        }


    /* Upload button */
    .upload-row {
        width: 260px;
        max-width: 100%;
        margin: 0 auto 16px;
        display: flex;
        justify-content: center;
    }

    .upload-pill {
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 6px;
        border-radius: 999px;
        border: 1px solid var(--border);
    }

        .upload-pill label {
            flex: 1;
            text-align: center;
            border-radius: 999px;
            padding: 10px 12px;
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.92rem;
            margin: 0;
            transition: background-color .2s ease, transform .15s ease;
            background: #111; /* ✅ default black */
            border: 1px solid #111; /* ✅ needed so hover can show outline cleanly */
        }



            .upload-pill label:active {
                transform: scale(0.97);
            }
    /* Dropzone */
    .dropzone {
        border: 1.6px dashed #d8d8d8;
        border-radius: 16px;
        text-align: center;
        background: #fff;
        margin-top: 18px;
        padding: 28px 20px; /* more vertical air */
        transition: border-color .2s ease, background-color .2s ease;
    }

        .dropzone .icon {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            border: 1px solid #ededed;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2px auto 10px;
            color: #666;
            background: #fafafa;
            font-weight: 800;
        }

        .dropzone .hint {
            margin: 8px 0 10px;
            color: #666;
            font-size: 0.92rem;
            font-weight: 600;
        }


    .choose-btn {
        display: inline-block;
        margin-top: 6px;
        padding: 9px 16px;
        border-radius: 999px;
        background: #fff;
        cursor: pointer;
        font-weight: 650;
        font-size: 0.92rem;
    }

    .dropzone small {
        display: block;
        margin-top: 10px;
        color: #9a9a9a;
        font-size: 0.78rem;
    }

    /* RIGHT: form */
    .form-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px 16px; /* row gap 12px, column gap unchanged */
    }

    .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px 16px; /* row gap 12px, column gap unchanged */
    }

    .field label {
        margin: 10px 0 4px; /* ⬅ was 14px 0 6px */
        font-size: 13px;
        font-weight: 500;
        color: #000;
        display: block;
    }



    .field input,
    .field select {
        width: 100%;
        padding: 10px 12px; /* ⬅ was 12px */
        border-radius: 12px;
        border: 2px solid transparent; /* 👈 reserve space */
        background: #fff;
        font-size: 0.95rem;
        outline: none;
        box-shadow: none !important;
    }

    /* Default (unfocused) look */
    .field input,
    .field select {
        border-color: #dedede; /* grey */
    }

        /* Focused */
        .field input:focus,
        .field select:focus {
            border-color: #000; /* black */
        }


    .help-box {
        border-radius: 14px;
        background: #f7f7f7;
        border: 1px dashed #d8d8d8;
        margin-top: 8px; /* ⬅ was 12px */
        padding: 10px 12px; /* slightly slimmer */
        font-size: 0.9rem;
        color: #555;
    }

    .text-danger {
        display: block;
        margin-top: 4px;
        font-size: 0.78rem;
    }

    .primary-btn {
        margin-top: 18px;
        width: 100%;
        padding: 11px 14px;
        border: 1px solid #111; /* ✅ so hover outline shows */
        border-radius: 999px;
        background: #111;
        color: #fff;
        font-weight: 750;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color .25s ease, color .25s ease, border-color .25s ease;
    }

        /* ✅ SAMPLE HOVER (white pill outline) */
        .primary-btn:hover,
        .upload-pill label:hover {
            background: #fff !important;
            color: #000 !important;
            border-color: #000 !important;
        }

        /* Pressed/click feedback (optional) */
        .primary-btn:active,
        .upload-pill label:active {
            background: #f2f2f2 !important;
            color: #000 !important;
            border-color: #000 !important;
        }


    .back-link {
        margin-top: 18px;
        text-align: center;
    }

        .back-link a {
            color: #111;
            text-decoration: underline;
            font-size: 0.88rem;
            transition: color 0.2s ease;
        }

            .back-link a:hover {
                color: #2563eb; /* blue hover */
            }


    @@media (max-width: 950px) {
        .two-card {
            grid-template-columns: 1fr;
        }

        .card h2 {
            font-size: 1.55rem;
        }

        .form-grid-2, .form-grid-3 {
            grid-template-columns: 1fr;
        }
    }


    /* --- Hover polish additions --- */
    .photo-circle {
        cursor: pointer;
        position: relative; /* ✅ REQUIRED */
        margin: 22px auto 22px
    }

        .photo-circle:active {
            transform: translateY(0);
        }

    .choose-btn {
        transition: background-color .2s ease, border-color .2s ease, transform .15s ease;
    }

        .choose-btn:hover {
            background: #f5f5f5;
            border-color: #cfcfcf;
        }

        .choose-btn:active {
            transform: scale(0.98);
        }

    .upload-pill label:hover {
        background: #000;
    }

    .dropzone {
        transition: border-color .2s ease, background-color .2s ease, transform .15s ease;
    }

        .dropzone:active {
            transform: scale(0.995);
        }

    /* Focus ring (buttons only) */
    .photo-circle:focus-visible,
    .upload-pill label:focus-visible,
    .choose-btn:focus-visible,
    .primary-btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 4px rgba(0,0,0,0.08);
    }

    /* ====== Editor modal ====== */
    .editor {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0,0,0,.55);
        display: grid;
        place-items: center;
        padding: 20px;
    }

        .editor.hidden {
            display: none;
        }

    .editor-box {
        width: min(480px, 94vw);
        background: #fff;
        border-radius: 24px;
        padding: 18px;
        position: relative;
        box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }

    .editor-close {
        position: absolute;
        top: 14px; /* ⬅ more space from top */
        right: 14px; /* ⬅ more space from right */
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid rgba(0,0,0,.15);
        background: #fff;
        cursor: pointer;
    }

        .editor-close:hover {
            background: #f4f4f4;
        }


    .editor-canvasWrap {
        width: min(360px, 82vw);
        height: min(360px, 82vw);
        margin: 10px auto 0;
        border-radius: 14px; /* ✅ square crop */
        background: #f4f5f7;
        border: 1px solid rgba(0,0,0,.12);
        overflow: hidden;
        display: grid;
        place-items: center;
    }


    .editor-controls {
        margin-top: 16px;
        display: grid;
        gap: 16px;
        padding-top: 12px;
        border-top: 1px solid rgba(0,0,0,.08);
    }

    .editor-zoom {
        display: grid;
        grid-template-columns: 46px 1fr;
        gap: 12px;
        align-items: center;
    }

    .zoom-label {
        font-weight: 700;
        font-size: 13px;
    }

    .editor-zoom input[type="range"] {
        width: 100%;
    }

    .editor-actions {
        display: grid;
        gap: 14px;
        justify-items: center;
    }

    .rotate-row {
        display: flex;
        gap: 10px;
    }

    .btn.icon {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 1px solid #000;
        background: #fff;
        cursor: pointer;
    }

    .btn.solid.use-btn {
        width: 50%; /* 🔥 shorter */
        max-width: 160px; /* 🔥 tighter */
        height: 42px; /* slightly slimmer */
        border-radius: 999px;
        border: 1px solid #000;
        background: #000;
        color: #fff;
        cursor: pointer;
    }


        /* Hover like your login sample */
        .btn.solid.use-btn:hover {
            background: #fff;
            color: #000;
        }


    /* ===== Zoom slider (clean single track) ===== */
    .editor-zoom input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 16px; /* bigger click area */
        background: transparent; /* ✅ IMPORTANT: remove the extra grey line */
        outline: none;
        padding: 0;
        margin: 0;
    }

        /* Track (Chrome/Safari) */
        .editor-zoom input[type="range"]::-webkit-slider-runnable-track {
            height: 4px;
            border-radius: 999px;
            background: linear-gradient( to right, #000 0%, #000 var(--value, 0%), #e5e5e5 var(--value, 0%), #e5e5e5 100% );
        }

        /* Thumb (Chrome/Safari) */
        .editor-zoom input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #000;
            border: 0;
            margin-top: -6px; /* centers thumb on 4px track */
            cursor: pointer;
        }

        /* Firefox track */
        .editor-zoom input[type="range"]::-moz-range-track {
            height: 4px;
            background: #e5e5e5;
            border-radius: 999px;
        }

        .editor-zoom input[type="range"]::-moz-range-progress {
            height: 4px;
            background: #000;
            border-radius: 999px;
        }

        .editor-zoom input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #000;
            border: 0;
            cursor: pointer;
        }




    .card-photo {
        padding: 18px 18px 16px; /* ✅ smaller padding */
    }


    .photo-circle {
        width: 190px;
        height: 190px; /* ✅ slightly smaller preview */
    }




    /* Choose Image button - NOT full width */
    .card-photo .primary-btn {
        width: auto;
        min-width: 180px;
        max-width: 220px;
        margin: 14px auto 0; /* center */
        display: block;
    }

    /* ===== Custom Dropdown (FIXED) ===== */
    .dd {
        position: relative;
        width: 100%;
    }

    /* CLOSED field */
    .dd-btn {
        width: 100%;
        height: 48px;
        padding: 0 28px 0 18px; /* ⬅ smaller right padding = arrow goes more right */
        border-radius: 16px;
        background: #fff;
        color: #111;
        border: 1px solid #dedede !important; /* ✅ default grey border */
        box-shadow: none !important; /* ✅ remove weird double border */
        outline: none !important;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        box-sizing: border-box;
        position: relative; /* ✅ needed */
        padding-right: 44px; /* ⬅ more space for arrow */
    }

    /* When open, add soft shadow like sample */
    .dd.open .dd-btn {
        border-color: #dcdcdc !important;
        box-shadow: 0 12px 26px rgba(0,0,0,0.06) !important;
    }

    /* Focus (keep grey, no black border jump) */
    .dd-btn:focus,
    .dd-btn:focus-visible {
        border: 1px solid #dedede !important;
    }

    /* Text */
    .dd-value {
        font-size: 0.95rem;
        font-weight: 500;
        color: #111;
    }

    .dd-placeholder {
        color: #999;
    }

    /* Arrow */
    /* Arrow like sample (thin V) */
    .dd-arrow {
        width: 18px;
        height: 18px;
        display: grid;
        place-items: center;
        flex: 0 0 auto;
        position: absolute;
        right: 16px; /* ⬅ move right */
        top: 50%;
        transform: translateY(-50%);
    }

        .dd-arrow::before {
            content: "";
            width: 7px;
            height: 7px;
            border-right: 2px solid #111;
            border-bottom: 2px solid #111;
            transform: rotate(45deg); /* makes a V chevron */
            margin-top: -2px;
        }


    /* MENU container */
    .dd-menu {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 10px);
        z-index: 999;
        background: #fff;
        border-radius: 18px;
        padding: 10px;
        display: none;
        max-height: 260px; /* ✅ FIX: missing semicolon before */
        overflow: auto; /* ✅ FIX */
    }

    .dd.open .dd-menu {
        display: block;
    }

    /* Items (full width rows like sample) */
    .dd-item {
        padding: 14px 18px;
        font-size: 0.95rem;
        font-weight: 500;
        color: #111;
        cursor: pointer;
    }

        .dd-item:hover {
            background: #f1f1f1;
        }



    /* ===== Make dropdown menu more compact ===== */
    .dd-menu {
        top: calc(100% + 6px); /* was 10px */
        padding: 6px; /* was 10px */
        border-radius: 14px; /* was 18px */
        max-height: 180px; /* was 260px */
        border: 1px solid #e6e6e6; /* add a clean edge */
        box-shadow: 0 14px 30px rgba(0,0,0,0.08);
    }

    .dd-item {
        padding: 10px 14px; /* was 14px 18px */
        font-size: 0.92rem; /* slightly smaller */
        border-radius: 12px;
        line-height: 1.2;
    }

    /* Optional: also reduce the closed field height a bit */
    .dd-btn {
        height: 44px; /* was 48px */
        border-radius: 14px; /* was 16px */
    }


    .card-title {
        margin: 0;
        padding-top: 8px;
        padding-bottom: 24px;
        font-size: 30px;
        font-weight: 800;
        line-height: 1.2;
        color: #000;
        text-align: center;
    }



    .dropzone {
        cursor: pointer;
    }

        .dropzone:hover {
            border-color: #bdbdbd;
            background: #fafafa;
        }

        .dropzone:focus-visible {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0,0,0,0.08);
        }

    /* LEFT CARD = consistent vertical spacing */
    .card-photo {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 32px; /* ✅ match .card padding-top */
        padding-bottom: 26px;
        gap: 22px; /* ✅ makes spacing equal */
    }

        /* title: remove extra bottom margin */
        .card-photo .card-title {
            margin: 0; /* ✅ let gap control spacing */
            line-height: 1.15;
        }

        /* preview box: remove random margins */
        .card-photo .photo-circle {
            margin: 0; /* ✅ let gap control spacing */
        }

        /* dropzone: remove random top margin */
        .card-photo .dropzone {
            margin-top: 0; /* ✅ let gap control spacing */
            width: 100%; /* looks cleaner */
        }

        /* bottom button: remove random margin-top */
        .card-photo .primary-btn {
            margin-top: 0; /* ✅ gap controls spacing */
        }

    .page-wrap {
        padding: 6px 14px;
        display: flex;
        justify-content: flex-start;
        background: #fff !important;
    }


    .card {
        padding-top: 16px;
    }
    /* reduce card top padding */

    .bw-icon {
        filter: grayscale(100%) brightness(0);
        margin-right: 6px;
    }

    /* ===== Validation error (match Register page) ===== */
    .field input.input-validation-error,
    .field select.input-validation-error {
        border-color: #dc2626 !important; /* red */
    }

        /* Optional: red focus ring when errored */
        .field input.input-validation-error:focus,
        .field select.input-validation-error:focus {
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.15);
        }


    /* ===== Validation error for custom dropdown ===== */
    .dd.error .dd-btn {
        border: 2px solid #dc2626 !important; /* IMPORTANT: override border shorthand */
    }

    .dd.error.dd.open .dd-btn {
        border: 2px solid #dc2626 !important;
    }

    .dd.error .dd-btn:focus,
    .dd.error .dd-btn:focus-visible {
        border: 2px solid #dc2626 !important;
    }

    /* ===== Save button loading state ===== */
    .primary-btn.is-loading {
        opacity: 0.85;
        cursor: not-allowed;
    }

    .primary-btn .btn-spinner {
        width: 16px;
        height: 16px;
        margin-left: 10px;
        border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.45);
        border-top-color: #fff;
        display: none;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
    }

    .primary-btn.is-loading .btn-spinner {
        display: inline-block;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .req {
        color: #dc2626;
        font-weight: 800;
        margin-left: 4px;
    }

    .btn-row {
        position: sticky;
        bottom: 0;
        background: #fff;
        padding: 12px 0 6px;
        margin-top: 12px;
        border-top: 1px solid #ededed;
        display: flex;
        gap: 12px;
    }

        .btn-row .primary-btn {
            flex: 1;
            margin-top: 0;
        }
    /* ✅ remove extra top margin */
    .card[aria-label="Add New Item Form"] {
        overflow: visible;
    }



    .primary-btn.secondary {
        background: #fff;
        color: #111;
        border: 1px solid #111;
    }

        .primary-btn.secondary:hover {
            background: #111 !important;
            color: #fff !important;
            border-color: #111 !important;
        }


    /* ===== Searchable dropdown ===== */
    .dd-search {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #e6e6e6;
        outline: none;
        font-size: 0.9rem;
        margin-bottom: 8px;
    }

        .dd-search:focus {
            box-shadow: 0 0 0 4px rgba(0,0,0,0.06);
        }

    .dd-item.hidden {
        display: none;
    }

    /* highlight keyboard selected item */
    .dd-item.kb-active {
        background: #f1f1f1;
    }

    .dd-item.dd-new {
        font-weight: 700;
        border-bottom: 1px solid #eee;
        margin-bottom: 6px;
    }

        .dd-item.dd-new:hover {
            background: #f7f7f7;
        }

    .dd-item.dd-new,
    .dd-item.dd-refresh {
        font-weight: 700;
        background: #fafafa;
    }

    .dd-item.dd-refresh {
        border-bottom: 1px solid #eee;
        margin-bottom: 6px;
    }

    .dd-head {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .dd-head .dd-btn {
            flex: 1;
        }

    .dd-action {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: 1px solid #e6e8ec;
        background: #fff;
        color: #111;
        transition: .15s ease;
    }

        .dd-action:hover {
            background: #f5f6f8;
            border-color: #d7dae0;
        }


    .dropzone.is-dragover {
        border-color: #000;
        background: #fafafa;
    }

    .editor-zoom input[type="range"]::-moz-range-progress {
        background: #000;
        height: 4px;
        border-radius: 999px;
    }

    .editor-zoom input[type="range"]::-moz-range-track {
        background: #e5e5e5;
        height: 4px;
        border-radius: 999px;
    }

    /* ===== FINAL compact spacing for daily ops ===== */
    .card {
        padding: 18px 22px;
    }

    .card-title {
        margin: 6px 0 14px;
        padding: 0; /* ✅ remove the big padding you set earlier */
        font-size: 28px; /* slightly smaller to save height */
    }

    .field {
        margin-bottom: 12px;
    }
        /* ✅ you don't have this now */
        .field label {
            margin: 0 0 6px; /* ✅ override your 10px top margin */
            font-size: 14px;
        }

    .form-grid, .form-grid-2, .form-grid-3 {
        gap: 12px 16px;
    }

    /* ===== UOM quick fill (clean) ===== */
    .uom-row {
        display: grid;
        gap: 10px;
    }

    .uom-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        padding: 10px 12px;
        border: 1px solid #ededed;
        background: #fafafa;
        border-radius: 14px;
    }

    .uom-chip {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid #e3e3e3;
        background: #fff;
        cursor: pointer;
        font-weight: 700;
        font-size: 0.88rem;
        line-height: 1;
        transition: background .15s ease, border-color .15s ease, transform .08s ease;
    }

        .uom-chip:hover {
            background: #f3f3f3;
            border-color: #d6d6d6;
        }

        .uom-chip:active {
            transform: scale(0.98);
        }

        /* nice focus for keyboard */
        .uom-chip:focus-visible {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0,0,0,0.08);
        }


    /* ===== Dropdown menu: always above + scrollable ===== */
    .dd {
        position: relative;
        z-index: 30;
    }

        .dd.open {
            z-index: 9999;
        }
    /* only when open, jump to top */

    .dd-menu {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 6px);
        z-index: 9999;
        max-height: 220px;
        overflow: auto;
    }

    .uom-chip.is-active {
        border-color: #000;
        background: #fff;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.06);
    }

    .dd-uom .dd-input {
        width: 100%;
        height: 44px;
        padding: 0 44px 0 18px;
        border-radius: 14px;
        border: 2px solid #dedede; /* ✅ 2px default */
        font-size: 0.95rem;
        outline: none;
        box-sizing: border-box;
    }

        .dd-uom .dd-input:focus {
            border-color: #000; /* ✅ black focus */
        }


    /* ===== DD-style input for UOM ===== */
    .dd-uom .dd-head {
        position: relative;
        width: 100%;
    }

    .dd-uom .dd-input {
        width: 100%;
        height: 44px;
        padding: 0 44px 0 18px; /* leave room for arrow */
        border-radius: 12px;
        border: 1px solid #dedede;
        font-size: 0.95rem;
        outline: none;
        box-sizing: border-box;
    }

        .dd-uom .dd-input:focus {
            border-color: #000;
        }

    .dd-uom.open .dd-input {
        box-shadow: 0 12px 26px rgba(0,0,0,0.06);
    }

    .dd-uom .dd-arrow {
        pointer-events: none;
    }

    .section-label {
        margin: 18px 0 10px;
        padding-bottom: 10px;
        font-size: 0.78rem;
        font-weight: 800;
        letter-spacing: .08em;
        text-transform: uppercase;
        color: #6b7280;
        border-bottom: 1px solid #ededed; /* ✅ thin line */
    }

        .section-label:first-of-type {
            margin-top: 0;
        }

    .dd-uom .dd-arrow {
        pointer-events: auto; /* ✅ allow clicking */
        cursor: pointer;
    }

    .text-danger {
        display: block;
        margin-top: 6px;
        font-size: 0.82rem;
        color: #dc2626;
    }

    .dd-uom .dd-input.input-validation-error {
        border: 2px solid #dc2626 !important;
    }


    .field textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 2px solid #dedede;
        font-size: 0.95rem;
        outline: none;
        box-shadow: none !important;
    }

        .field textarea:focus {
            border-color: #000;
        }

        .field textarea.input-validation-error {
            border-color: #dc2626 !important;
        }


    .char-hint {
        display: block;
        margin-top: 4px;
        font-size: 0.75rem;
        color: #6b7280; /* muted grey */
        text-align: right;
    }

    /* ===== EXTRA-TIGHT BASIC INFO SPACING ===== */

    /* overall grid row spacing */
    .basic-grid {
        row-gap: 4px; /* was 8px / 12px */
    }

        /* reduce bottom gap of each field */
        .basic-grid .field {
            margin-bottom: 2px; /* was 6px / 12px */
        }

            /* labels closer to inputs */
            .basic-grid .field label {
                margin-bottom: 3px; /* was 4px–6px */
            }

            /* description textarea → next row tighter */
            .basic-grid .field.span-2 {
                margin-bottom: 0; /* key change */
            }

        /* character counter closer */
        .basic-grid .char-hint {
            margin-top: 2px; /* was 4px */
        }

        /* error message closer to field */
        .basic-grid .text-danger {
            margin-top: 2px; /* was 6px */
        }

    /* ===== Tighten RIGHT form only ===== */

    /* reduce card internal padding */
    .card[aria-label="Add New Item Form"] {
        padding-top: 14px;
        padding-bottom: 14px;
    }

        /* reduce section spacing */
        .card[aria-label="Add New Item Form"] .section-label {
            margin: 12px 0 6px;
            padding-bottom: 6px;
        }

        /* tighten grids */
        .card[aria-label="Add New Item Form"] .basic-grid,
        .card[aria-label="Add New Item Form"] .form-grid-2,
        .card[aria-label="Add New Item Form"] .form-grid-3 {
            row-gap: 6px; /* was 10–12px */
        }

        /* tighten each field block */
        .card[aria-label="Add New Item Form"] .field {
            margin-bottom: 6px; /* was ~12px */
        }

            /* labels closer to inputs */
            .card[aria-label="Add New Item Form"] .field label {
                margin-bottom: 4px;
            }

        /* error text closer */
        .card[aria-label="Add New Item Form"] .text-danger {
            margin-top: 2px;
        }

        /* description → category gap */
        .card[aria-label="Add New Item Form"] .field.span-2 {
            margin-bottom: 2px;
        }

        /* barcode help box tighter */
        .card[aria-label="Add New Item Form"] .help-box {
            margin-top: 4px;
            padding: 8px 12px;
        }

        /* buttons row tighter */
        .card[aria-label="Add New Item Form"] .btn-row {
            margin-top: 10px;
            padding-top: 8px;
        }

    .soft-divider {
        height: 1px;
        background: #ededed;
        margin: 10px 0; /* tighter */
    }

    /* ===== Compact mode (right form tighter) ===== */
    .card[aria-label="Add New Item Form"] .field {
        margin-bottom: 8px; /* was 12px+ */
    }

        .card[aria-label="Add New Item Form"] .field label {
            margin: 0 0 4px; /* tighter label spacing */
            font-size: 13px;
        }

    .card[aria-label="Add New Item Form"] .form-grid-2,
    .card[aria-label="Add New Item Form"] .form-grid-3,
    .card[aria-label="Add New Item Form"] .basic-grid {
        gap: 10px 14px; /* tighter row/col gap */
    }

    .card[aria-label="Add New Item Form"] textarea {
        min-height: 78px; /* shorter description box */
    }

    /* ===== UOM focus behavior (match Category/Supplier) ===== */


    /* focus = light shadow, keep grey border */
    .dd-uom .dd-input:focus {
        border-color: #dedede !important;
        box-shadow: 0 12px 26px rgba(0,0,0,0.06) !important;
        border: 2px solid #000 !important;
    }


    /* error state */
    .dd-uom.error .dd-input {
        border: 2px solid #dc2626 !important;
        box-shadow: none !important;
    }

    /* ===== UOM visual states ===== */

    /* DEFAULT */
    .dd-uom .dd-input {
        border: 2px solid #dedede !important;
        box-shadow: none !important;
    }

        /* FOCUS */
        .dd-uom .dd-input:focus {
            border-color: #000 !important;
            box-shadow: none !important;
        }

    /* ERROR */
    .dd-uom.error .dd-input {
        border: 2px solid #dc2626 !important;
        box-shadow: none !important;
    }

        /* ERROR + FOCUS */
        .dd-uom.error .dd-input:focus {
            border: 2px solid #dc2626 !important;
            box-shadow: 0 0 0 4px rgba(220,38,38,0.15) !important;
        }

    /* ===== Category/Supplier visual states (default/focus/error) ===== */

    /* DEFAULT */
    .dd:not(.dd-uom) .dd-btn {
        border: 2px solid #dedede !important;
        box-shadow: none !important;
    }

    /* FOCUS / OPEN (like your current dropdown style) */
    .dd:not(.dd-uom).open .dd-btn {
        border-color: #000 !important;
        box-shadow: 0 12px 26px rgba(0,0,0,0.06) !important;
    }

    /* ERROR (only when we add .error after submit) */
    .dd:not(.dd-uom).error .dd-btn {
        border: 2px solid #dc2626 !important;
        box-shadow: none !important;
    }

    /* ERROR + OPEN (keep red, optional soft red ring) */
    .dd:not(.dd-uom).error.open .dd-btn {
        border: 2px solid #dc2626 !important;
        box-shadow: 0 0 0 4px rgba(220,38,38,0.10) !important;
    }

    .card-title {
        margin-top: 20px;
        margin-bottom: 20px;
    }

</style>

<div class="page-wrap">
    <form asp-action="CreateItem"
          method="post"
          enctype="multipart/form-data"
          class="two-card"
          id="itemForm"
          novalidate>


        @Html.AntiForgeryToken()

        <!-- LEFT CARD -->
        <section class="card card-photo" aria-label="Item Photo">

            <h2 class="card-title">Item Photo</h2>


            <div class="photo-circle" id="photoCircle" tabindex="0" role="button" aria-label="Edit item photo">
                <img id="previewImage" alt="Preview" style="display:none;" />
                <div class="placeholder preview-text" id="previewPlaceholder">Preview</div>
            </div>

            <!-- ✅ store the edited image (optional but recommended) -->
            <input type="hidden" id="EditedImageData" name="EditedImageData" />

            <input type="file"
                   id="ItemImageInput"
                   name="ImageFile"
                   accept="image/*"
                   hidden />



            <div class="dropzone" id="dropzone" role="button" tabindex="0" aria-label="Upload image">
                <div class="icon">↑</div>
                <div class="hint">Drag & drop an image here</div>
                <div class="choose-text">Choose File</div>
                <small>JPG / PNG / GIF — up to 2MB</small>
            </div>

            <!-- optional: keep a bottom button like sample -->
            <button type="button" class="primary-btn" onclick="document.getElementById('ItemImageInput').click();">
                Choose Image
            </button>
        </section>

        <!-- RIGHT CARD -->
        <section class="card" aria-label="Add New Item Form">
            <h2 class="card-title">Add New Item</h2>
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>


            <div class="basic-grid">

                <!-- Item Name (LEFT) -->
                <div class="field">
                    <label>Item Name <span class="req">*</span></label>
                    <input asp-for="Item.ItemName" />
                    <span asp-validation-for="Item.ItemName" class="text-danger"></span>
                </div>

                <!-- Unit of Measure (RIGHT) -->
                <div class="field">
                    <label>Unit of Measure <span class="req">*</span></label>

                    <div class="dd dd-uom" data-name="Item.ItemUnitOfMeasure">
                        <input asp-for="Item.ItemUnitOfMeasure" type="hidden" id="uomHidden" />

                        <div class="dd-head">
                            <input type="text"
                                   id="uomInput"
                                   class="dd-input"
                                   placeholder="Select or Type"
                                   autocomplete="off" />
                            <span class="dd-arrow" id="uomArrow"></span>

                        </div>

                        <div class="dd-menu">
                            <div class="dd-items">
                                <div class="dd-item" data-value="pcs">pcs</div>
                                <div class="dd-item" data-value="unit">unit</div>
                                <div class="dd-item" data-value="box">box</div>
                                <div class="dd-item" data-value="kg">kg</div>
                                <div class="dd-item" data-value="g">g</div>
                                <div class="dd-item" data-value="l">l</div>
                                <div class="dd-item" data-value="ml">ml</div>
                            </div>
                        </div>
                    </div>

                    <span asp-validation-for="Item.ItemUnitOfMeasure" class="text-danger"></span>
                </div>

                <!-- Description (FULL WIDTH BELOW) -->
                <div class="field span-2">
                    <label>Description</label>
                    <textarea asp-for="Item.ItemDescription"
                              rows="3"
                              maxlength="500"
                              placeholder="Optional — notes about packaging, grade, usage, etc."></textarea>

                    <small class="char-hint">
                        <span id="descCount">0</span>/500
                    </small>

                    <span asp-validation-for="Item.ItemDescription" class="text-danger"></span>
                </div>

            </div>


            <div class="form-grid-2">
                <!-- CATEGORY -->
                <div class="field">
                    <label>Category <span class="req">*</span></label>

                    <div class="dd" data-name="Item.CategoryID">
                        <input type="hidden" name="Item.CategoryID" value="@Model.Item?.CategoryID" />

                        <div class="dd-head">
                            <button type="button" class="dd-btn">
                                <span class="dd-value dd-placeholder">Select Category</span>
                                <span class="dd-arrow" aria-hidden="true"></span>
                            </button>

                            <button type="button"
                                    class="dd-action dd-add"
                                    title="New Category"
                                    aria-label="New Category"
                                    data-new-url="@Url.Action("Create", "Category")">
                                ＋
                            </button>

                            <button type="button"
                                    class="dd-action dd-refresh-btn"
                                    title="Refresh categories"
                                    aria-label="Refresh categories"
                                    data-refresh-url="@Url.Action("ListJson", "Category")">
                                ⟳
                            </button>
                        </div>

                        <div class="dd-menu" role="listbox">
                            <input type="text" class="dd-search" placeholder="Search..." autocomplete="off" />
                            <div class="dd-items">
                                @foreach (var c in Model.Categories)
                                {
                                    <div class="dd-item" data-value="@c.CategoryID">@c.CategoryName</div>
                                }
                            </div>
                        </div>
                    </div>

                    <span asp-validation-for="Item.CategoryID" class="text-danger"></span>
                </div>

                <!-- SUPPLIER -->
                <div class="field">
                    <label>Supplier <span class="req">*</span></label>

                    <div class="dd" data-name="Item.SupplierID" data-type="supplier">
                        <input type="hidden" name="Item.SupplierID" value="@Model.Item?.SupplierID" />

                        <div class="dd-head">
                            <button type="button" class="dd-btn" aria-haspopup="listbox">
                                <span class="dd-value dd-placeholder">Select Supplier</span>
                                <span class="dd-arrow" aria-hidden="true"></span>
                            </button>

                            <button type="button"
                                    class="dd-action dd-add"
                                    title="New Supplier"
                                    aria-label="New Supplier"
                                    data-new-url="@Url.Action("Create", "Supplier")">
                                ＋
                            </button>

                            <button type="button"
                                    class="dd-action dd-refresh-btn"
                                    title="Refresh suppliers"
                                    aria-label="Refresh suppliers"
                                    data-refresh-url="@Url.Action("ListJson", "Supplier")">
                                ⟳
                            </button>
                        </div>

                        <div class="dd-menu" role="listbox">
                            <input type="text" class="dd-search" placeholder="Search..." autocomplete="off" />
                            <div class="dd-items">
                                @foreach (var s in Model.Suppliers)
                                {
                                    <div class="dd-item" data-value="@s.SupplierID">@s.SupplierName</div>
                                }
                            </div>
                        </div>
                    </div>

                    <span asp-validation-for="Item.SupplierID" class="text-danger"></span>
                </div>
            </div>


            <div class="field">
                <label>Barcode</label>
                <div class="help-box">
                    <span class="bw-icon" aria-hidden="true">🔒</span>
                    Barcode will be automatically generated after saving the item.
                </div>
            </div>

            <div class="soft-divider"></div>
            <div class="form-grid-2">
                <div class="field">
                    <label>
                        Buy Price <span class="req">*</span>
                        <span class="label-unit">(RM)</span>
                    </label>

                    <input asp-for="Item.ItemBuyPrice"
                           class="money num-dec auto-clear"
                           type="text"
                           inputmode="decimal"
                           placeholder="0.00" />

                    <span asp-validation-for="Item.ItemBuyPrice" class="text-danger"></span>
                </div>

                <div class="field">
                    <label>
                        Sell Price <span class="req">*</span>
                        <span class="label-unit">(RM)</span>
                    </label>

                    <input asp-for="Item.ItemSellPrice"
                           class="money num-dec auto-clear"
                           type="text"
                           inputmode="decimal"
                           placeholder="0.00" />

                    <span asp-validation-for="Item.ItemSellPrice" class="text-danger"></span>
                </div>
            </div>

            <div class="soft-divider"></div>
            <div class="form-grid-3">
                <div class="field">
                    <label>Reorder Level <span class="req">*</span></label>
                    <input asp-for="Item.ItemReorderLevel" class="auto-clear num-int"
                           type="number" step="1" min="0" inputmode="numeric" />
                    <span asp-validation-for="Item.ItemReorderLevel" class="text-danger"></span>
                </div>

                <div class="field">
                    <label>Safety Stock <span class="req">*</span></label>
                    <input asp-for="Item.SafetyStock" class="auto-clear num-int"
                           type="number" step="1" min="0" inputmode="numeric" />
                    <span asp-validation-for="Item.SafetyStock" class="text-danger"></span>
                </div>

                <div class="field">
                    <label>Reorder Point <span class="req">*</span></label>
                    <input asp-for="Item.ReorderPoint" class="auto-clear num-int"
                           type="number" step="1" min="0" inputmode="numeric" />
                    <span asp-validation-for="Item.ReorderPoint" class="text-danger"></span>
                </div>
            </div>

            <div class="field">
                <label>Average Daily Demand</label>
                <input asp-for="Item.AverageDailyDemand" class="auto-clear money num-dec"
                       type="number" step="0.01" min="0" inputmode="decimal" />
                <span asp-validation-for="Item.AverageDailyDemand" class="text-danger"></span>
            </div>

            <div class="btn-row">
                <button type="submit" class="primary-btn" id="saveBtn" name="submitAction" value="save">
                    <span class="btn-text">Save Item</span>
                    <span class="btn-spinner" aria-hidden="true"></span>
                </button>

                <button type="submit" class="primary-btn secondary" id="saveNewBtn" name="submitAction" value="saveNew">
                    <span class="btn-text">Save & New</span>
                    <span class="btn-spinner" aria-hidden="true"></span>
                </button>
            </div>



            <div class="back-link">
                <a asp-action="Index" asp-controller="Item">← Back</a>
            </div>
        </section>
    </form>

    <!-- ================= IMAGE EDITOR (ITEM) ================= -->
    <div id="editorModal" class="editor hidden" aria-hidden="true">
        <div class="editor-box" role="dialog" aria-modal="true" aria-label="Image editor">
            <button type="button" class="editor-close" id="editorClose" aria-label="Close editor">✕</button>

            <div class="editor-canvasWrap">
                <canvas id="editorCanvas" width="340" height="340"></canvas>
            </div>

            <div class="editor-controls">
                <div class="editor-zoom">
                    <span class="zoom-label">Zoom</span>
                    <input type="range" id="zoom" min="0.6" max="3" step="0.01" value="1">
                </div>

                <div class="editor-actions">
                    <button type="button" class="btn solid use-btn" id="useImage">Confirm</button>

                    <div class="rotate-row">
                        <button type="button" class="btn icon" id="rotateLeft" aria-label="Rotate left">⟲</button>
                        <button type="button" class="btn icon" id="rotateRight" aria-label="Rotate right">⟳</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
                const fileInput = document.getElementById('ItemImageInput');
                const img = document.getElementById('previewImage');
                const placeholder = document.getElementById('previewPlaceholder');
                const circle = document.getElementById('photoCircle');
                const editedHidden = document.getElementById('EditedImageData');

                const editorModal = document.getElementById('editorModal');
                const editorClose = document.getElementById('editorClose');
                const canvas = document.getElementById('editorCanvas');
                const ctx = canvas.getContext('2d');

                const zoomSlider = document.getElementById('zoom');
                const rotateLeft = document.getElementById('rotateLeft');
                const rotateRight = document.getElementById('rotateRight');
                const useImage = document.getElementById('useImage');

                let baseImg = new Image();
                let angle = 0;
                let zoomValue = 1;

                // pan
                let offsetX = 0, offsetY = 0;
                let isDragging = false;
                let dragStartX = 0, dragStartY = 0;
                let startOffsetX = 0, startOffsetY = 0;
                        const dropzone = document.getElementById("dropzone");

                function openPicker() {
                    if (!fileInput) return;
                    fileInput.value = ""; // allow re-selecting same file
                    fileInput.click();
                }

                // ✅ Dropzone click opens file chooser
                dropzone.addEventListener("click", openPicker);
                dropzone.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        openPicker();
                    }
                });

                        // ===== Drag & Drop FIX (prevent browser opening the image) =====
                (function () {
                    const dropzone = document.getElementById("dropzone");
                    const fileInput = document.getElementById("ItemImageInput");

                    if (!dropzone || !fileInput) return;

                    // ✅ stop browser from opening dropped file anywhere
                    ["dragenter", "dragover", "dragleave", "drop"].forEach(evt => {
                        dropzone.addEventListener(evt, (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });

                        document.addEventListener(evt, (e) => {
                            e.preventDefault();
                        });
                    });

                    // optional nice hover UI
                    dropzone.addEventListener("dragover", () => dropzone.classList.add("is-dragover"));
                    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("is-dragover"));
                    dropzone.addEventListener("drop", (e) => {
                        dropzone.classList.remove("is-dragover");

                        const files = e.dataTransfer?.files;
                        if (!files || !files.length) return;

                        const f = files[0];

                        // ✅ only accept images
                        if (!f.type.startsWith("image/")) {
                            alert("Please drop an image file.");
                            return;
                        }

                        // ✅ put file into input so your existing change handler works
                        fileInput.files = files;

                        // trigger your existing: fileInput.addEventListener('change', ...)
                        fileInput.dispatchEvent(new Event("change", { bubbles: true }));
                    });
                })();


                function openEditor(src){
                    editorModal.classList.remove('hidden');
                    editorModal.setAttribute('aria-hidden', 'false');

                    // reset
                    angle = 0;
                    zoomValue = 1;
                    zoomSlider.value = 1;

                    updateZoomTrack(); // ✅ add this

                    offsetX = 0;
                    offsetY = 0;

                    baseImg.onload = () => draw();
                    baseImg.src = "";
                    baseImg.src = src;
                }

                function closeEditor(){
                    editorModal.classList.add('hidden');
                    editorModal.setAttribute('aria-hidden', 'true');
                }

                editorClose.addEventListener('click', closeEditor);
                editorModal.addEventListener('click', (e)=>{ if(e.target === editorModal) closeEditor(); });
                document.addEventListener('keydown', (e)=>{ if(e.key === "Escape" && !editorModal.classList.contains('hidden')) closeEditor(); });

                function draw() {
                    const W = canvas.width, H = canvas.height;
                    const cx = W / 2, cy = H / 2;

                    ctx.clearRect(0, 0, W, H);
                    ctx.fillStyle = "#f4f5f7";
                    ctx.fillRect(0, 0, W, H);

                    ctx.save();

                    // ✅ square clip
                    ctx.beginPath();
                    ctx.rect(0, 0, W, H);
                    ctx.closePath();
                    ctx.clip();

                    ctx.translate(cx + offsetX, cy + offsetY);
                    ctx.rotate(angle * Math.PI / 180);

                    // ✅ only declare coverScale ONCE
                    const coverScale = Math.max(W / baseImg.width, H / baseImg.height);
                    const finalScale = coverScale * zoomValue;

                    const dw = baseImg.width * finalScale;
                    const dh = baseImg.height * finalScale;

                    ctx.drawImage(baseImg, -dw / 2, -dh / 2, dw, dh);

                    ctx.restore();
                }


                // Upload -> open editor
                fileInput.addEventListener('change', () => {
                    const f = fileInput.files?.[0];
                    if(!f) return;

                    const reader = new FileReader();
                    reader.onload = e => openEditor(e.target.result);
                    reader.readAsDataURL(f);
                });

                // Click circle -> reopen editor with edited image (or current image)
                function openFromCircle(){
                    const current = editedHidden?.value || img?.src;
                    if(current){
                        openEditor(current);
                    }else{
                        fileInput.value = "";
                        fileInput.click();
                    }
                }

                // =============================
                // CLICK SQUARE → OPEN EDITOR
                // =============================
                circle.addEventListener('click', () => {

                    // 1️⃣ If edited image exists → open editor
                    if (editedHidden && editedHidden.value) {
                        openEditor(editedHidden.value);
                        return;
                    }

                    // 2️⃣ If preview image exists → open editor
                    if (img && img.style.display !== "none" && img.src) {
                        openEditor(img.src);
                        return;
                    }

                    // 3️⃣ Otherwise → open file picker
                    fileInput.value = "";
                    fileInput.click();
                });

                // =============================
                // KEYBOARD SUPPORT (ACCESSIBLE)
                // =============================
                circle.addEventListener('keydown', (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        circle.click();
                    }
                });

                // Zoom
                zoomSlider.addEventListener('input', (e)=>{
                    zoomValue = parseFloat(e.target.value);
                    draw();
                });

                function updateZoomTrack() {
                    const min = parseFloat(zoomSlider.min);
                    const max = parseFloat(zoomSlider.max);
                    const val = parseFloat(zoomSlider.value);
                    const percent = ((val - min) / (max - min)) * 100;

                    zoomSlider.style.setProperty('--value', percent + '%');
                }

                updateZoomTrack();
                zoomSlider.addEventListener('input', updateZoomTrack);



                // Rotate
                rotateLeft.addEventListener('click', ()=>{ angle -= 90; draw(); });
                rotateRight.addEventListener('click', ()=>{ angle += 90; draw(); });

                // Drag to pan
                canvas.addEventListener('mousedown', (e)=>{
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    startOffsetX = offsetX;
                    startOffsetY = offsetY;
                    canvas.style.cursor = "grabbing";
                });

                window.addEventListener('mousemove', (e)=>{
                    if(!isDragging) return;
                    offsetX = startOffsetX + (e.clientX - dragStartX);
                    offsetY = startOffsetY + (e.clientY - dragStartY);
                    draw();
                });

                window.addEventListener('mouseup', ()=>{
                    isDragging = false;
                    canvas.style.cursor = "grab";
                });

                canvas.style.cursor = "grab";

        useImage.addEventListener('click', ()=>{
          const data = canvas.toDataURL("image/png");

          img.src = data;
          img.style.display = "block";
          placeholder.style.display = "none";
          if(editedHidden) editedHidden.value = data;

          zoomSlider.value = 1;
          zoomValue = 1;
          updateZoomTrack(); // ✅ keep consistent

          closeEditor();
        });

                // ===== Custom dropdown logic (with search + keyboard + add/refresh) =====
                (function () {

                    function closeAll(except) {
                        document.querySelectorAll(".dd.open").forEach(x => {
                            if (x !== except) x.classList.remove("open");
                        });
                    }

                function setActive(items, index) {
                    items.forEach(x => x.classList.remove("kb-active"));
                    if (index >= 0 && items[index]) items[index].classList.add("kb-active");
                }


                    function getVisibleItems(dd) {
                        return Array.from(dd.querySelectorAll(".dd-items .dd-item"))
                            .filter(x => !x.classList.contains("hidden"));
                    }

                    function filterItems(dd, term) {
                        const t = (term || "").trim().toLowerCase();
                        dd.querySelectorAll(".dd-items .dd-item").forEach(item => {
                            const txt = item.textContent.trim().toLowerCase();
                            item.classList.toggle("hidden", t && !txt.includes(t));
                        });

                const visible = getVisibleItems(dd);
                setActive(visible, -1); // ✅ no default highlight

                    }

                    document.addEventListener("click", (e) => {
                        const dd = e.target.closest(".dd");
                        const btn = e.target.closest(".dd-btn");
                        const item = e.target.closest(".dd-item");

                        // click outside
                        if (!dd) {
                            closeAll(null);
                            return;
                        }

                        // ✅ OPEN/CLOSE by clicking the main field
                        if (btn) {
                            const isOpen = dd.classList.contains("open");
                            closeAll(dd);
                            dd.classList.toggle("open", !isOpen);

                            if (!isOpen) {
                                const search = dd.querySelector(".dd-search");
                                if (search) {
                                    search.value = "";
                                    filterItems(dd, "");
                                    setTimeout(() => search.focus(), 0);
                                }
                            }
                            return;
                        }

                        // ✅ TOP + button
                        const addBtn = e.target.closest(".dd-add");
                        if (addBtn) {
                            e.preventDefault();
                            e.stopPropagation();
                            const url = addBtn.getAttribute("data-new-url");
                            if (url) window.open(url, "_blank");
                            return;
                        }

                        // ✅ TOP refresh button
                        const refreshBtn = e.target.closest(".dd-refresh-btn");
                        if (refreshBtn) {
                            e.preventDefault();
                            e.stopPropagation();
                            const refreshUrl = refreshBtn.getAttribute("data-refresh-url");
                            refreshDd(dd, refreshUrl);
                            return;
                        }

                        // ✅ Menu: New...
                        if (item && item.classList.contains("dd-new")) {
                            e.preventDefault();
                            e.stopPropagation();
                            const url = item.getAttribute("data-new-url");
                            if (url) window.open(url, "_blank");
                            dd.classList.remove("open");
                            return;
                        }

                        // ✅ Menu: Refresh list
                        if (item && item.classList.contains("dd-refresh")) {
                            e.preventDefault();
                            e.stopPropagation();
                            const refreshUrl = item.getAttribute("data-refresh-url");
                            refreshDd(dd, refreshUrl);
                            return;
                        }

                        // ✅ choose item
                        if (item && item.hasAttribute("data-value")) {
                            const value = item.getAttribute("data-value");
                            const text = item.textContent.trim();

                            const hidden = dd.querySelector('input[type="hidden"]');
                            const valueSpan = dd.querySelector(".dd-value");

                            if (hidden) hidden.value = value;
                            if (valueSpan) {
                                valueSpan.textContent = text;
                                valueSpan.classList.remove("dd-placeholder");
                            }

                            dd.querySelectorAll(".dd-items .dd-item").forEach(x => x.classList.remove("active"));
                            item.classList.add("active");

                            dd.classList.remove("open");
                            return;
                        }
                    });

                    // init selected values + search/keyboard
                    document.querySelectorAll(".dd").forEach(dd => {
                        const hidden = dd.querySelector('input[type="hidden"]');
                        const value = hidden?.value;

                        if (value) {
                            const match = dd.querySelector(`.dd-items .dd-item[data-value="${CSS.escape(value)}"]`);
                            if (match) match.click();
                        }

                        const search = dd.querySelector(".dd-search");
                        if (search) {
                            search.addEventListener("input", () => filterItems(dd, search.value));

                            search.addEventListener("keydown", (e) => {
                                const visible = getVisibleItems(dd);
                                if (!visible.length) return;

                let idx = visible.findIndex(x => x.classList.contains("kb-active"));
                if (idx < 0) idx = -1; // ✅ start with none


                                if (e.key === "ArrowDown") {
                                    e.preventDefault();
                                    idx = Math.min(idx + 1, visible.length - 1);
                                    setActive(visible, idx);
                                    visible[idx].scrollIntoView({ block: "nearest" });
                                }

                                if (e.key === "ArrowUp") {
                                    e.preventDefault();
                                    idx = Math.max(idx - 1, 0);
                                    setActive(visible, idx);
                                    visible[idx].scrollIntoView({ block: "nearest" });
                                }

                if (e.key === "Enter") {
                    e.preventDefault();
                    const pick = (idx >= 0 ? idx : 0);
                    visible[pick]?.click();
                }

                                if (e.key === "Escape") {
                                    dd.classList.remove("open");
                                    dd.querySelector(".dd-btn")?.focus();
                                }
                            });
                        }
                    });

                    // ESC closes all
                    document.addEventListener("keydown", (e) => {
                        if (e.key === "Escape") closeAll(null);
                    });

                })();
                        // ===== Category + Supplier validation state (default grey, focus black, error red after submit) =====
                (function () {
                  const form = document.getElementById("itemForm");
                  if (!form) return;

                  let submitted = false;

                  function setDdError(dd, isError) {
                    if (!dd) return;
                    dd.classList.toggle("error", !!isError);
                  }

                  function syncDd(ddSelector) {
                    const dd = document.querySelector(ddSelector);
                    if (!dd) return;

                    const hidden = dd.querySelector('input[type="hidden"]');

                    // IMPORTANT: get the correct validation span for that field
                    const name = dd.getAttribute("data-name"); // "Item.CategoryID" / "Item.SupplierID"
                    const span = name ? document.querySelector(`[data-valmsg-for="${name}"]`) : null;

                    const hasErrorText = span && span.textContent.trim().length > 0;
                    const hasValue = hidden && hidden.value.trim().length > 0;

                    // ✅ error ONLY after submit
                    setDdError(dd, submitted && (!hasValue || hasErrorText));
                  }

                  function syncAll() {
                    syncDd('.dd[data-name="Item.CategoryID"]');
                    syncDd('.dd[data-name="Item.SupplierID"]');
                  }

                  // initial: clean (grey)
                  syncAll();

                  // mark submitted, then sync
                  form.addEventListener("submit", () => {
                    submitted = true;
                    setTimeout(syncAll, 0);
                  });

                  // whenever user selects items / closes menu
                  document.addEventListener("click", (e) => {
                    if (e.target.closest('.dd[data-name="Item.CategoryID"], .dd[data-name="Item.SupplierID"]')) {
                      setTimeout(syncAll, 0);
                    }
                  });

                  // watch validation span changes (jQuery updates these dynamically)
                  ["Item.CategoryID", "Item.SupplierID"].forEach(name => {
                    const span = document.querySelector(`[data-valmsg-for="${name}"]`);
                    if (!span) return;
                    new MutationObserver(syncAll).observe(span, { childList: true, subtree: true, characterData: true });
                  });
                })();

                // ===== UOM validation state (correct UX) =====
                (function () {
                  const form = document.getElementById("itemForm");
                  const dd = document.querySelector('.dd.dd-uom[data-name="Item.ItemUnitOfMeasure"]');
                  if (!form || !dd) return;

                  const hidden = dd.querySelector('input[type="hidden"]');
                  const errorSpan = dd.closest(".field")?.querySelector("span.text-danger");

                  let submitted = false;

                  function syncUom() {
                    const hasErrorText =
                      errorSpan && errorSpan.textContent.trim().length > 0;

                    const hasValue =
                      hidden && hidden.value.trim().length > 0;

                    // ✅ only show error AFTER submit
                    dd.classList.toggle("error", submitted && (!hasValue || hasErrorText));
                  }

                  // mark submitted
                  form.addEventListener("submit", () => {
                    submitted = true;
                    setTimeout(syncUom, 0);
                  });

                  // user interaction clears error
                  dd.addEventListener("click", syncUom);
                  dd.addEventListener("input", syncUom);
                  dd.addEventListener("change", syncUom);

                  // observe validation span
                  if (errorSpan) {
                    new MutationObserver(syncUom)
                      .observe(errorSpan, { childList: true, subtree: true });
                  }

                  // initial = clean (grey)
                  syncUom();
                })();



                // ===== Save buttons: show "Saving..." ONLY when valid =====
                (function () {
                  const form = document.getElementById("itemForm");
                  if (!form) return;

                  let clickedBtn = null;

                  // track which submit button was clicked
                  form.querySelectorAll('button[type="submit"]').forEach(btn => {
                    btn.addEventListener("click", () => clickedBtn = btn);
                  });

                  form.addEventListener("submit", (e) => {
                    // If jQuery validation exists and form is invalid -> stop submit + no loading
                    if (window.jQuery && $(form).data("validator") && !$(form).valid()) {
                      e.preventDefault();
                      return;
                    }

                    // show loading on clicked button
                    const btn = clickedBtn || document.getElementById("saveBtn");
                    if (!btn) return;

                    btn.classList.add("is-loading");
                    const text = btn.querySelector(".btn-text");
                    if (text) text.textContent = "Saving…";

                    // disable both submit buttons to prevent double submit
                    form.querySelectorAll('button[type="submit"]').forEach(b => b.disabled = true);
                  });
                })();




                        // ===== Keyboard: Enter moves to next field (business data-entry style) =====
                (function () {
                    const form = document.getElementById("itemForm");
                    if (!form) return;

                    // Select inputs only (include your dropdown button too)
                const selector = `
                  input:not([type="hidden"]):not([type="file"]),
                  input.dd-input,
                  select,
                  button.dd-btn
                `;


                    function getFocusable() {
                        return Array.from(form.querySelectorAll(selector))
                            .filter(el => !el.disabled && el.offsetParent !== null);
                    }

                    form.addEventListener("keydown", (e) => {
                        if (e.key !== "Enter") return;

                        const tag = (e.target.tagName || "").toLowerCase();
                        const isTextarea = tag === "textarea";
                        if (isTextarea) return;

                        // allow Enter on the Save button (submit)
                        if (e.target.id === "saveBtn") return;

                const dd = e.target.closest(".dd");

                // ✅ If focused on dropdown button and dropdown is CLOSED -> open it
                if (dd && e.target.classList.contains("dd-btn") && !dd.classList.contains("open")) {
                    e.preventDefault();
                    e.target.click();
                    return;
                }

                // ✅ If dropdown is open, let Enter choose item
                if (dd && dd.classList.contains("open")) return;

                        e.preventDefault();

                        const focusables = getFocusable();
                        const idx = focusables.indexOf(e.target);
                        if (idx >= 0) {
                            const next = focusables[idx + 1] || document.getElementById("saveBtn");
                            next?.focus();
                        }
                    });
                })();

                // ===== Numeric UX: auto clear 0 on focus + select all =====
                (function () {
                  document.querySelectorAll(".auto-clear").forEach(el => {
                    el.addEventListener("focus", () => {
                      const v = (el.value || "").trim();

                      // ✅ if value is 0 or 0.00, clear it for faster data entry
                      if (v === "0" || v === "0.0" || v === "0.00") {
                        el.value = "";
                      }

                      // select all (if not cleared)
                      setTimeout(() => { try { el.select(); } catch {} }, 0);
                    });
                  });
                })();


                        // ===== Unsaved changes warning =====
                (function () {
                    const form = document.getElementById("itemForm");
                    if (!form) return;

                    let dirty = false;

                    // any user change marks as dirty
                    form.addEventListener("input", () => dirty = true);
                    form.addEventListener("change", () => dirty = true);

                    // warn when leaving page
                    window.addEventListener("beforeunload", (e) => {
                        if (!dirty) return;
                        e.preventDefault();
                        e.returnValue = "";
                    });

                    // when submit, no warning
                    form.addEventListener("submit", () => dirty = false);
                })();


                // ===== Money: format to 2dp on blur =====
        (function () {
            document.querySelectorAll("input.money").forEach(el => {
                el.addEventListener("blur", () => {
                    let v = (el.value || "").trim();

                    // allow empty
                    if (v === "") return;

                    // remove commas and spaces
                    v = v.replace(/,/g, "");

                    const n = Number(v);
                    if (Number.isFinite(n)) {
                        el.value = n.toFixed(2);
                    }
                });
            });
        })();

                // ===== Hard block letters + sanitize numeric inputs (typing + paste) =====
                (function () {
                    // allow: digits + ONE dot for decimals
                    function sanitizeDecimal(value) {
                        value = (value ?? "").toString();

                        // remove everything except digits and dot
                        value = value.replace(/[^\d.]/g, "");

                        // keep only first dot
                        const parts = value.split(".");
                        if (parts.length > 2) {
                            value = parts[0] + "." + parts.slice(1).join("");
                        }
                        return value;
                    }

                    // allow: digits only
                    function sanitizeInt(value) {
                        value = (value ?? "").toString();
                        return value.replace(/[^\d]/g, "");
                    }

                    // decimals
                    document.querySelectorAll("input.num-dec").forEach(el => {
                        el.addEventListener("input", () => {
                            const cleaned = sanitizeDecimal(el.value);
                            if (el.value !== cleaned) el.value = cleaned;
                        });

                        // also stop typing e/E/+/- (some browsers allow in type=number)
                        el.addEventListener("keydown", (e) => {
                            const bad = ["e", "E", "+", "-"];
                            if (bad.includes(e.key)) e.preventDefault();
                        });
                    });

                    // integers
                    document.querySelectorAll("input.num-int").forEach(el => {
                        el.addEventListener("input", () => {
                            const cleaned = sanitizeInt(el.value);
                            if (el.value !== cleaned) el.value = cleaned;
                        });

                        el.addEventListener("keydown", (e) => {
                            const bad = ["e", "E", "+", "-", "."];
                            if (bad.includes(e.key)) e.preventDefault();
                        });
                    });
                })();

                        // ===== Custom dropdown: show red border when invalid =====
                (function () {
                    const form = document.getElementById("itemForm");
                    if (!form) return;

                    function setDdError(dd, isError) {
                        if (!dd) return;
                        dd.classList.toggle("error", !!isError);
                    }

                    function syncDdByHidden(ddSelector) {
                        const dd = document.querySelector(ddSelector);
                        if (!dd) return;

                        const hidden = dd.querySelector('input[type="hidden"]');
                        const span = dd.closest(".field")?.querySelector("span.text-danger");

                        // rule: if has validation text OR hidden is empty => error
                        const hasSpanError = span && (span.textContent || "").trim().length > 0;
                        const hasValue = hidden && (hidden.value || "").trim().length > 0;

                        setDdError(dd, hasSpanError || !hasValue);
                    }

                    function syncAll() {
                        syncDdByHidden('.dd[data-name="Item.CategoryID"]');
                        syncDdByHidden('.dd[data-name="Item.SupplierID"]');
                    }

                    // initial
                    syncAll();

                    // when user interacts with dropdown (selects item)
                    document.addEventListener("click", (e) => {
                        if (e.target.closest(".dd")) setTimeout(syncAll, 0);
                    });

                    // when typing / changing anything
                    form.addEventListener("change", () => syncAll());
                    form.addEventListener("input", () => syncAll());

                    // when submit (jQuery validation updates messages right before submit)
                    form.addEventListener("submit", () => setTimeout(syncAll, 0));

                    // watch validation spans (jQuery validate updates text dynamically)
                    document.querySelectorAll('.field span.text-danger').forEach(span => {
                        const obs = new MutationObserver(() => syncAll());
                        obs.observe(span, { childList: true, subtree: true, characterData: true });
                    });
                })();


                (function () {
                  const dd = document.querySelector(".dd.dd-uom");
                  if (!dd) return;

                  const input = document.getElementById("uomInput");
                  const arrow = document.getElementById("uomArrow");

                  function open() { dd.classList.add("open"); }
                  function close() { dd.classList.remove("open"); }
                  function toggle() { dd.classList.toggle("open"); }

                  input.addEventListener("focus", open);
                  input.addEventListener("click", toggle);

                  arrow.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggle();
                    input.focus();
                  });

                  dd.querySelectorAll(".dd-item[data-value]").forEach(it => {
                    it.addEventListener("click", () => {
                      input.value = it.getAttribute("data-value");
                      close();

                      // ✅ IMPORTANT: trigger validation update
                      input.dispatchEvent(new Event("change", { bubbles: true }));
                    });
                  });

                  document.addEventListener("click", (e) => {
                    if (!dd.contains(e.target)) close();
                  });
                })();



                        async function refreshDd(dd, refreshUrl) {
                    const itemsWrap = dd.querySelector(".dd-items");
                    if (!itemsWrap || !refreshUrl) return;

                    // keep selected value
                    const hidden = dd.querySelector('input[type="hidden"]');
                    const currentValue = hidden ? hidden.value : "";

                    // loading UI on top button if exists
                    const topBtn = dd.querySelector(".dd-refresh-btn");
                    if (topBtn) { topBtn.disabled = true; topBtn.textContent = "…"; }

                    try {
                        const res = await fetch(refreshUrl, { headers: { "Accept": "application/json" } });
                        if (!res.ok) throw new Error("Refresh failed");

                        const data = await res.json(); // [{id,name}]
                        itemsWrap.innerHTML = "";

                        data.forEach(x => {
                            const div = document.createElement("div");
                            div.className = "dd-item";
                            div.setAttribute("data-value", x.id);
                            div.textContent = x.name;
                            itemsWrap.appendChild(div);
                        });

                        // reselect if still exists
                        if (currentValue) {
                            const match = dd.querySelector(`.dd-items .dd-item[data-value="${CSS.escape(currentValue)}"]`);
                            if (match) match.click();
                        }

                    } catch (err) {
                        console.error(err);
                        alert("Could not refresh list. Please try again.");
                    } finally {
                        if (topBtn) { topBtn.disabled = false; topBtn.textContent = "⟳"; }
                    }
                }

                (function () {
                    const desc = document.querySelector('[name="Item.ItemDescription"]');
                    const counter = document.getElementById("descCount");

                    if (!desc || !counter) return;

                    const paint = () => {
                        const len = desc.value.length;
                        counter.textContent = len;
                        counter.textContent = len;

                        counter.style.color =
                            len > 450 ? "#dc2626" :
                            len > 350 ? "#f59e0b" :
                            "#6b7280";
                    };

                    paint(); // init count
                    desc.addEventListener("input", paint);
                })();



    </script>

}
